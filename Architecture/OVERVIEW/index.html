
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Convert Pydantic models to Django models dynamically">
      
      
      
      
        <link rel="prev" href="../CONTEXT_HANDLING/">
      
      
        <link rel="next" href="../comparisons/README_DJANGO_STORAGE_OPTIONS/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>OVERVIEW - Pydantic2Django</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#architecture-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Pydantic2Django" class="md-header__button md-logo" aria-label="Pydantic2Django" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Pydantic2Django
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              OVERVIEW
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Pydantic2Django

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../CONTEXT_HANDLING/" class="md-tabs__link">
          
  
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bugs/2025-10-01-xml-wrapper-child-fk-direction/" class="md-tabs__link">
          
  
  
  Bugs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../how_it_works/core_modules_and_concepts/" class="md-tabs__link">
          
  
  
  How it works

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../how_to_use/bidirectional_generation/" class="md-tabs__link">
          
  
  
  How to use

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../plans/gfk_generic_entries_plan/" class="md-tabs__link">
          
  
  
  Plans

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/pydantic2django/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Pydantic2Django" class="md-nav__button md-logo" aria-label="Pydantic2Django" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Pydantic2Django
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic2Django
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CONTEXT_HANDLING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Context Handling in Pydantic2Django
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    OVERVIEW
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    OVERVIEW
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture-overview" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#big-picture" class="md-nav__link">
    <span class="md-ellipsis">
      Big picture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      Core responsibilities
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      BaseStaticGenerator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.discover_models" class="md-nav__link">
    <span class="md-ellipsis">
      discover_models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate" class="md-nav__link">
    <span class="md-ellipsis">
      generate
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate_model_definition" class="md-nav__link">
    <span class="md-ellipsis">
      generate_model_definition
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate_models_file" class="md-nav__link">
    <span class="md-ellipsis">
      generate_models_file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.base_generator.BaseStaticGenerator.setup_django_model" class="md-nav__link">
    <span class="md-ellipsis">
      setup_django_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.discovery.BaseDiscovery" class="md-nav__link">
    <span class="md-ellipsis">
      BaseDiscovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.discovery.BaseDiscovery.analyze_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.discovery.BaseDiscovery.discover_models" class="md-nav__link">
    <span class="md-ellipsis">
      discover_models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.discovery.BaseDiscovery.get_models_in_registration_order" class="md-nav__link">
    <span class="md-ellipsis">
      get_models_in_registration_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.BaseModelFactory" class="md-nav__link">
    <span class="md-ellipsis">
      BaseModelFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.BaseModelFactory.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.BaseModelFactory.make_django_model" class="md-nav__link">
    <span class="md-ellipsis">
      make_django_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.BaseFieldFactory" class="md-nav__link">
    <span class="md-ellipsis">
      BaseFieldFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.BaseFieldFactory.create_field" class="md-nav__link">
    <span class="md-ellipsis">
      create_field
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.ConversionCarrier" class="md-nav__link">
    <span class="md-ellipsis">
      ConversionCarrier
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.ConversionCarrier.model_key" class="md-nav__link">
    <span class="md-ellipsis">
      model_key
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.FieldConversionResult" class="md-nav__link">
    <span class="md-ellipsis">
      FieldConversionResult
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.FieldConversionResult.add_import" class="md-nav__link">
    <span class="md-ellipsis">
      add_import
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.factories.FieldConversionResult.add_import_for_obj" class="md-nav__link">
    <span class="md-ellipsis">
      add_import_for_obj
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper" class="md-nav__link">
    <span class="md-ellipsis">
      BidirectionalTypeMapper
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_django_mapping" class="md-nav__link">
    <span class="md-ellipsis">
      get_django_mapping
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_pydantic_mapping" class="md-nav__link">
    <span class="md-ellipsis">
      get_pydantic_mapping
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit" class="md-nav__link">
    <span class="md-ellipsis">
      TypeMappingUnit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit.__init_subclass__" class="md-nav__link">
    <span class="md-ellipsis">
      __init_subclass__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit.django_to_pydantic_field_info_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      django_to_pydantic_field_info_kwargs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit.handle_choices" class="md-nav__link">
    <span class="md-ellipsis">
      handle_choices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit.matches" class="md-nav__link">
    <span class="md-ellipsis">
      matches
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.mapping_units.TypeMappingUnit.pydantic_to_django_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      pydantic_to_django_kwargs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor" class="md-nav__link">
    <span class="md-ellipsis">
      RelationshipConversionAccessor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.available_django_models" class="md-nav__link">
    <span class="md-ellipsis">
      available_django_models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.available_source_models" class="md-nav__link">
    <span class="md-ellipsis">
      available_source_models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_dataclass_model" class="md-nav__link">
    <span class="md-ellipsis">
      add_dataclass_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_django_model" class="md-nav__link">
    <span class="md-ellipsis">
      add_django_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_pydantic_model" class="md-nav__link">
    <span class="md-ellipsis">
      add_pydantic_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.from_dict" class="md-nav__link">
    <span class="md-ellipsis">
      from_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      get_django_model_for_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      get_django_model_for_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_pydantic_model_for_django" class="md-nav__link">
    <span class="md-ellipsis">
      get_pydantic_model_for_django
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_source_model_by_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_source_model_by_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.is_source_model_known" class="md-nav__link">
    <span class="md-ellipsis">
      is_source_model_known
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.map_relationship" class="md-nav__link">
    <span class="md-ellipsis">
      map_relationship
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.to_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipMapper" class="md-nav__link">
    <span class="md-ellipsis">
      RelationshipMapper
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.relationships.RelationshipMapper.source_model" class="md-nav__link">
    <span class="md-ellipsis">
      source_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.typing.TypeHandler" class="md-nav__link">
    <span class="md-ellipsis">
      TypeHandler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.typing.TypeHandler.format_type_string" class="md-nav__link">
    <span class="md-ellipsis">
      format_type_string
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.typing.TypeHandler.get_class_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_class_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.typing.TypeHandler.get_required_imports" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.typing.TypeHandler.process_field_type" class="md-nav__link">
    <span class="md-ellipsis">
      process_field_type
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler" class="md-nav__link">
    <span class="md-ellipsis">
      ImportHandler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.add_context_field_type_import" class="md-nav__link">
    <span class="md-ellipsis">
      add_context_field_type_import
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.add_import" class="md-nav__link">
    <span class="md-ellipsis">
      add_import
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.add_pydantic_model_import" class="md-nav__link">
    <span class="md-ellipsis">
      add_pydantic_model_import
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.deduplicate_imports" class="md-nav__link">
    <span class="md-ellipsis">
      deduplicate_imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.imports.ImportHandler.get_required_imports" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext" class="md-nav__link">
    <span class="md-ellipsis">
      ModelContext
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.add_field" class="md-nav__link">
    <span class="md-ellipsis">
      add_field
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.generate_context_class_code" class="md-nav__link">
    <span class="md-ellipsis">
      generate_context_class_code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.get_field_by_name" class="md-nav__link">
    <span class="md-ellipsis">
      get_field_by_name
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.get_field_type_str" class="md-nav__link">
    <span class="md-ellipsis">
      get_field_type_str
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.get_required_imports" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_imports
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.get_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_value
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.set_value" class="md-nav__link">
    <span class="md-ellipsis">
      set_value
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.to_conversion_dict" class="md-nav__link">
    <span class="md-ellipsis">
      to_conversion_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ModelContext.validate_context" class="md-nav__link">
    <span class="md-ellipsis">
      validate_context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ContextClassGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      ContextClassGenerator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ContextClassGenerator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.context.ContextClassGenerator.generate_context_class" class="md-nav__link">
    <span class="md-ellipsis">
      generate_context_class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.serialization.serialize_value" class="md-nav__link">
    <span class="md-ellipsis">
      serialize_value
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.core.serialization.get_serialization_method" class="md-nav__link">
    <span class="md-ellipsis">
      get_serialization_method
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_serialization_method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-all-implementations-have-in-common" class="md-nav__link">
    <span class="md-ellipsis">
      What all implementations have in common
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementations" class="md-nav__link">
    <span class="md-ellipsis">
      Implementations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.discovery.PydanticDiscovery" class="md-nav__link">
    <span class="md-ellipsis">
      PydanticDiscovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.analyze_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.discover_models" class="md-nav__link">
    <span class="md-ellipsis">
      discover_models
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.get_models_in_registration_order" class="md-nav__link">
    <span class="md-ellipsis">
      get_models_in_registration_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticModelFactory" class="md-nav__link">
    <span class="md-ellipsis">
      PydanticModelFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticModelFactory.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticModelFactory.make_django_model" class="md-nav__link">
    <span class="md-ellipsis">
      make_django_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticFieldFactory" class="md-nav__link">
    <span class="md-ellipsis">
      PydanticFieldFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticFieldFactory.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.factory.PydanticFieldFactory.create_field" class="md-nav__link">
    <span class="md-ellipsis">
      create_field
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.generator.StaticPydanticModelGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      StaticPydanticModelGenerator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.pydantic.generator.StaticPydanticModelGenerator.generate_models_file" class="md-nav__link">
    <span class="md-ellipsis">
      generate_models_file
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_models_file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      Dataclass
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.discovery.DataclassDiscovery" class="md-nav__link">
    <span class="md-ellipsis">
      DataclassDiscovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.discovery.DataclassDiscovery.analyze_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.discovery.DataclassDiscovery.get_models_in_registration_order" class="md-nav__link">
    <span class="md-ellipsis">
      get_models_in_registration_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassModelFactory" class="md-nav__link">
    <span class="md-ellipsis">
      DataclassModelFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassModelFactory.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassModelFactory.make_django_model" class="md-nav__link">
    <span class="md-ellipsis">
      make_django_model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassFieldFactory" class="md-nav__link">
    <span class="md-ellipsis">
      DataclassFieldFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassFieldFactory.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.factory.DataclassFieldFactory.create_field" class="md-nav__link">
    <span class="md-ellipsis">
      create_field
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.generator.DataclassDjangoModelGenerator" class="md-nav__link">
    <span class="md-ellipsis">
      DataclassDjangoModelGenerator
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.dataclass.generator.DataclassDjangoModelGenerator.generate_models_file" class="md-nav__link">
    <span class="md-ellipsis">
      generate_models_file
    </span>
  </a>
  
    <nav class="md-nav" aria-label="generate_models_file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#typedclass-experimental" class="md-nav__link">
    <span class="md-ellipsis">
      TypedClass (experimental)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.typedclass.discovery.TypedClassDiscovery" class="md-nav__link">
    <span class="md-ellipsis">
      TypedClassDiscovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.typedclass.discovery.TypedClassDiscovery.analyze_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.typedclass.discovery.TypedClassDiscovery.get_models_in_registration_order" class="md-nav__link">
    <span class="md-ellipsis">
      get_models_in_registration_order
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.typedclass.factory.TypedClassModelFactory" class="md-nav__link">
    <span class="md-ellipsis">
      TypedClassModelFactory
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.typedclass.factory.TypedClassModelFactory.create_model_definition" class="md-nav__link">
    <span class="md-ellipsis">
      create_model_definition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_model_definition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#django-base-models-runtime-mapping-and-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Django base models (runtime mapping and storage)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic2DjangoBaseClass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.__getattr__" class="md-nav__link">
    <span class="md-ellipsis">
      __getattr__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.__new__" class="md-nav__link">
    <span class="md-ellipsis">
      __new__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.from_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      from_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.save_as_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      save_as_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.to_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      to_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.update_fields_from_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      update_fields_from_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.update_from_pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      update_from_pydantic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass" class="md-nav__link">
    <span class="md-ellipsis">
      Dataclass2DjangoBaseClass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.from_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      from_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.save_as_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      save_as_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.to_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      to_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.update_fields_from_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      update_fields_from_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.update_from_dataclass" class="md-nav__link">
    <span class="md-ellipsis">
      update_from_dataclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass" class="md-nav__link">
    <span class="md-ellipsis">
      TypedClass2DjangoBaseClass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.from_typedclass" class="md-nav__link">
    <span class="md-ellipsis">
      from_typedclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.save_as_typedclass" class="md-nav__link">
    <span class="md-ellipsis">
      save_as_typedclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.to_typedclass" class="md-nav__link">
    <span class="md-ellipsis">
      to_typedclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.update_fields_from_typedclass" class="md-nav__link">
    <span class="md-ellipsis">
      update_fields_from_typedclass
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.update_from_typedclass" class="md-nav__link">
    <span class="md-ellipsis">
      update_from_typedclass
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_from_typedclass">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extending-the-system" class="md-nav__link">
    <span class="md-ellipsis">
      Extending the system
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mkdocstrings-usage" class="md-nav__link">
    <span class="md-ellipsis">
      mkdocstrings usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Comparisons
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Comparisons
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../comparisons/README_DJANGO_STORAGE_OPTIONS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic to Django Storage Approaches
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../comparisons/README_PYDANTIC_DJANGO_METHODS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic to Django Method Integration Approaches
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Bugs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Bugs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bugs/2025-10-01-xml-wrapper-child-fk-direction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    XML Schema wrapper children incorrectly attached as parent-side FKs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How it works
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            How it works
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/core_modules_and_concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core modules and concepts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/generic_entries_contenttypes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generic entries contenttypes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/ingestor_strict_and_contract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingestor strict and contract
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/provider_backend_pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Provider backend pattern
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/readme_bidirectional_mapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic2Django Bidirectional Mapper Details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/readme_context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic2Django Context Storage and Generated Context Classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/readme_ingestion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingestion Pattern Across Modules
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/readme_relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pydantic2Django Relationships Accessor Details
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/timescale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Timescale
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/xmlschema_element_and_type_handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    XML Schema Handling: Elements, Attributes, Types, Relationships
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_it_works/xmlschema_notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    XML Schema Notes: complexType Handling
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    How to use
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            How to use
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_use/bidirectional_generation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bidirectional generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_use/ingestor_validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingestor validation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_use/integrate_into_django_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrate into django app
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how_to_use/parametrized_assert_tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parametrized Single-Assertion Tests for End-to-End Load/Process/Persist
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Plans
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Plans
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plans/gfk_generic_entries_plan/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Provider‑agnostic GenericForeignKey (GFK) plan
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/entrypoint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.entrypoint
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_3" >
        
          
          <label class="md-nav__link" for="__nav_7_1_3" id="__nav_7_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/base_generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.base_generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/bidirectional_mapper/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.bidirectional_mapper
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/defs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.defs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/factories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.factories
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/filter_helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.filter_helpers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/imports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.imports
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/mapping_units/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.mapping_units
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.relationships
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.serialization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/typing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.typing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_3_14" >
        
          
          <label class="md-nav__link" for="__nav_7_1_3_14" id="__nav_7_1_3_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_3_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_3_14">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.core.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/utils/naming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils.naming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/utils/relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils.relationships
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/utils/strings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils.strings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/core/utils/timescale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.core.utils.timescale
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_4" >
        
          
          <label class="md-nav__link" for="__nav_7_1_4" id="__nav_7_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.dataclass
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_4">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.dataclass
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/dataclass/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.dataclass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/dataclass/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.dataclass.discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/dataclass/factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.dataclass.factory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/dataclass/generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.dataclass.generator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_5" >
        
          
          <label class="md-nav__link" for="__nav_7_1_5" id="__nav_7_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.django
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_5">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.django
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/admin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.admin
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/conversion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.conversion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/typing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.typing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_5_6" >
        
          
          <label class="md-nav__link" for="__nav_7_1_5_6" id="__nav_7_1_5_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.django.timescale
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_5_6">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.django.timescale
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/timescale/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.timescale
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/timescale/bases/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.timescale.bases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/timescale/heuristics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.timescale.heuristics
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_5_7" >
        
          
          <label class="md-nav__link" for="__nav_7_1_5_7" id="__nav_7_1_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.django.utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_5_7">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.django.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/utils/naming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.utils.naming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/django/utils/serialization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.django.utils.serialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_6" >
        
          
          <label class="md-nav__link" for="__nav_7_1_6" id="__nav_7_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_6">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.pydantic
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.factory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_6_5" >
        
          
          <label class="md-nav__link" for="__nav_7_1_6_5" id="__nav_7_1_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.utils
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_7_1_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_6_5">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.pydantic.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/pydantic/utils/introspection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.pydantic.utils.introspection
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_7" >
        
          
          <label class="md-nav__link" for="__nav_7_1_7" id="__nav_7_1_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.typedclass
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_7">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.typedclass
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/typedclass/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.typedclass
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/typedclass/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.typedclass.discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/typedclass/factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.typedclass.factory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/typedclass/generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.typedclass.generator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7_1_8" >
        
          
          <label class="md-nav__link" for="__nav_7_1_8" id="__nav_7_1_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_8">
            <span class="md-nav__icon md-icon"></span>
            pydantic2django.xmlschema
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/factory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.factory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/generator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/ingestor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.ingestor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/pydantic2django/xmlschema/parser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pydantic2django.xmlschema.parser
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>OVERVIEW</h1>

<h2 id="architecture-overview">Architecture overview<a class="headerlink" href="#architecture-overview" title="Permanent link">&para;</a></h2>
<p>This document explains how <code>pydantic2django</code> is organized, what the shared core is responsible for, and what each implementation (Pydantic, Dataclass, TypedClass) has in common.</p>
<p>For inlined API links below, we use mkdocstrings’ Python handler syntax; see “mkdocstrings usage” for details. Reference: <a href="https://mkdocstrings.github.io/python/usage/">mkdocstrings usage</a>.</p>
<h3 id="big-picture">Big picture<a class="headerlink" href="#big-picture" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Goal</strong>: Convert typed Python models into Django models and make them interoperable in both directions.</li>
<li><strong>Layers</strong>:</li>
<li><strong>Core</strong>: Shared building blocks (discovery, factories, bidirectional type mapping, typing utils, import aggregation, context handling, code generation base).</li>
<li><strong>Implementations</strong>: Source-specific adapters that plug into the core (Pydantic, Dataclass, TypedClass).</li>
<li><strong>Django base models</strong>: Ready-to-extend base classes that store or map typed objects inside Django models.</li>
</ul>
<p>High-level flow (static code generation path):</p>
<ol>
<li>Discover source models in Python packages.</li>
<li>For each model, convert its fields to Django fields via the bidirectional type mapper.</li>
<li>Create an in-memory Django model class and collect rendered definitions using Jinja templates.</li>
<li>Write a <code>models.py</code> file including imports, model classes, and optional context classes.</li>
</ol>
<p>Templates live in <code>src/pydantic2django/django/templates</code> and are used by the generator base.</p>
<h3 id="core-responsibilities">Core responsibilities<a class="headerlink" href="#core-responsibilities" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Static generation orchestration</strong></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.base_generator.BaseStaticGenerator"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>, <span title="pydantic2django.core.base_generator.FieldInfoType">FieldInfoType</span>]</code></p>


        <p>Abstract base class for generating static Django models from source models (like Pydantic or Dataclasses).</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseStaticGenerator</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">,</span> <span class="n">FieldInfoType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for generating static Django models from source models (like Pydantic or Dataclasses).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filter_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">discovery_instance</span><span class="p">:</span> <span class="n">BaseDiscovery</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">],</span>
        <span class="n">model_factory_instance</span><span class="p">:</span> <span class="n">BaseModelFactory</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">,</span> <span class="n">FieldInfoType</span><span class="p">],</span>
        <span class="n">module_mappings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">],</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">class_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Django&quot;</span><span class="p">,</span>
        <span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># --- GFK flags ---</span>
        <span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;all_nested&quot;</span><span class="p">,</span>
        <span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">,</span>
        <span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the base generator.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_path: Path to output the generated models.py file.</span>
<span class="sd">            packages: List of packages to scan for source models.</span>
<span class="sd">            app_label: Django app label to use for the models.</span>
<span class="sd">            filter_function: Optional function to filter which source models to include.</span>
<span class="sd">            verbose: Print verbose output.</span>
<span class="sd">            discovery_instance: An instance of a BaseDiscovery subclass.</span>
<span class="sd">            model_factory_instance: An instance of a BaseModelFactory subclass.</span>
<span class="sd">            module_mappings: Optional mapping of modules to remap imports.</span>
<span class="sd">            base_model_class: The base Django model class to inherit from.</span>
<span class="sd">            class_name_prefix: Prefix for generated Django model class names.</span>
<span class="sd">            enable_timescale: Whether to enable TimescaleDB support for hypertables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span> <span class="o">=</span> <span class="n">app_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span> <span class="o">=</span> <span class="n">filter_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span> <span class="o">=</span> <span class="n">discovery_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span> <span class="o">=</span> <span class="n">model_factory_instance</span>
        <span class="c1"># Base model class must be provided explicitly by subclass at call site.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">base_model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_name_prefix</span> <span class="o">=</span> <span class="n">class_name_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Stores results from model factory</span>
        <span class="c1"># Feature flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enable_timescale</span><span class="p">)</span>
        <span class="c1"># GFK feature flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enable_gfk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_policy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_threshold_children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_value_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">gfk_normalize_common_attrs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span> <span class="o">=</span> <span class="n">ImportHandler</span><span class="p">(</span><span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span><span class="p">)</span>

        <span class="c1"># Initialize Jinja2 environment</span>
        <span class="c1"># Look for templates in the django/templates subdirectory</span>
        <span class="c1"># package_templates_dir = os.path.join(os.path.dirname(__file__), &quot;..&quot;, &quot;templates&quot;) # Old path</span>
        <span class="n">package_templates_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>  <span class="c1"># Corrected path</span>

        <span class="c1"># If templates don&#39;t exist in the package, use the ones relative to the execution?</span>
        <span class="c1"># This might need adjustment based on packaging/distribution.</span>
        <span class="c1"># For now, assume templates are relative to the package structure.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">):</span>
            <span class="c1"># Fallback or raise error might be needed</span>
            <span class="n">package_templates_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Templates directory not found at expected location: </span><span class="si">{</span><span class="n">package_templates_dir</span><span class="si">}</span><span class="s2">. Jinja might fail.&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
            <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">),</span>
            <span class="n">trim_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">lstrip_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Register common custom filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;format_type_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span>
        <span class="c1"># Provide an escaping filter for embedding strings safely in generated Python code</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">..core.utils.strings</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_string</span> <span class="k">as</span> <span class="n">_escape_py_str</span>  <span class="c1"># Local import to avoid cycles</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;escape_py_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_escape_py_str</span>
        <span class="c1"># Add more common filters if needed</span>

        <span class="c1"># Add base model import</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>

    <span class="c1"># --- Abstract Methods to be Implemented by Subclasses ---</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_source_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the original source model from the carrier.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_source_model_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the necessary import for the original source model.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_template_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">unique_model_definitions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">django_model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the subclass-specific context for the main models_file.py.j2 template.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_models_in_processing_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return source models in the correct processing (dependency) order.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_model_definition_extra_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide extra context specific to the source type for model_definition.py.j2.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_default_base_model_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the required base Django model class for this generator.</span>

<span class="sd">        Subclasses implement this so they can easily and explicitly resolve</span>
<span class="sd">        the correct base and pass it into the base initializer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># --- Common Methods ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main entry point: Generate and write the models file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The path to the generated models file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_models_file</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_models_file</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully generated models file at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating models file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Use exc_info for traceback</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the generated content to the output file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing models to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created output directory: </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create output directory </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>  <span class="c1"># Re-raise after logging</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Specify encoding</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully wrote models to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write to output file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise after logging</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover source models using the configured discovery instance.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovering models from packages: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Corrected call matching BaseDiscovery signature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">discover_models</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="ow">or</span> <span class="p">[],</span>  <span class="c1"># Pass empty list if None</span>
            <span class="n">app_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">user_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">,</span>  <span class="c1"># Keep as is for now</span>
        <span class="p">)</span>

        <span class="c1"># Analyze dependencies after discovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">analyze_dependencies</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> models after filtering.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (No models found or passed filter)&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dependency analysis complete.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="n">SourceModelType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the model factory to create a Django model representation from a source model.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_model: The source model instance (e.g., Pydantic class, Dataclass).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A ConversionCarrier containing the results, or None if creation failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">source_model</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up Django model for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Instantiate the carrier here</span>
        <span class="n">carrier</span> <span class="o">=</span> <span class="n">ConversionCarrier</span><span class="p">(</span>
            <span class="n">source_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">],</span> <span class="n">source_model</span><span class="p">),</span>
            <span class="n">meta_app_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">base_django_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">,</span>
            <span class="n">class_name_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_name_prefix</span><span class="p">,</span>
            <span class="c1"># Add other defaults/configs if needed, e.g., strict mode</span>
            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Example default</span>
            <span class="c1"># GFK flags</span>
            <span class="n">enable_gfk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_gfk</span><span class="p">,</span>
            <span class="n">gfk_policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_policy</span><span class="p">,</span>
            <span class="n">gfk_threshold_children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_threshold_children</span><span class="p">,</span>
            <span class="n">gfk_value_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_value_mode</span><span class="p">,</span>
            <span class="n">gfk_normalize_common_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_normalize_common_attrs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use the factory to process the source model and populate the carrier</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Pass carrier to factory</span>

            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">carrier</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Log if model creation resulted in None (e.g., only context fields)</span>
                <span class="c1"># Check carrier.context_fields or carrier.invalid_fields for details</span>
                <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped Django model class for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> - only context fields found.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipped Django model class for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> due to invalid fields: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Django model was not generated for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> for unknown reasons.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return None if no Django model was created</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> with factory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a string definition for a single Django model using a template.</span>

<span class="sd">        Args:</span>
<span class="sd">            carrier: The ConversionCarrier containing the generated Django model and context.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The string representation of the Django model definition.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="c1"># It&#39;s possible a carrier exists only for context, handle gracefully.</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping Django model definition for </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> (likely context-only).&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot generate model definition for </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">: django_model is missing in carrier.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">django_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">source_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Get original name via abstract method</span>

        <span class="c1"># --- Prepare Fields ---</span>
        <span class="n">fields_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Combine regular and relationship fields from the carrier</span>
        <span class="n">all_django_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="p">,</span> <span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="n">all_django_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># The field_object is already an instantiated Django field</span>
            <span class="c1"># Add (name, object) tuple directly for the template</span>
            <span class="n">fields_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span><span class="p">))</span>

        <span class="c1"># --- Prepare Meta ---</span>
        <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">):</span>
            <span class="n">model_meta</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span>
            <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;db_table&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;db_table&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">django_model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                <span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;verbose_name&quot;</span><span class="p">,</span> <span class="n">django_model_name</span><span class="p">),</span>
                <span class="s2">&quot;verbose_name_plural&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;verbose_name_plural&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">),</span>
                <span class="c1"># Add other meta options if needed</span>
            <span class="p">}</span>

        <span class="c1"># --- Prepare Base Class Info ---</span>
        <span class="n">base_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
            <span class="c1"># Use the immediate parent if it&#39;s not the absolute base &#39;models.Model&#39;</span>
            <span class="c1"># Assumes single inheritance for the generated model besides the ultimate base</span>
            <span class="n">parent_class</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Check if the parent is our intended base_model_class or something else</span>
            <span class="c1"># This logic might need refinement depending on how complex the inheritance gets</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">parent_class</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parent_class</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
                <span class="n">base_model_name</span> <span class="o">=</span> <span class="n">parent_class</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="c1"># Add import for the parent if it&#39;s not the configured base_model_class</span>
                <span class="k">if</span> <span class="n">parent_class</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">parent_class</span><span class="p">)</span>

        <span class="c1"># --- Get Subclass Specific Context ---</span>
        <span class="n">extra_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_definition_extra_context</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

        <span class="c1"># --- Process Pending Multi-FK Unions and add to definitions dict ---</span>
        <span class="n">multi_fk_field_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Keep track for validation hint</span>
        <span class="n">validation_needed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="p">:</span>
            <span class="n">validation_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">original_field_name</span><span class="p">,</span> <span class="n">union_details</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="p">:</span>
                <span class="n">pydantic_models</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">pydantic_model</span> <span class="ow">in</span> <span class="n">pydantic_models</span><span class="p">:</span>
                    <span class="c1"># Construct field name (e.g., original_name_relatedmodel)</span>
                    <span class="n">fk_field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_field_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">multi_fk_field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_field_name</span><span class="p">)</span>
                    <span class="c1"># Get corresponding Django model</span>
                    <span class="n">pydantic_factory</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticModelFactory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span><span class="p">)</span>
                    <span class="n">django_model_rel</span> <span class="o">=</span> <span class="n">pydantic_factory</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                        <span class="n">pydantic_model</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">django_model_rel</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not find Django model for Pydantic model </span><span class="si">{</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> referenced in multi-FK union for </span><span class="si">{</span><span class="n">original_field_name</span><span class="si">}</span><span class="s2">. Skipping FK field.&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># Use string for model ref in kwargs</span>
                    <span class="n">target_model_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">django_model_rel</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="c1"># Add import for the related Django model</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">django_model_rel</span><span class="p">)</span>

                    <span class="c1"># Define FK kwargs (always null=True, blank=True)</span>
                    <span class="c1"># Use strings for values that need to be represented in code</span>
                    <span class="n">fk_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">target_model_str</span><span class="p">,</span>
                        <span class="s2">&quot;on_delete&quot;</span><span class="p">:</span> <span class="s2">&quot;models.SET_NULL&quot;</span><span class="p">,</span>  <span class="c1"># Use string for template</span>
                        <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;blank&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="c1"># Generate related_name to avoid clashes</span>
                        <span class="s2">&quot;related_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fk_field_name</span><span class="si">}</span><span class="s2">_set&#39;&quot;</span><span class="p">,</span>  <span class="c1"># Ensure related_name is quoted string</span>
                    <span class="p">}</span>
                    <span class="c1"># Generate the definition string</span>
                    <span class="n">fk_def_string</span> <span class="o">=</span> <span class="n">generate_field_definition_string</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">fk_kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">)</span>
                    <span class="c1"># Add to the main definitions dictionary</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span><span class="n">fk_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fk_def_string</span>

        <span class="c1"># --- Prepare Final Context --- #</span>
        <span class="c1"># Ensure the context uses the potentially updated definitions dict from the carrier</span>
        <span class="c1"># Subclass _get_model_definition_extra_context should already provide this</span>
        <span class="c1"># via `field_definitions=carrier.django_field_definitions`</span>
        <span class="n">template_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">django_model_name</span><span class="p">,</span>
            <span class="s2">&quot;pydantic_model_name&quot;</span><span class="p">:</span> <span class="n">source_model_name</span><span class="p">,</span>
            <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="n">base_model_name</span><span class="p">,</span>
            <span class="s2">&quot;is_timescale_model&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_model_name</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;TimescaleBase&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">meta_options</span><span class="p">,</span>
            <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="s2">&quot;multi_fk_field_names&quot;</span><span class="p">:</span> <span class="n">multi_fk_field_names</span><span class="p">,</span>  <span class="c1"># Pass names for validation hint</span>
            <span class="s2">&quot;validation_needed&quot;</span><span class="p">:</span> <span class="n">validation_needed</span><span class="p">,</span>  <span class="c1"># Signal if validation needed</span>
            <span class="c1"># Include extra context from subclass (should include field_definitions)</span>
            <span class="o">**</span><span class="n">extra_context</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># --- Render Template --- #</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;model_definition.py.j2&quot;</span><span class="p">)</span>
        <span class="n">definition_str</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>

        <span class="c1"># Add import for the original source model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_source_model_import</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">definition_str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_deduplicate_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definitions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove duplicate model definitions based on class name.&quot;&quot;&quot;</span>
        <span class="n">unique_definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seen_class_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">definition</span> <span class="ow">in</span> <span class="n">definitions</span><span class="p">:</span>
            <span class="c1"># Basic regex to find &#39;class ClassName(&#39; - might need adjustment for complex cases</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*class\s+(\w+)\(&quot;</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">class_name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">class_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_class_names</span><span class="p">:</span>
                    <span class="n">unique_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
                    <span class="n">seen_class_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
                <span class="c1"># else: logger.debug(f&quot;Skipping duplicate definition for class: {class_name}&quot;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no class definition found (e.g., comments, imports), keep it? Or discard?</span>
                <span class="c1"># For now, keep non-class definitions assuming they might be needed context/comments.</span>
                <span class="n">unique_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not extract class name from definition block for deduplication.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unique_definitions</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_generic_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove generic parameters like [T] or &lt;T&gt; from a type name.&quot;&quot;&quot;</span>
        <span class="c1"># Handles Class[Param] or Class&lt;Param&gt;</span>
        <span class="n">cleaned_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\[&lt;].*?[\]&gt;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Also handle cases like &#39;ModelName.T&#39; if typevars are used this way</span>
        <span class="n">cleaned_name</span> <span class="o">=</span> <span class="n">cleaned_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cleaned_name</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the complete content for the models.py file.</span>
<span class="sd">        This method orchestrates discovery, model setup, definition generation,</span>
<span class="sd">        import collection, and template rendering.</span>
<span class="sd">        Subclasses might override this to add specific steps (like context class generation).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>  <span class="c1"># Populates discovery instance</span>
        <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>  <span class="c1"># Abstract method</span>

        <span class="c1"># Reset state for this run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Re-add base model import after clearing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>

        <span class="n">model_definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">django_model_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For __all__</span>

        <span class="c1"># Setup Django models first (populates self.carriers)</span>
        <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>  <span class="c1"># Calls factory, populates carrier</span>

        <span class="c1"># Generate definitions from carriers</span>
        <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
            <span class="c1"># Generate Django model definition if model exists</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Uses template</span>
                    <span class="k">if</span> <span class="n">model_def</span><span class="p">:</span>  <span class="c1"># Only add if definition was generated</span>
                        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
                        <span class="n">django_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                        <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating definition for source model </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Subclasses might add context class generation here by overriding this method</span>
            <span class="c1"># or by generate_model_definition adding context-related imports.</span>

        <span class="c1"># Deduplicate definitions</span>
        <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>

        <span class="c1"># Deduplicate imports gathered during the process</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>

        <span class="c1"># Prepare context using subclass method (_prepare_template_context)</span>
        <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>

        <span class="c1"># Add common context items</span>
        <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
                <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
                <span class="c1"># Add other common items as needed</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Render the main template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">filter_function</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">discovery_instance</span><span class="p">,</span> <span class="n">model_factory_instance</span><span class="p">,</span> <span class="n">module_mappings</span><span class="p">,</span> <span class="n">base_model_class</span><span class="p">,</span> <span class="n">packages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">class_name_prefix</span><span class="o">=</span><span class="s1">&#39;Django&#39;</span><span class="p">,</span> <span class="n">enable_timescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enable_gfk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gfk_policy</span><span class="o">=</span><span class="s1">&#39;all_nested&#39;</span><span class="p">,</span> <span class="n">gfk_threshold_children</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">gfk_value_mode</span><span class="o">=</span><span class="s1">&#39;typed_columns&#39;</span><span class="p">,</span> <span class="n">gfk_normalize_common_attrs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize the base generator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to output the generated models.py file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>packages</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of packages to scan for source models.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>app_label</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Django app label to use for the models.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>filter_function</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="type">type</span>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>]], <span title="bool">bool</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional function to filter which source models to include.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Print verbose output.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>discovery_instance</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="BaseDiscovery (pydantic2django.core.discovery.BaseDiscovery)" href="#pydantic2django.core.discovery.BaseDiscovery">BaseDiscovery</a>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of a BaseDiscovery subclass.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_factory_instance</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="BaseModelFactory (pydantic2django.core.factories.BaseModelFactory)" href="#pydantic2django.core.factories.BaseModelFactory">BaseModelFactory</a>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>, <span title="pydantic2django.core.base_generator.FieldInfoType">FieldInfoType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of a BaseModelFactory subclass.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>module_mappings</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional mapping of modules to remap imports.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>base_model_class</code>
            </td>
            <td>
                  <code><span title="type">type</span>[<span title="django.db.models.Model">Model</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base Django model class to inherit from.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>class_name_prefix</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Prefix for generated Django model class names.</p>
              </div>
            </td>
            <td>
                  <code>&#39;Django&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_timescale</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable TimescaleDB support for hypertables.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">filter_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">discovery_instance</span><span class="p">:</span> <span class="n">BaseDiscovery</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">],</span>
    <span class="n">model_factory_instance</span><span class="p">:</span> <span class="n">BaseModelFactory</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">,</span> <span class="n">FieldInfoType</span><span class="p">],</span>
    <span class="n">module_mappings</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">base_model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">],</span>
    <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">class_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Django&quot;</span><span class="p">,</span>
    <span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># --- GFK flags ---</span>
    <span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;all_nested&quot;</span><span class="p">,</span>
    <span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">,</span>
    <span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the base generator.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_path: Path to output the generated models.py file.</span>
<span class="sd">        packages: List of packages to scan for source models.</span>
<span class="sd">        app_label: Django app label to use for the models.</span>
<span class="sd">        filter_function: Optional function to filter which source models to include.</span>
<span class="sd">        verbose: Print verbose output.</span>
<span class="sd">        discovery_instance: An instance of a BaseDiscovery subclass.</span>
<span class="sd">        model_factory_instance: An instance of a BaseModelFactory subclass.</span>
<span class="sd">        module_mappings: Optional mapping of modules to remap imports.</span>
<span class="sd">        base_model_class: The base Django model class to inherit from.</span>
<span class="sd">        class_name_prefix: Prefix for generated Django model class names.</span>
<span class="sd">        enable_timescale: Whether to enable TimescaleDB support for hypertables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span> <span class="o">=</span> <span class="n">app_label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span> <span class="o">=</span> <span class="n">filter_function</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span> <span class="o">=</span> <span class="n">discovery_instance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span> <span class="o">=</span> <span class="n">model_factory_instance</span>
    <span class="c1"># Base model class must be provided explicitly by subclass at call site.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">base_model_class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">class_name_prefix</span> <span class="o">=</span> <span class="n">class_name_prefix</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Stores results from model factory</span>
    <span class="c1"># Feature flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enable_timescale</span><span class="p">)</span>
    <span class="c1"># GFK feature flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">enable_gfk</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_policy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_threshold_children</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">gfk_value_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">gfk_normalize_common_attrs</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span> <span class="o">=</span> <span class="n">ImportHandler</span><span class="p">(</span><span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span><span class="p">)</span>

    <span class="c1"># Initialize Jinja2 environment</span>
    <span class="c1"># Look for templates in the django/templates subdirectory</span>
    <span class="c1"># package_templates_dir = os.path.join(os.path.dirname(__file__), &quot;..&quot;, &quot;templates&quot;) # Old path</span>
    <span class="n">package_templates_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>  <span class="c1"># Corrected path</span>

    <span class="c1"># If templates don&#39;t exist in the package, use the ones relative to the execution?</span>
    <span class="c1"># This might need adjustment based on packaging/distribution.</span>
    <span class="c1"># For now, assume templates are relative to the package structure.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">):</span>
        <span class="c1"># Fallback or raise error might be needed</span>
        <span class="n">package_templates_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">(),</span> <span class="s2">&quot;templates&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Templates directory not found at expected location: </span><span class="si">{</span><span class="n">package_templates_dir</span><span class="si">}</span><span class="s2">. Jinja might fail.&quot;</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
        <span class="n">loader</span><span class="o">=</span><span class="n">jinja2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">package_templates_dir</span><span class="p">),</span>
        <span class="n">trim_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">lstrip_blocks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Register common custom filters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;format_type_string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span>
    <span class="c1"># Provide an escaping filter for embedding strings safely in generated Python code</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..core.utils.strings</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_string</span> <span class="k">as</span> <span class="n">_escape_py_str</span>  <span class="c1"># Local import to avoid cycles</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;escape_py_str&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_escape_py_str</span>
    <span class="c1"># Add more common filters if needed</span>

    <span class="c1"># Add base model import</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.discover_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discover_models</span><span class="p">()</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.discover_models" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Discover source models using the configured discovery instance.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover source models using the configured discovery instance.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovering models from packages: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">packages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Corrected call matching BaseDiscovery signature</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">discover_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packages</span> <span class="ow">or</span> <span class="p">[],</span>  <span class="c1"># Pass empty list if None</span>
        <span class="n">app_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
        <span class="n">user_filters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">,</span>  <span class="c1"># Keep as is for now</span>
    <span class="p">)</span>

    <span class="c1"># Analyze dependencies after discovery</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">analyze_dependencies</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> models after filtering.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (No models found or passed filter)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dependency analysis complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.generate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate</span><span class="p">()</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Main entry point: Generate and write the models file.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the generated models file.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point: Generate and write the models file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The path to the generated models file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_models_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_models_file</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully generated models file at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating models file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Use exc_info for traceback</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.generate_model_definition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate_model_definition" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates a string definition for a single Django model using a template.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>carrier</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversionCarrier (pydantic2django.core.factories.ConversionCarrier)" href="#pydantic2django.core.factories.ConversionCarrier">ConversionCarrier</a>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ConversionCarrier containing the generated Django model and context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The string representation of the Django model definition.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a string definition for a single Django model using a template.</span>

<span class="sd">    Args:</span>
<span class="sd">        carrier: The ConversionCarrier containing the generated Django model and context.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The string representation of the Django model definition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
        <span class="c1"># It&#39;s possible a carrier exists only for context, handle gracefully.</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping Django model definition for </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> (likely context-only).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot generate model definition for </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">: django_model is missing in carrier.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="n">django_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">source_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Get original name via abstract method</span>

    <span class="c1"># --- Prepare Fields ---</span>
    <span class="n">fields_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Combine regular and relationship fields from the carrier</span>
    <span class="n">all_django_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="p">,</span> <span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span> <span class="ow">in</span> <span class="n">all_django_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># The field_object is already an instantiated Django field</span>
        <span class="c1"># Add (name, object) tuple directly for the template</span>
        <span class="n">fields_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_object</span><span class="p">))</span>

    <span class="c1"># --- Prepare Meta ---</span>
    <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">):</span>
        <span class="n">model_meta</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">meta_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;db_table&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;db_table&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">django_model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;verbose_name&quot;</span><span class="p">,</span> <span class="n">django_model_name</span><span class="p">),</span>
            <span class="s2">&quot;verbose_name_plural&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_meta</span><span class="p">,</span> <span class="s2">&quot;verbose_name_plural&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">),</span>
            <span class="c1"># Add other meta options if needed</span>
        <span class="p">}</span>

    <span class="c1"># --- Prepare Base Class Info ---</span>
    <span class="n">base_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
        <span class="c1"># Use the immediate parent if it&#39;s not the absolute base &#39;models.Model&#39;</span>
        <span class="c1"># Assumes single inheritance for the generated model besides the ultimate base</span>
        <span class="n">parent_class</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Check if the parent is our intended base_model_class or something else</span>
        <span class="c1"># This logic might need refinement depending on how complex the inheritance gets</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">parent_class</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="ow">and</span> <span class="n">parent_class</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
            <span class="n">base_model_name</span> <span class="o">=</span> <span class="n">parent_class</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="c1"># Add import for the parent if it&#39;s not the configured base_model_class</span>
            <span class="k">if</span> <span class="n">parent_class</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">parent_class</span><span class="p">)</span>

    <span class="c1"># --- Get Subclass Specific Context ---</span>
    <span class="n">extra_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_definition_extra_context</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

    <span class="c1"># --- Process Pending Multi-FK Unions and add to definitions dict ---</span>
    <span class="n">multi_fk_field_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Keep track for validation hint</span>
    <span class="n">validation_needed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="p">:</span>
        <span class="n">validation_needed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">original_field_name</span><span class="p">,</span> <span class="n">union_details</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="p">:</span>
            <span class="n">pydantic_models</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">pydantic_model</span> <span class="ow">in</span> <span class="n">pydantic_models</span><span class="p">:</span>
                <span class="c1"># Construct field name (e.g., original_name_relatedmodel)</span>
                <span class="n">fk_field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_field_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">multi_fk_field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_field_name</span><span class="p">)</span>
                <span class="c1"># Get corresponding Django model</span>
                <span class="n">pydantic_factory</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticModelFactory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span><span class="p">)</span>
                <span class="n">django_model_rel</span> <span class="o">=</span> <span class="n">pydantic_factory</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                    <span class="n">pydantic_model</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">django_model_rel</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not find Django model for Pydantic model </span><span class="si">{</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> referenced in multi-FK union for </span><span class="si">{</span><span class="n">original_field_name</span><span class="si">}</span><span class="s2">. Skipping FK field.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Use string for model ref in kwargs</span>
                <span class="n">target_model_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">django_model_rel</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="c1"># Add import for the related Django model</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">django_model_rel</span><span class="p">)</span>

                <span class="c1"># Define FK kwargs (always null=True, blank=True)</span>
                <span class="c1"># Use strings for values that need to be represented in code</span>
                <span class="n">fk_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">target_model_str</span><span class="p">,</span>
                    <span class="s2">&quot;on_delete&quot;</span><span class="p">:</span> <span class="s2">&quot;models.SET_NULL&quot;</span><span class="p">,</span>  <span class="c1"># Use string for template</span>
                    <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;blank&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="c1"># Generate related_name to avoid clashes</span>
                    <span class="s2">&quot;related_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fk_field_name</span><span class="si">}</span><span class="s2">_set&#39;&quot;</span><span class="p">,</span>  <span class="c1"># Ensure related_name is quoted string</span>
                <span class="p">}</span>
                <span class="c1"># Generate the definition string</span>
                <span class="n">fk_def_string</span> <span class="o">=</span> <span class="n">generate_field_definition_string</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">fk_kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">)</span>
                <span class="c1"># Add to the main definitions dictionary</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span><span class="n">fk_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fk_def_string</span>

    <span class="c1"># --- Prepare Final Context --- #</span>
    <span class="c1"># Ensure the context uses the potentially updated definitions dict from the carrier</span>
    <span class="c1"># Subclass _get_model_definition_extra_context should already provide this</span>
    <span class="c1"># via `field_definitions=carrier.django_field_definitions`</span>
    <span class="n">template_context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">django_model_name</span><span class="p">,</span>
        <span class="s2">&quot;pydantic_model_name&quot;</span><span class="p">:</span> <span class="n">source_model_name</span><span class="p">,</span>
        <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="n">base_model_name</span><span class="p">,</span>
        <span class="s2">&quot;is_timescale_model&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_model_name</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;TimescaleBase&quot;</span><span class="p">)),</span>
        <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">meta_options</span><span class="p">,</span>
        <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
        <span class="s2">&quot;multi_fk_field_names&quot;</span><span class="p">:</span> <span class="n">multi_fk_field_names</span><span class="p">,</span>  <span class="c1"># Pass names for validation hint</span>
        <span class="s2">&quot;validation_needed&quot;</span><span class="p">:</span> <span class="n">validation_needed</span><span class="p">,</span>  <span class="c1"># Signal if validation needed</span>
        <span class="c1"># Include extra context from subclass (should include field_definitions)</span>
        <span class="o">**</span><span class="n">extra_context</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># --- Render Template --- #</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;model_definition.py.j2&quot;</span><span class="p">)</span>
    <span class="n">definition_str</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>

    <span class="c1"># Add import for the original source model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_source_model_import</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">definition_str</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.generate_models_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_models_file</span><span class="p">()</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.generate_models_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates the complete content for the models.py file.
This method orchestrates discovery, model setup, definition generation,
import collection, and template rendering.
Subclasses might override this to add specific steps (like context class generation).</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the complete content for the models.py file.</span>
<span class="sd">    This method orchestrates discovery, model setup, definition generation,</span>
<span class="sd">    import collection, and template rendering.</span>
<span class="sd">    Subclasses might override this to add specific steps (like context class generation).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>  <span class="c1"># Populates discovery instance</span>
    <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>  <span class="c1"># Abstract method</span>

    <span class="c1"># Reset state for this run</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Re-add base model import after clearing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>

    <span class="n">model_definitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">django_model_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For __all__</span>

    <span class="c1"># Setup Django models first (populates self.carriers)</span>
    <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>  <span class="c1"># Calls factory, populates carrier</span>

    <span class="c1"># Generate definitions from carriers</span>
    <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
        <span class="c1"># Generate Django model definition if model exists</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Uses template</span>
                <span class="k">if</span> <span class="n">model_def</span><span class="p">:</span>  <span class="c1"># Only add if definition was generated</span>
                    <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
                    <span class="n">django_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                    <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating definition for source model </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Subclasses might add context class generation here by overriding this method</span>
        <span class="c1"># or by generate_model_definition adding context-related imports.</span>

    <span class="c1"># Deduplicate definitions</span>
    <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>

    <span class="c1"># Deduplicate imports gathered during the process</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>

    <span class="c1"># Prepare context using subclass method (_prepare_template_context)</span>
    <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>

    <span class="c1"># Add common context items</span>
    <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
            <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
            <span class="c1"># Add other common items as needed</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Render the main template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.base_generator.BaseStaticGenerator.setup_django_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.base_generator.BaseStaticGenerator.setup_django_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Uses the model factory to create a Django model representation from a source model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_model</code>
            </td>
            <td>
                  <code><span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The source model instance (e.g., Pydantic class, Dataclass).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversionCarrier (pydantic2django.core.factories.ConversionCarrier)" href="#pydantic2django.core.factories.ConversionCarrier">ConversionCarrier</a>[<span title="pydantic2django.core.base_generator.SourceModelType">SourceModelType</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A ConversionCarrier containing the results, or None if creation failed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/base_generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="n">SourceModelType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the model factory to create a Django model representation from a source model.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_model: The source model instance (e.g., Pydantic class, Dataclass).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ConversionCarrier containing the results, or None if creation failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">source_model</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up Django model for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Instantiate the carrier here</span>
    <span class="n">carrier</span> <span class="o">=</span> <span class="n">ConversionCarrier</span><span class="p">(</span>
        <span class="n">source_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">],</span> <span class="n">source_model</span><span class="p">),</span>
        <span class="n">meta_app_label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
        <span class="n">base_django_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">,</span>
        <span class="n">class_name_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_name_prefix</span><span class="p">,</span>
        <span class="c1"># Add other defaults/configs if needed, e.g., strict mode</span>
        <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Example default</span>
        <span class="c1"># GFK flags</span>
        <span class="n">enable_gfk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_gfk</span><span class="p">,</span>
        <span class="n">gfk_policy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_policy</span><span class="p">,</span>
        <span class="n">gfk_threshold_children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_threshold_children</span><span class="p">,</span>
        <span class="n">gfk_value_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_value_mode</span><span class="p">,</span>
        <span class="n">gfk_normalize_common_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gfk_normalize_common_attrs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use the factory to process the source model and populate the carrier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_factory_instance</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Pass carrier to factory</span>

        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully processed </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">carrier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Log if model creation resulted in None (e.g., only context fields)</span>
            <span class="c1"># Check carrier.context_fields or carrier.invalid_fields for details</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped Django model class for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> - only context fields found.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Skipped Django model class for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> due to invalid fields: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Django model was not generated for </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> for unknown reasons.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Return None if no Django model was created</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">source_model_name</span><span class="si">}</span><span class="s2"> with factory: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Model discovery (abstract + per-source dependency graph)</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.discovery.BaseDiscovery"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.discovery.TModel">TModel</span>]</code></p>


        <p>Abstract base class for discovering models (e.g., Pydantic, Dataclasses).</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/discovery.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseDiscovery</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TModel</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for discovering models (e.g., Pydantic, Dataclasses).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># All discovered models before any filtering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Models after all filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dependencies between filtered models</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_target_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object is the type of model this discovery class handles.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_default_eligibility_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply default filtering logic inherent to the model type (e.g., exclude abstract classes).</span>
<span class="sd">        Return True if the model is eligible, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Keep for potential use in filters or subclasses</span>
        <span class="n">user_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover target models in the specified packages, applying default and user filters.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Normalize user_filters to always be a list</span>
        <span class="k">if</span> <span class="n">user_filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_filters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="n">user_filters</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># It&#39;s a single callable</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_filters</span><span class="p">]</span>

        <span class="n">model_type_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;TargetModel&quot;</span><span class="p">)</span>  <span class="c1"># Get class name for logging</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> discovery in packages: </span><span class="si">{</span><span class="n">packages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">package_name</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning package: </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_importer</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">_ispkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">walk_packages</span><span class="p">(</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                    <span class="n">onerror</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                            <span class="c1"># Use the subclass implementation to check if it&#39;s the right model type</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                                <span class="n">model_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">if</span> <span class="n">model_qualname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered potential </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                    <span class="c1"># Apply filters sequentially using subclass implementation</span>
                                    <span class="n">is_eligible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_eligibility_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">is_eligible</span><span class="p">:</span>
                                        <span class="k">for</span> <span class="n">user_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                                            <span class="k">try</span><span class="p">:</span>
                                                <span class="k">if</span> <span class="ow">not</span> <span class="n">user_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                                                    <span class="n">is_eligible</span> <span class="o">=</span> <span class="kc">False</span>
                                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                                        <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> by user filter: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span>
                                                    <span class="p">)</span>
                                                    <span class="k">break</span>  <span class="c1"># No need to check other filters</span>
                                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">filter_exc</span><span class="p">:</span>
                                                <span class="c1"># Attempt to get filter name, default to repr</span>
                                                <span class="n">filter_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user_filter</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">user_filter</span><span class="p">))</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;Error applying user filter </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">filter_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="p">)</span>
                                                <span class="n">is_eligible</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Exclude on filter error</span>
                                                <span class="k">break</span>

                                    <span class="k">if</span> <span class="n">is_eligible</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added eligible </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not import module </span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inspecting module </span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">s: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error discovering </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">s in package </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> discovery complete. Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> total models, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> after filtering.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Hooks for subclass-specific post-processing if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_discovery_hook</span><span class="p">()</span>

        <span class="c1"># Resolve forward references if applicable (might be subclass specific)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_forward_refs</span><span class="p">()</span>

        <span class="c1"># Build dependency graph for filtered models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_dependencies</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze dependencies between the filtered models.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return filtered models sorted topologically based on dependencies.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Optional hook for subclasses to run code after discovery loop but before analyze</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_post_discovery_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Keep placeholder, subclasses might override if needed</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_forward_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Placeholder for resolving forward references if needed.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Base _resolve_forward_refs called (if applicable).&quot;</span><span class="p">)</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.discovery.BaseDiscovery.analyze_dependencies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_dependencies</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#pydantic2django.core.discovery.BaseDiscovery.analyze_dependencies" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Analyze dependencies between the filtered models.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze dependencies between the filtered models.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.discovery.BaseDiscovery.discover_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discover_models</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">user_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.core.discovery.BaseDiscovery.discover_models" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Discover target models in the specified packages, applying default and user filters.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Keep for potential use in filters or subclasses</span>
    <span class="n">user_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover target models in the specified packages, applying default and user filters.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Normalize user_filters to always be a list</span>
    <span class="k">if</span> <span class="n">user_filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_filters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">user_filters</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># It&#39;s a single callable</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_filters</span><span class="p">]</span>

    <span class="n">model_type_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;TargetModel&quot;</span><span class="p">)</span>  <span class="c1"># Get class name for logging</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> discovery in packages: </span><span class="si">{</span><span class="n">packages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">package_name</span> <span class="ow">in</span> <span class="n">packages</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">package</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scanning package: </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_importer</span><span class="p">,</span> <span class="n">modname</span><span class="p">,</span> <span class="n">_ispkg</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">walk_packages</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s2">&quot;__path__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">package</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
                <span class="n">onerror</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
                        <span class="c1"># Use the subclass implementation to check if it&#39;s the right model type</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                            <span class="n">model_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="k">if</span> <span class="n">model_qualname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered potential </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                                <span class="c1"># Apply filters sequentially using subclass implementation</span>
                                <span class="n">is_eligible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_eligibility_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">is_eligible</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">user_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_filter</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                                                <span class="n">is_eligible</span> <span class="o">=</span> <span class="kc">False</span>
                                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                                    <span class="sa">f</span><span class="s2">&quot;Filtered out </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> by user filter: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span>
                                                <span class="p">)</span>
                                                <span class="k">break</span>  <span class="c1"># No need to check other filters</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">filter_exc</span><span class="p">:</span>
                                            <span class="c1"># Attempt to get filter name, default to repr</span>
                                            <span class="n">filter_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">user_filter</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">user_filter</span><span class="p">))</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                                <span class="sa">f</span><span class="s2">&quot;Error applying user filter </span><span class="si">{</span><span class="n">filter_name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">filter_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="p">)</span>
                                            <span class="n">is_eligible</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Exclude on filter error</span>
                                            <span class="k">break</span>

                                <span class="k">if</span> <span class="n">is_eligible</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added eligible </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">model_qualname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not import module </span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error inspecting module </span><span class="si">{</span><span class="n">modname</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">s: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error discovering </span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2">s in package </span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_type_name</span><span class="si">}</span><span class="s2"> discovery complete. Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> total models, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> after filtering.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Hooks for subclass-specific post-processing if needed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_post_discovery_hook</span><span class="p">()</span>

    <span class="c1"># Resolve forward references if applicable (might be subclass specific)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_forward_refs</span><span class="p">()</span>

    <span class="c1"># Build dependency graph for filtered models</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analyze_dependencies</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.discovery.BaseDiscovery.get_models_in_registration_order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_models_in_registration_order</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#pydantic2django.core.discovery.BaseDiscovery.get_models_in_registration_order" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return filtered models sorted topologically based on dependencies.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TModel</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return filtered models sorted topologically based on dependencies.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Model/field factories and the conversion carrier</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.factories.BaseModelFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.factories.SourceModelType">SourceModelType</span>, <span title="pydantic2django.core.factories.SourceFieldType">SourceFieldType</span>]</code></p>


        <p>Abstract base class for model factories.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseModelFactory</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">,</span> <span class="n">SourceFieldType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for model factories.&quot;&quot;&quot;</span>

    <span class="n">field_factory</span><span class="p">:</span> <span class="n">BaseFieldFactory</span><span class="p">[</span><span class="n">SourceFieldType</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_factory</span><span class="p">:</span> <span class="n">BaseFieldFactory</span><span class="p">[</span><span class="n">SourceFieldType</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the model factory with a compatible field factory.</span>
<span class="sd">        Allows subclasses to accept additional dependencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span> <span class="o">=</span> <span class="n">field_factory</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_source_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abstract method for subclasses to implement field processing.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Common logic moved from subclasses</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_field_collisions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for field name collisions with the base Django model.&quot;&quot;&quot;</span>
        <span class="n">base_model</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">base_django_model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">base_model</span><span class="p">,</span> <span class="s2">&quot;_meta&quot;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_fields</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">include_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_hidden</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">base_field_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">base_fields</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get fields from base model </span><span class="si">{</span><span class="n">base_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for collision check: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">all_new_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">collision_fields</span> <span class="o">=</span> <span class="n">all_new_fields</span> <span class="o">&amp;</span> <span class="n">base_field_names</span>

        <span class="k">if</span> <span class="n">collision_fields</span><span class="p">:</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Field collision detected between </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> and base model </span><span class="si">{</span><span class="n">base_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">collision_fields</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot; Raising error due to strict=True.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot; Use strict=False or rename fields.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot; Removing colliding fields from generated model (strict=False).&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">collision_fields</span><span class="p">:</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_django_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the Meta class for the generated Django model.&quot;&quot;&quot;</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownSourceModel&quot;</span><span class="p">)</span>
        <span class="n">source_model_name_cleaned</span> <span class="o">=</span> <span class="n">source_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">meta_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;app_label&quot;</span><span class="p">:</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">,</span>
            <span class="s2">&quot;db_table&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">source_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="c1"># Keep dynamic models abstract so Django does not register them in the</span>
            <span class="c1"># global app registry. This avoids conflicts with concrete generated models</span>
            <span class="c1"># imported later (e.g., during makemigrations in tests).</span>
            <span class="s2">&quot;abstract&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;managed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="n">source_model_name_cleaned</span><span class="p">,</span>
            <span class="s2">&quot;verbose_name_plural&quot;</span><span class="p">:</span> <span class="n">source_model_name_cleaned</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ordering&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Create Meta, not inheriting from base Meta to ensure abstract stays True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating new Meta class for dynamic model (abstract=True)&quot;</span><span class="p">)</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">django_meta_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;Meta&quot;</span><span class="p">,</span> <span class="p">(),</span> <span class="n">meta_attrs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assemble_django_model_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble the final Django model class using type().&quot;&quot;&quot;</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownSourceModel&quot;</span><span class="p">)</span>
        <span class="n">source_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">model_attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="p">,</span>
            <span class="o">**</span><span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">,</span>
            <span class="c1"># Set __module__ for where the model appears to live</span>
            <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="n">source_module</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="si">}</span><span class="s2">.models&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_meta_class</span><span class="p">:</span>
            <span class="n">model_attrs</span><span class="p">[</span><span class="s2">&quot;Meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_meta_class</span>

        <span class="c1"># Add a reference back to the source model (generic attribute name)</span>
        <span class="n">model_attrs</span><span class="p">[</span><span class="s2">&quot;_pydantic2django_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span>

        <span class="n">bases</span> <span class="o">=</span> <span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">base_django_model</span><span class="p">,)</span> <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">base_django_model</span> <span class="k">else</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,)</span>

        <span class="c1"># Even if no fields were generated (e.g., collisions with base removed them),</span>
        <span class="c1"># we still assemble the model class so that later phases (e.g., relationship finalization)</span>
        <span class="c1"># can inject fields and meta indexes onto the carrier.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No Django fields generated for </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">, assembling bare model class to allow later injections.&quot;</span>
            <span class="p">)</span>

        <span class="n">model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">class_name_prefix</span><span class="si">}{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assembling model class &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; with bases </span><span class="si">{</span><span class="n">bases</span><span class="si">}</span><span class="s2"> and attrs: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">model_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use type() to dynamically create the class</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">model_attrs</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully assembled Django model class: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to assemble Django model class </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;_assembly&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Failed to create model type: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_model_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Abstract method for subclasses to build the specific ModelContext.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c1"># Main orchestration method</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrates the Django model creation process.</span>
<span class="sd">        Subclasses implement _process_source_fields and _build_model_context.</span>
<span class="sd">        Handles caching.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Cache handling needs refinement - how to access subclass cache?</span>
        <span class="c1"># For now, skipping cache check in base class.</span>
        <span class="c1"># if model_key in self._converted_models and not carrier.existing_model:</span>
        <span class="c1">#     # ... update carrier from cache ...</span>
        <span class="c1">#     return</span>

        <span class="c1"># Reset results on carrier</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">django_meta_class</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Reset definitions dict</span>

        <span class="c1"># Core Steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_source_fields</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_field_collisions</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_django_meta</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_django_model_class</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

        <span class="c1"># Build context only if model assembly succeeded</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_context</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.BaseModelFactory.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#pydantic2django.core.factories.BaseModelFactory.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initializes the model factory with a compatible field factory.
Allows subclasses to accept additional dependencies.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_factory</span><span class="p">:</span> <span class="n">BaseFieldFactory</span><span class="p">[</span><span class="n">SourceFieldType</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the model factory with a compatible field factory.</span>
<span class="sd">    Allows subclasses to accept additional dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span> <span class="o">=</span> <span class="n">field_factory</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.BaseModelFactory.make_django_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.core.factories.BaseModelFactory.make_django_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Orchestrates the Django model creation process.
Subclasses implement _process_source_fields and _build_model_context.
Handles caching.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the Django model creation process.</span>
<span class="sd">    Subclasses implement _process_source_fields and _build_model_context.</span>
<span class="sd">    Handles caching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: Cache handling needs refinement - how to access subclass cache?</span>
    <span class="c1"># For now, skipping cache check in base class.</span>
    <span class="c1"># if model_key in self._converted_models and not carrier.existing_model:</span>
    <span class="c1">#     # ... update carrier from cache ...</span>
    <span class="c1">#     return</span>

    <span class="c1"># Reset results on carrier</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">django_meta_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Reset definitions dict</span>

    <span class="c1"># Core Steps</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_source_fields</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_field_collisions</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_create_django_meta</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_django_model_class</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

    <span class="c1"># Build context only if model assembly succeeded</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_context</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.factories.BaseFieldFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.factories.SourceFieldType">SourceFieldType</span>]</code></p>


        <p>Abstract base class for field factories.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseFieldFactory</span><span class="p">(</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">SourceFieldType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for field factories.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Allow subclasses to accept necessary dependencies (e.g., relationship accessors)</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">SourceFieldType</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a source field type into a Django Field.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_info: The field information object from the source (Pydantic/Dataclass).</span>
<span class="sd">            model_name: The name of the source model containing the field.</span>
<span class="sd">            carrier: The conversion carrier for context (e.g., app_label, relationships).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A FieldConversionResult containing the generated Django field or context/error info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.BaseFieldFactory.create_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_field</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#pydantic2django.core.factories.BaseFieldFactory.create_field" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a source field type into a Django Field.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_info</code>
            </td>
            <td>
                  <code><span title="pydantic2django.core.factories.SourceFieldType">SourceFieldType</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The field information object from the source (Pydantic/Dataclass).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the source model containing the field.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>carrier</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ConversionCarrier (pydantic2django.core.factories.ConversionCarrier)" href="#pydantic2django.core.factories.ConversionCarrier">ConversionCarrier</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The conversion carrier for context (e.g., app_label, relationships).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="FieldConversionResult (pydantic2django.core.factories.FieldConversionResult)" href="#pydantic2django.core.factories.FieldConversionResult">FieldConversionResult</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A FieldConversionResult containing the generated Django field or context/error info.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">SourceFieldType</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a source field type into a Django Field.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_info: The field information object from the source (Pydantic/Dataclass).</span>
<span class="sd">        model_name: The name of the source model containing the field.</span>
<span class="sd">        carrier: The conversion carrier for context (e.g., app_label, relationships).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A FieldConversionResult containing the generated Django field or context/error info.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.factories.ConversionCarrier"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.factories.SourceModelType">SourceModelType</span>]</code></p>


        <p>Carrier class for converting a source model (Pydantic/Dataclass) to a Django model.
Holds configuration and accumulates results during the conversion process.
Generalized from the original DjangoModelFactoryCarrier.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ConversionCarrier</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Carrier class for converting a source model (Pydantic/Dataclass) to a Django model.</span>
<span class="sd">    Holds configuration and accumulates results during the conversion process.</span>
<span class="sd">    Generalized from the original DjangoModelFactoryCarrier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">source_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]</span>
    <span class="n">meta_app_label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">base_django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span>  <span class="c1"># Base Django model to inherit from</span>
    <span class="n">existing_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For updating existing models</span>
    <span class="n">class_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Django&quot;</span>  <span class="c1"># Prefix for generated Django model name</span>
    <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Strict mode for field collisions</span>
    <span class="n">used_related_names_per_target</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">django_field_definitions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># Added field defs</span>

    <span class="c1"># --- Result fields (populated during conversion) ---</span>
    <span class="n">django_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">relationship_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">context_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># Store original source field info</span>
    <span class="n">context_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Stores (original_field_name, union_details_dict) for multi-FK unions</span>
    <span class="n">pending_multi_fk_unions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># --- GFK mode support ---</span>
    <span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Mark children that should be represented as GenericEntry rows</span>
    <span class="n">pending_gfk_children</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">invalid_fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">django_meta_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">django_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Changed from DjangoModelType</span>
    <span class="n">model_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Removed import_handler from carrier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">model_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a unique key for the source model.&quot;&quot;&quot;</span>
        <span class="n">module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownModel&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownSource&quot;</span><span class="p">)</span>
        <span class="n">django_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">django_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">django_model</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">django_name</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.ConversionCarrier.model_key" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_key</span><span class="p">()</span></code>

<a href="#pydantic2django.core.factories.ConversionCarrier.model_key" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate a unique key for the source model.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a unique key for the source model.&quot;&quot;&quot;</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;UnknownModel&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.factories.FieldConversionResult"></a>
    <div class="doc doc-contents first">


        <p>Data structure holding the result of attempting to convert a single source field.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FieldConversionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data structure holding the result of attempting to convert a single source field.&quot;&quot;&quot;</span>

    <span class="n">field_info</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Original source field info (FieldInfo, dataclasses.Field)</span>
    <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># type_mapping_definition: Optional[TypeMappingDefinition] = None # Keep mapping info internal?</span>
    <span class="n">field_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">django_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context_field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Holds original field_info if handled by context</span>
    <span class="n">error_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">field_definition_str</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Added field definition string</span>
    <span class="c1"># Added required_imports dictionary</span>
    <span class="n">required_imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="c1"># Store the raw kwargs returned by the mapper</span>
    <span class="n">raw_mapper_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to add an import to this result.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">current_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_imports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_names</span><span class="p">:</span>
            <span class="n">current_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_import_for_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to add an import for a given object (class, function, etc.).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine import for object: </span><span class="si">{</span><span class="n">obj</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">django_field</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;Context&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_field</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">error_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">django_field</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">django_field</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;FieldConversionResult(field=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">, status=</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">, django_type=</span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.FieldConversionResult.add_import" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_import</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.factories.FieldConversionResult.add_import" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Helper to add an import to this result.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to add an import to this result.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">current_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_imports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_names</span><span class="p">:</span>
        <span class="n">current_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.factories.FieldConversionResult.add_import_for_obj" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_import_for_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></code>

<a href="#pydantic2django.core.factories.FieldConversionResult.add_import_for_obj" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Helper to add an import for a given object (class, function, etc.).</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/factories.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_import_for_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper to add an import for a given object (class, function, etc.).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine import for object: </span><span class="si">{</span><span class="n">obj</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Bidirectional type mapping (Python/Pydantic ↔ Django.Field)</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper"></a>
    <div class="doc doc-contents first">


        <p>Registry and entry point for bidirectional type mapping.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/bidirectional_mapper.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BidirectionalTypeMapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Registry and entry point for bidirectional type mapping.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RelationshipConversionAccessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span> <span class="ow">or</span> <span class="n">RelationshipConversionAccessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_registry</span><span class="p">()</span>
        <span class="c1"># Caches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_django_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover and order TypeMappingUnit subclasses.&quot;&quot;&quot;</span>
        <span class="c1"># Order matters less for selection now, but still useful for tie-breaking?</span>
        <span class="c1"># References mapping units imported from .mapping_units</span>
        <span class="n">ordered_units</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># Specific PKs first (subclass of IntField)</span>
            <span class="n">BigAutoFieldMapping</span><span class="p">,</span>
            <span class="n">SmallAutoFieldMapping</span><span class="p">,</span>
            <span class="n">AutoFieldMapping</span><span class="p">,</span>
            <span class="c1"># Specific Numerics (subclass of IntField/FloatField/DecimalField)</span>
            <span class="n">PositiveBigIntFieldMapping</span><span class="p">,</span>
            <span class="n">PositiveSmallIntFieldMapping</span><span class="p">,</span>
            <span class="n">PositiveIntFieldMapping</span><span class="p">,</span>
            <span class="c1"># Specific Strings (subclass of CharField/TextField)</span>
            <span class="n">EmailFieldMapping</span><span class="p">,</span>
            <span class="n">URLFieldMapping</span><span class="p">,</span>
            <span class="n">SlugFieldMapping</span><span class="p">,</span>
            <span class="n">IPAddressFieldMapping</span><span class="p">,</span>
            <span class="n">FilePathFieldMapping</span><span class="p">,</span>  <span class="c1"># Needs Path, but Django field is specific</span>
            <span class="c1"># File Fields (map Path/str, Django fields are specific)</span>
            <span class="n">ImageFieldMapping</span><span class="p">,</span>  <span class="c1"># Subclass of FileField</span>
            <span class="n">FileFieldMapping</span><span class="p">,</span>
            <span class="c1"># Other specific types before bases</span>
            <span class="n">UUIDFieldMapping</span><span class="p">,</span>
            <span class="n">JsonFieldMapping</span><span class="p">,</span>  <span class="c1"># Before generic collections/Any might map elsewhere</span>
            <span class="c1"># Base Relationship types (before fields they might inherit from like FK &lt; Field)</span>
            <span class="n">ManyToManyFieldMapping</span><span class="p">,</span>
            <span class="n">OneToOneFieldMapping</span><span class="p">,</span>
            <span class="n">ForeignKeyMapping</span><span class="p">,</span>
            <span class="c1"># General Base Types LAST</span>
            <span class="n">DecimalFieldMapping</span><span class="p">,</span>
            <span class="n">DateTimeFieldMapping</span><span class="p">,</span>
            <span class="n">DateFieldMapping</span><span class="p">,</span>
            <span class="n">TimeFieldMapping</span><span class="p">,</span>
            <span class="n">DurationFieldMapping</span><span class="p">,</span>
            <span class="n">BinaryFieldMapping</span><span class="p">,</span>
            <span class="n">FloatFieldMapping</span><span class="p">,</span>
            <span class="n">BoolFieldMapping</span><span class="p">,</span>
            <span class="c1"># Str/Text: Order now primarily determined by `matches` score overrides</span>
            <span class="n">TextFieldMapping</span><span class="p">,</span>
            <span class="n">StrFieldMapping</span><span class="p">,</span>
            <span class="c1"># Specific Int types first</span>
            <span class="n">BigIntFieldMapping</span><span class="p">,</span>  <span class="c1"># Map int to BigInt before Int</span>
            <span class="n">SmallIntFieldMapping</span><span class="p">,</span>
            <span class="n">IntFieldMapping</span><span class="p">,</span>
            <span class="c1"># Enum handled dynamically by find method</span>
            <span class="n">EnumFieldMapping</span><span class="p">,</span>  <span class="c1"># Include EnumFieldMapping here for the loop</span>
        <span class="p">]</span>
        <span class="c1"># Remove duplicates just in case</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">unique_units</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">ordered_units</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">unique_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unique_units</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_unit_for_pydantic_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">py_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the best mapping unit for a given Pydantic type and FieldInfo.</span>
<span class="sd">        Uses a scoring system based on the `matches` classmethod of each unit.</span>
<span class="sd">        Handles Optional unwrapping and caching.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_type_for_cache</span> <span class="o">=</span> <span class="n">py_type</span>  <span class="c1"># Use the original type as the cache key</span>

        <span class="c1"># --- Unwrap Optional ---</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Optional</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
            <span class="c1"># Get the first non-None type argument</span>
            <span class="n">type_to_match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="n">Any</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unwrapped Optional[</span><span class="si">{</span><span class="n">type_to_match</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">] to </span><span class="si">{</span><span class="n">type_to_match</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Handle X | None syntax (UnionType)</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">UnionType</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
            <span class="n">non_none_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># If it&#39;s just `T | None`</span>
                <span class="n">type_to_match</span> <span class="o">=</span> <span class="n">non_none_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unwrapped Union[</span><span class="si">{</span><span class="n">py_type</span><span class="si">}</span><span class="s2">] with None to </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Keep the original UnionType if it&#39;s Union[A, B, ...]</span>
                <span class="n">type_to_match</span> <span class="o">=</span> <span class="n">py_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keeping UnionType </span><span class="si">{</span><span class="n">py_type</span><span class="si">}</span><span class="s2"> as is for matching.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">type_to_match</span> <span class="o">=</span> <span class="n">py_type</span>  <span class="c1"># Use the original type if not Optional or simple T | None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Final type_to_match for scoring: </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> (origin: </span><span class="si">{</span><span class="n">get_origin</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span><span class="si">}</span><span class="s2">, args: </span><span class="si">{</span><span class="n">get_args</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># --- Cache Check ---</span>
        <span class="c1"># Re-enable caching</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">original_type_for_cache</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">:</span>
            <span class="c1"># logger.debug(f&quot;Cache hit for {cache_key}&quot;)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        <span class="c1"># logger.debug(f&quot;Cache miss for {cache_key}&quot;)</span>

        <span class="c1"># --- Literal Type Check (using original type) --- #</span>
        <span class="n">original_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">original_type_for_cache</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">original_origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">original_type_for_cache</span><span class="si">}</span><span class="s2"> is Literal. Selecting EnumFieldMapping directly.&quot;</span><span class="p">)</span>
            <span class="n">best_unit</span> <span class="o">=</span> <span class="n">EnumFieldMapping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>
            <span class="k">return</span> <span class="n">best_unit</span>

        <span class="c1"># --- Prioritize Collection Types -&gt; JSON --- #</span>
        <span class="c1"># Use the unwrapped origin for this check</span>
        <span class="c1"># unwrapped_origin = get_origin(type_to_match)</span>
        <span class="c1"># if unwrapped_origin in (list, dict, set, tuple):</span>
        <span class="c1">#     logger.debug(f&quot;Type {type_to_match} is a collection. Selecting JsonFieldMapping directly.&quot;)</span>
        <span class="c1">#     best_unit = JsonFieldMapping</span>
        <span class="c1">#     self._pydantic_cache[cache_key] = best_unit</span>
        <span class="c1">#     return best_unit</span>

        <span class="c1"># --- Initialization --- #</span>
        <span class="n">best_unit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">highest_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Store scores for debugging</span>

        <span class="c1"># --- Relationship Check (Specific Model Types and Lists of Models) BEFORE Scoring --- #</span>
        <span class="c1"># Check if the type_to_match itself is a known model</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_direct_known_model</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">))</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">is_direct_known_model</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">is_direct_known_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">type_to_match</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is a known related model. Selecting ForeignKeyMapping directly.&quot;</span>
            <span class="p">)</span>
            <span class="n">best_unit</span> <span class="o">=</span> <span class="n">ForeignKeyMapping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>
            <span class="k">return</span> <span class="n">best_unit</span>

        <span class="c1"># Check if it&#39;s a list/set of known models (potential M2M)</span>
        <span class="n">unwrapped_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
        <span class="n">unwrapped_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unwrapped_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unwrapped_args</span><span class="p">:</span>  <span class="c1"># Check for list or set</span>
            <span class="n">inner_type</span> <span class="o">=</span> <span class="n">unwrapped_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_list_of_known_models</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">is_list_of_known_models</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TypeError checking if </span><span class="si">{</span><span class="n">inner_type</span><span class="si">}</span><span class="s2"> is a known model list item.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Checking list/set: unwrapped_origin=</span><span class="si">{</span><span class="n">unwrapped_origin</span><span class="si">}</span><span class="s2">, inner_type=</span><span class="si">{</span><span class="n">inner_type</span><span class="si">}</span><span class="s2">, is_list_of_known_models=</span><span class="si">{</span><span class="n">is_list_of_known_models</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_list_of_known_models</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> is a list/set of known models (</span><span class="si">{</span><span class="n">inner_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). Selecting ManyToManyFieldMapping directly.&quot;</span>
                <span class="p">)</span>
                <span class="n">best_unit</span> <span class="o">=</span> <span class="n">ManyToManyFieldMapping</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>
                <span class="k">return</span> <span class="n">best_unit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> is a list/set, but inner type </span><span class="si">{</span><span class="n">inner_type</span><span class="si">}</span><span class="s2"> is not a known model. Proceeding.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- Specific Union Handling BEFORE Scoring --- #</span>
        <span class="n">unwrapped_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
        <span class="c1"># Check for non-model Unions (Model unions handled in get_django_mapping signal)</span>
        <span class="k">if</span> <span class="n">unwrapped_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unwrapped_args</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating specific Union type </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> args: </span><span class="si">{</span><span class="n">unwrapped_args</span><span class="si">}</span><span class="s2"> before scoring.&quot;</span><span class="p">)</span>
            <span class="n">has_str</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unwrapped_args</span><span class="p">)</span>
            <span class="n">has_collection_or_any</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">get_origin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arg</span> <span class="ow">is</span> <span class="n">Any</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unwrapped_args</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Don&#39;t handle Union[ModelA, ModelB] here, that needs the signal mechanism</span>
            <span class="n">is_model_union</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unwrapped_args</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_model_union</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">has_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_collection_or_any</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Union </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> contains str, selecting TextFieldMapping directly.&quot;</span><span class="p">)</span>
                    <span class="n">best_unit</span> <span class="o">=</span> <span class="n">TextFieldMapping</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>
                    <span class="k">return</span> <span class="n">best_unit</span>
                <span class="k">elif</span> <span class="n">has_collection_or_any</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Union </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> contains complex types, selecting JsonFieldMapping directly.&quot;</span><span class="p">)</span>
                    <span class="n">best_unit</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>
                    <span class="k">return</span> <span class="n">best_unit</span>
                <span class="c1"># Else: Union of simple types (e.g., int | float) - let scoring handle it.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Union </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> is non-model, non-str/complex. Proceeding to scoring.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Union </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> contains models. Proceeding to scoring (expecting JsonField fallback).&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- Scoring Loop (Only if not a known related model or specific Union handled above) --- #</span>
        <span class="c1"># Use type_to_match (unwrapped) for matching</span>
        <span class="c1"># --- EDIT: Removed redundant check `if best_unit is None:` --- #</span>
        <span class="c1"># This loop now runs only if no direct selection happened above.</span>
        <span class="k">for</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>  <span class="c1"># Add try-except around matches call for robustness</span>
                <span class="c1"># Pass the unwrapped type to matches</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">unit_cls</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Log all positive scores</span>
                    <span class="n">scores</span><span class="p">[</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>  <span class="c1"># Store score regardless of whether it&#39;s the highest</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Scoring </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.matches(</span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">field_info</span><span class="si">=}</span><span class="s2">) -&gt; </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>  <span class="c1"># Added logging</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">highest_score</span><span class="p">:</span>
                    <span class="n">highest_score</span> <span class="o">=</span> <span class="n">score</span>
                    <span class="n">best_unit</span> <span class="o">=</span> <span class="n">unit_cls</span>
                    <span class="c1"># Store the winning score as well - Moved above</span>
                    <span class="c1"># scores[unit_cls.__name__] = score  # Overwrite if it was a lower score before</span>
                <span class="c1"># elif score &gt; 0:  # Log non-winning positive scores too - Moved above</span>
                <span class="c1"># Only add if not already present (first positive score encountered)</span>
                <span class="c1"># scores.setdefault(unit_cls.__name__, score)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.matches for </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Log error in scores dict</span>

        <span class="c1"># Sort scores for clearer logging (highest first)</span>
        <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Scores for </span><span class="si">{</span><span class="n">original_type_for_cache</span><span class="si">}</span><span class="s2"> (unwrapped: </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">field_info</span><span class="si">=}</span><span class="s2">): </span><span class="si">{</span><span class="n">sorted_scores</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">best_unit</span><span class="p">:</span>  <span class="c1"># Added logging</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected best unit: </span><span class="si">{</span><span class="n">best_unit</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">highest_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Added logging</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Added logging</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No best unit found based on scoring.&quot;</span><span class="p">)</span>  <span class="c1"># Added logging</span>

        <span class="c1"># --- Handle Fallbacks (Collections/Any) --- #</span>
        <span class="k">if</span> <span class="n">best_unit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">highest_score</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Re-evaluating fallback/handling for </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">unwrapped_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>
            <span class="n">unwrapped_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_to_match</span><span class="p">)</span>

            <span class="c1"># 1. Check standard collections first (MOVED FROM TOP)</span>
            <span class="k">if</span> <span class="n">unwrapped_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="n">type_to_match</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="c1"># Re-check list/set here to ensure it wasn&#39;t a list of known models handled above</span>
                <span class="k">if</span> <span class="n">unwrapped_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unwrapped_args</span><span class="p">:</span>
                    <span class="n">inner_type</span> <span class="o">=</span> <span class="n">unwrapped_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_list_of_known_models_fallback</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">))</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">is_list_of_known_models_fallback</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_list_of_known_models_fallback</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> is a non-model collection, selecting JsonFieldMapping.&quot;</span><span class="p">)</span>
                        <span class="n">best_unit</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                    <span class="c1"># else: It was a list of known models, should have been handled earlier. Log warning?</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List of known models </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> reached fallback logic unexpectedly.&quot;</span><span class="p">)</span>
                        <span class="c1"># Default to M2M as a safe bet?</span>
                        <span class="n">best_unit</span> <span class="o">=</span> <span class="n">ManyToManyFieldMapping</span>
                <span class="c1"># Handle dict/tuple</span>
                <span class="k">elif</span> <span class="n">unwrapped_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="n">type_to_match</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2"> is a dict/tuple collection, selecting JsonFieldMapping.&quot;</span><span class="p">)</span>
                    <span class="n">best_unit</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
            <span class="c1"># 2. Check for Any</span>
            <span class="k">elif</span> <span class="n">type_to_match</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Type is Any, selecting JsonFieldMapping.&quot;</span><span class="p">)</span>
                <span class="n">best_unit</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>

        <span class="c1"># Final Logging</span>
        <span class="k">if</span> <span class="n">best_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No specific mapping unit found for Python type: </span><span class="si">{</span><span class="n">original_type_for_cache</span><span class="si">}</span><span class="s2"> (unwrapped to </span><span class="si">{</span><span class="n">type_to_match</span><span class="si">}</span><span class="s2">) with field_info: </span><span class="si">{</span><span class="n">field_info</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Log cache state before potential fallback write</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache keys before fallback write: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Re-enable cache write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_unit</span>  <span class="c1"># Cache using original key</span>
        <span class="k">return</span> <span class="n">best_unit</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_unit_for_django_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">TypeMappingUnit</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the most specific mapping unit based on Django field type MRO and registry order.&quot;&quot;&quot;</span>
        <span class="c1"># Revert to simpler single pass using refined registry order.</span>
        <span class="k">if</span> <span class="n">dj_field_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_django_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_django_cache</span><span class="p">[</span><span class="n">dj_field_type</span><span class="p">]</span>

        <span class="c1"># Filter registry to exclude EnumFieldMapping unless it&#39;s specifically needed? No, registry order handles it.</span>
        <span class="c1"># Ensure EnumFieldMapping isn&#39;t incorrectly picked before Str/Int if choices are present.</span>
        <span class="c1"># The registry order should have Str/Int base mappings *after* EnumFieldMapping if EnumFieldMapping</span>
        <span class="c1"># only maps Enum/Literal python types. But dj_field_type matching is different.</span>
        <span class="c1"># If a CharField has choices, we want EnumFieldMapping logic, not StrFieldMapping.</span>
        <span class="n">registry_for_django</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span>  <span class="c1"># Use the full registry for now</span>

        <span class="k">for</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="n">registry_for_django</span><span class="p">:</span>
            <span class="c1"># Special check: If field has choices, prioritize EnumFieldMapping if applicable type</span>
            <span class="c1"># This is handled by get_pydantic_mapping logic already, not needed here.</span>

            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dj_field_type</span><span class="p">,</span> <span class="n">unit_cls</span><span class="o">.</span><span class="n">django_field_type</span><span class="p">):</span>
                <span class="c1"># Found the first, most specific match based on registry order</span>
                <span class="c1"># Example: PositiveIntegerField is subclass of IntegerField. If PositiveIntFieldMapping</span>
                <span class="c1"># comes first in registry, it will be matched correctly.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_django_cache</span><span class="p">[</span><span class="n">dj_field_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_cls</span>
                <span class="k">return</span> <span class="n">unit_cls</span>

        <span class="c1"># Fallback if no unit explicitly handles it (should be rare)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No specific mapping unit found for Django field type: </span><span class="si">{</span><span class="n">dj_field_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, check registry order.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_django_cache</span><span class="p">[</span><span class="n">dj_field_type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_django_mapping</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">python_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">parent_pydantic_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add parent model for self-ref check</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the corresponding Django Field type and constructor kwargs for a Python type.&quot;&quot;&quot;</span>
        <span class="n">processed_type_info</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">process_field_type</span><span class="p">(</span><span class="n">python_type</span><span class="p">)</span>
        <span class="n">original_py_type</span> <span class="o">=</span> <span class="n">python_type</span>
        <span class="n">is_optional</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;is_optional&quot;</span><span class="p">]</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;is_list&quot;</span><span class="p">]</span>

        <span class="n">unit_cls</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize unit_cls</span>
        <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>  <span class="c1"># Start with original</span>
        <span class="n">union_details</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store details if it&#39;s a Union[BaseModel,...]</span>
        <span class="n">gfk_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># --- Check for M2M case FIRST ---</span>
        <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
            <span class="c1"># Get the type inside the list, handling Optional[List[T]]</span>
            <span class="n">list_inner_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
            <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
                <span class="n">args_check</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">list_inner_type</span><span class="p">)</span>
                <span class="n">list_inner_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args_check</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="n">Any</span><span class="p">)</span>

            <span class="c1"># Now get the type *inside* the list</span>
            <span class="n">list_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">list_inner_type</span><span class="p">)</span>  <span class="c1"># Should be List[T]</span>
            <span class="n">inner_type</span> <span class="o">=</span> <span class="n">list_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">list_args</span> <span class="k">else</span> <span class="n">Any</span>

            <span class="c1"># --- GFK Check: Is the inner type a Union of known models? ---</span>
            <span class="n">inner_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
            <span class="n">inner_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inner_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inner_args</span><span class="p">:</span>
                <span class="n">union_models</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">other_types</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">arg</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inner_args</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                        <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">]</span>
                <span class="n">union_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inner_args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_types</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">union_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_types</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected GFK List[Union[...]] with models: </span><span class="si">{</span><span class="n">union_models</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">gfk_details</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;gfk&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">union_models</span><span class="p">,</span>
                        <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                    <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>

            <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># --- M2M Check: Is the inner type a known related BaseModel OR Dataclass? ---</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">ManyToManyFieldMapping</span>
                    <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">inner_type</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected List[RelatedModel] (</span><span class="si">{</span><span class="n">inner_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">), mapping to ManyToManyField.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># --- Fallback for other lists ---</span>
                    <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                    <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected List of non-models (</span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">), mapping directly to JSONField.&quot;</span><span class="p">)</span>

        <span class="c1"># --- If not a list, find unit for the base (non-list) type ---</span>
        <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># --- Handle Union[BaseModel,...] Signaling FIRST --- #</span>
            <span class="n">simplified_base_type</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;type_obj&quot;</span><span class="p">]</span>
            <span class="n">simplified_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">simplified_base_type</span><span class="p">)</span>
            <span class="n">simplified_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">simplified_base_type</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Checking simplified type for Union[Model,...]: </span><span class="si">{</span><span class="n">simplified_base_type</span><span class="si">!r}</span><span class="s2"> (Origin: </span><span class="si">{</span><span class="n">simplified_origin</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Log the is_optional flag determined by TypeHandler</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TypeHandler returned is_optional: </span><span class="si">{</span><span class="n">is_optional</span><span class="si">}</span><span class="s2"> for original type: </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Check if the simplified origin is Union[...] or T | U</span>
            <span class="k">if</span> <span class="n">simplified_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">simplified_args</span><span class="p">:</span>
                <span class="n">union_models</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">other_types_in_union</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">simplified_args</span><span class="p">:</span>
                    <span class="c1"># We already unwrapped Optional, so no need to check for NoneType here</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Checking simplified Union arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Check if arg is a known BaseModel or Dataclass</span>
                    <span class="n">is_class</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="c1"># Need try-except for issubclass with non-class types</span>
                    <span class="n">is_pyd_model</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">is_dc</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">is_known_by_accessor</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">is_class</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_pyd_model</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                            <span class="n">is_dc</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                            <span class="c1"># Only check accessor if it&#39;s a model type</span>
                            <span class="k">if</span> <span class="n">is_pyd_model</span> <span class="ow">or</span> <span class="n">is_dc</span><span class="p">:</span>
                                <span class="n">is_known_by_accessor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="c1"># issubclass might fail if arg is not a class (e.g., a type alias)</span>
                            <span class="k">pass</span>  <span class="c1"># Keep flags as False</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;    is_class: </span><span class="si">{</span><span class="n">is_class</span><span class="si">}</span><span class="s2">, is_pyd_model: </span><span class="si">{</span><span class="n">is_pyd_model</span><span class="si">}</span><span class="s2">, is_dc: </span><span class="si">{</span><span class="n">is_dc</span><span class="si">}</span><span class="s2">, is_known_by_accessor: </span><span class="si">{</span><span class="n">is_known_by_accessor</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                    <span class="n">is_known_model_or_dc</span> <span class="o">=</span> <span class="n">is_class</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_pyd_model</span> <span class="ow">or</span> <span class="n">is_dc</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_known_by_accessor</span>

                    <span class="k">if</span> <span class="n">is_known_model_or_dc</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Added </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> to union_models&quot;</span><span class="p">)</span>  <span class="c1"># More specific logging</span>
                        <span class="n">union_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Make sure we don&#39;t add NoneType here if Optional wasn&#39;t fully handled upstream somehow</span>
                        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Added </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2"> to other_types_in_union&quot;</span><span class="p">)</span>  <span class="c1"># More specific logging</span>
                            <span class="n">other_types_in_union</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                <span class="c1"># --- EDIT: Only set union_details IF ONLY models were found ---</span>
                <span class="c1"># Add logging just before the check</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Finished Union arg loop. union_models: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">union_models</span><span class="p">]</span><span class="si">}</span><span class="s2">, other_types: </span><span class="si">{</span><span class="n">other_types_in_union</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">union_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_types_in_union</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected Union containing ONLY known models: </span><span class="si">{</span><span class="n">union_models</span><span class="si">}</span><span class="s2">. Generating _union_details signal.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">union_details</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;multi_fk&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">union_models</span><span class="p">,</span>
                        <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>  <span class="c1"># Use the flag determined earlier</span>
                    <span class="p">}</span>
                    <span class="c1"># Log the created union_details</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated union_details: </span><span class="si">{</span><span class="n">union_details</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Set unit_cls to JsonFieldMapping for model unions</span>
                    <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                    <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting unit_cls to JsonFieldMapping for model union&quot;</span><span class="p">)</span>

            <span class="c1"># --- Now, find the unit for the (potentially complex) base type --- #</span>
            <span class="c1"># Only find unit if not already set (e.g. by model union handling)</span>
            <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Determine the type to use for finding the unit.</span>
                <span class="c1"># If it was M2M or handled List, unit_cls is already set.</span>
                <span class="c1"># Otherwise, use the processed type_obj which handles Optional/Annotated.</span>
                <span class="n">type_for_unit_finding</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;type_obj&quot;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type used for finding unit (after Union check): </span><span class="si">{</span><span class="n">type_for_unit_finding</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Use the simplified base type after processing Optional/Annotated</span>
                <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">type_for_unit_finding</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding unit for base type: </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">!r}</span><span class="s2"> with field_info: </span><span class="si">{</span><span class="n">field_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">unit_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_unit_for_pydantic_type</span><span class="p">(</span><span class="n">base_py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>

        <span class="c1"># --- Check if a unit was found --- #</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_cls</span><span class="p">:</span>
            <span class="c1"># If _find_unit_for_pydantic_type returned None, fallback to JSON</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No mapping unit found by scoring for base type </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(derived from </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">), falling back to JSONField.&quot;</span>
            <span class="p">)</span>
            <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
            <span class="c1"># Consider raising MappingError if even JSON doesn&#39;t fit?</span>
            <span class="c1"># raise MappingError(f&quot;Could not find mapping unit for Python type: {base_py_type}&quot;)</span>

        <span class="c1"># &gt;&gt; Add logging to check selected unit &lt;&lt;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected Unit for </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unit_cls</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">instance_unit</span> <span class="o">=</span> <span class="n">unit_cls</span><span class="p">()</span>  <span class="c1"># Instantiate to call methods</span>

        <span class="c1"># --- Determine Django Field Type ---</span>
        <span class="c1"># Start with the type defined on the selected unit class</span>
        <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">django_field_type</span>

        <span class="c1"># --- Get Kwargs (before potentially overriding field type for Enums) ---</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">pydantic_to_django_kwargs</span><span class="p">(</span><span class="n">base_py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>

        <span class="c1"># --- Add Union or GFK Details if applicable --- #</span>
        <span class="k">if</span> <span class="n">union_details</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding _union_details to kwargs.&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_union_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_optional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_optional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gfk_details</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding _gfk_details to kwargs.&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfk_details</span>
            <span class="c1"># GFK fields are placeholder JSONFields, nullability is based on Optional status</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;union_details and gfk_details are None, skipping addition to kwargs.&quot;</span><span class="p">)</span>
            <span class="c1"># --- Special Handling for Enums/Literals (Only if not multi-FK/GFK union) --- #</span>
            <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="n">EnumFieldMapping</span><span class="p">:</span>
                <span class="n">field_type_hint</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_field_type_hint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field_type_hint</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type_hint</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type_hint</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
                    <span class="c1"># Directly use the hinted field type if valid</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Using hinted field type </span><span class="si">{</span><span class="n">field_type_hint</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> from EnumFieldMapping for </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">field_type_hint</span>
                    <span class="c1"># Ensure max_length is removed if type becomes IntegerField</span>
                    <span class="k">if</span> <span class="n">django_field_type</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;EnumFieldMapping selected but failed to get valid field type hint from kwargs.&quot;</span><span class="p">)</span>

            <span class="c1"># --- Handle Relationships (Only if not multi-FK union) --- #</span>
            <span class="c1"># This section needs to run *after* unit selection but *before* final nullability checks</span>
            <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">,</span> <span class="n">ManyToManyFieldMapping</span><span class="p">):</span>
                <span class="c1"># Ensure base_py_type is the related model (set during M2M check or found by find_unit for FK/O2O)</span>
                <span class="n">related_py_model</span> <span class="o">=</span> <span class="n">base_py_type</span>

                <span class="c1"># Check if it&#39;s a known Pydantic BaseModel OR a known Dataclass</span>
                <span class="n">is_pyd_or_dc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pyd_or_dc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Relationship mapping unit </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> selected, but base type </span><span class="si">{</span><span class="n">related_py_model</span><span class="si">}</span><span class="s2"> is not a known Pydantic model or Dataclass.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Check for self-reference BEFORE trying to get the Django model</span>
                <span class="n">is_self_ref</span> <span class="o">=</span> <span class="n">parent_pydantic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">related_py_model</span> <span class="o">==</span> <span class="n">parent_pydantic_model</span>

                <span class="k">if</span> <span class="n">is_self_ref</span><span class="p">:</span>
                    <span class="n">model_ref</span> <span class="o">=</span> <span class="s2">&quot;self&quot;</span>
                    <span class="c1"># Get the target Django model name for logging/consistency if possible, but use &#39;self&#39;</span>
                    <span class="c1"># Check if the related model is a Pydantic BaseModel or a dataclass</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                        <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                            <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">related_py_model</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">):</span>
                        <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_dataclass</span><span class="p">(</span>
                            <span class="n">related_py_model</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This case should ideally not be reached due to earlier checks, but handle defensively</span>
                        <span class="n">target_django_model</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Self-reference check: related_py_model &#39;</span><span class="si">{</span><span class="n">related_py_model</span><span class="si">}</span><span class="s2">&#39; is neither BaseModel nor dataclass.&quot;</span>
                        <span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Detected self-reference for </span><span class="si">{</span><span class="n">related_py_model</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">related_py_model</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;(Django: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">target_django_model</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">), using &#39;self&#39;.&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get target Django model based on source type (Pydantic or Dataclass)</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># Ensure related_py_model is actually a type before issubclass check</span>
                    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                        <span class="c1"># Cast to satisfy type checker, as we&#39;ve confirmed it&#39;s a BaseModel subclass here</span>
                        <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                            <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">related_py_model</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">):</span>
                        <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_dataclass</span><span class="p">(</span>
                            <span class="n">related_py_model</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_django_model</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Cannot map relationship: No corresponding Django model found for source model &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">related_py_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> in RelationshipConversionAccessor.&quot;</span>
                        <span class="p">)</span>
                    <span class="c1"># Use lowercase label for internal consistency with existing expectations</span>
                    <span class="n">model_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_django_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;label_lower&quot;</span><span class="p">,</span> <span class="n">target_django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_ref</span>
                <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">unit_cls</span><span class="o">.</span><span class="n">django_field_type</span>  <span class="c1"># Re-confirm M2MField, FK, O2O type</span>
                <span class="c1"># Set on_delete for FK/O2O based on Optional status</span>
                <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">):</span>
                    <span class="c1"># Default to CASCADE for non-optional, SET_NULL for optional (matching test expectation)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
                    <span class="p">)</span>  <span class="c1"># Changed PROTECT to CASCADE</span>

        <span class="c1"># --- Final Adjustments (Nullability, etc.) --- #</span>
        <span class="c1"># Apply nullability. M2M fields cannot be null in Django.</span>
        <span class="c1"># Do not override nullability if it was already forced by a multi-FK union</span>
        <span class="k">if</span> <span class="n">django_field_type</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">union_details</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
            <span class="c1"># Explicitly set blank based on optionality.</span>
            <span class="c1"># Simplified logic: Mirror the null assignment directly</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;FINAL RETURN from get_django_mapping: Type=</span><span class="si">{</span><span class="n">django_field_type</span><span class="si">}</span><span class="s2">, Kwargs=</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>  <span class="c1"># Added final state logging</span>
        <span class="k">return</span> <span class="n">django_field_type</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pydantic_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the corresponding Pydantic type hint and FieldInfo kwargs for a Django Field.&quot;&quot;&quot;</span>
        <span class="n">dj_field_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span>
        <span class="n">is_optional</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">null</span>
        <span class="n">is_choices</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>

        <span class="c1"># --- Find base unit (ignoring choices for now) ---</span>
        <span class="c1"># Find the mapping unit based on the specific Django field type MRO</span>
        <span class="c1"># This gives us the correct underlying Python type (str, int, etc.)</span>
        <span class="n">base_unit_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_unit_for_django_field</span><span class="p">(</span><span class="n">dj_field_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_unit_cls</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No base mapping unit for </span><span class="si">{</span><span class="n">dj_field_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, falling back to Any.&quot;</span><span class="p">)</span>
            <span class="n">pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">Any</span>
            <span class="k">return</span> <span class="n">pydantic_type</span><span class="p">,</span> <span class="p">{}</span>

        <span class="n">base_instance_unit</span> <span class="o">=</span> <span class="n">base_unit_cls</span><span class="p">()</span>
        <span class="c1"># Get the base Pydantic type from this unit</span>
        <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>

        <span class="c1"># --- Determine Final Pydantic Type Adjustments --- #</span>
        <span class="c1"># (Relationships, AutoPK, Optional wrapper)</span>

        <span class="c1"># Handle choices FIRST to determine the core type before Optional wrapping</span>
        <span class="k">if</span> <span class="n">is_choices</span><span class="p">:</span>
            <span class="c1"># Default to base type, override if valid choices found</span>
            <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>
            <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>  <span class="c1"># Explicit check before iteration</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">choice_values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">choice_values</span><span class="p">:</span>  <span class="c1"># Ensure the tuple is not empty</span>
                        <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="n">choice_values</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped choices for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to Pydantic type: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has choices defined, but extracted values are empty. Falling back.&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Keep final_pydantic_type as base type</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract choices for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Falling back.&quot;</span><span class="p">)</span>
                    <span class="c1"># Keep final_pydantic_type as base type</span>
            <span class="c1"># If dj_field.choices was None/empty initially, final_pydantic_type remains the base type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get the base Pydantic type from this unit if not choices</span>
            <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>

        <span class="c1"># 1. Handle Relationships first, as they determine the core type</span>
        <span class="k">if</span> <span class="n">base_unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">,</span> <span class="n">ManyToManyFieldMapping</span><span class="p">):</span>
            <span class="n">related_dj_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;related_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">related_dj_model</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine related Django model for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Resolve &#39;self&#39; reference</span>
            <span class="k">if</span> <span class="n">related_dj_model</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="c1"># We need the Django model class that dj_field belongs to.</span>
                <span class="c1"># This info isn&#39;t directly passed, so this approach might be limited.</span>
                <span class="c1"># Assuming self-reference points to the same type hierarchy for now.</span>
                <span class="c1"># A better solution might need the model context passed down.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Handling &#39;self&#39; reference for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Mapping might be incomplete without parent model context.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Attempt to get Pydantic model mapped to the field&#39;s owner model if possible (heuristically)</span>
                <span class="c1"># This is complex and potentially fragile.</span>
                <span class="c1"># For now, let&#39;s use a placeholder or raise an error if needed strictly.</span>
                <span class="c1"># Sticking with the base type (e.g., Any or int for PK) might be safer without context.</span>
                <span class="c1"># Use the base type (likely PK int/uuid) as the fallback type here</span>
                <span class="n">target_pydantic_model</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Any as placeholder for &#39;self&#39; reference &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_pydantic_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_pydantic_model_for_django</span><span class="p">(</span><span class="n">related_dj_model</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pydantic_model</span> <span class="ow">or</span> <span class="n">target_pydantic_model</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">related_dj_model</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>  <span class="c1"># Avoid redundant warning for self</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot map relationship: No corresponding Pydantic model found for Django model &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">related_dj_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">label</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">related_dj_model</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_meta&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">related_dj_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Using placeholder &#39;</span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Keep final_pydantic_type as the base unit&#39;s python_type (e.g., int for FK)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">base_unit_cls</span> <span class="o">==</span> <span class="n">ManyToManyFieldMapping</span><span class="p">:</span>
                    <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">target_pydantic_model</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># FK or O2O</span>
                    <span class="c1"># Keep the PK type (e.g., int) if target model not found,</span>
                    <span class="c1"># otherwise use the target Pydantic model type.</span>
                    <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">target_pydantic_model</span>  <span class="c1"># This should now be the related model type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped relationship field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to Pydantic type: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2. AutoPK override (after relationship resolution)</span>
        <span class="n">is_auto_pk</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">dj_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BigAutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallAutoField</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_auto_pk</span><span class="p">:</span>
            <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped AutoPK field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># AutoPKs are always optional in Pydantic input</span>

        <span class="c1"># 3. Apply Optional[...] wrapper if necessary (AFTER relationship/AutoPK)</span>
        <span class="c1"># Do not wrap M2M lists or already Optional AutoPKs in Optional[] again.</span>
        <span class="c1"># Also, don&#39;t wrap if the type is already Literal (choices handled Optionality) - NO, wrap Literal too if null=True</span>
        <span class="k">if</span> <span class="n">is_optional</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_auto_pk</span><span class="p">:</span>  <span class="c1"># Check if is_choices? No, optional applies to literal too.</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">final_pydantic_type</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">final_pydantic_type</span><span class="p">)</span>
            <span class="n">is_already_optional</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Optional</span> <span class="ow">or</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">UnionType</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_already_optional</span><span class="p">:</span>
                <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">final_pydantic_type</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrapped type for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in Optional: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Generate FieldInfo Kwargs --- #</span>
        <span class="c1"># Use EnumFieldMapping logic for kwargs ONLY if choices exist,</span>
        <span class="c1"># otherwise use the base unit determined earlier. # --&gt; NO, always use base unit for kwargs now. Literal type handles choices.</span>
        <span class="c1"># kwargs_unit_cls = EnumFieldMapping if is_choices else base_unit_cls # OLD logic</span>
        <span class="n">instance_unit</span> <span class="o">=</span> <span class="n">base_unit_cls</span><span class="p">()</span>  <span class="c1"># Use the base unit (e.g., StrFieldMapping) for base kwargs</span>

        <span class="n">field_info_kwargs</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">django_to_pydantic_field_info_kwargs</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span>

        <span class="c1"># --- Explicitly cast title (verbose_name) and description (help_text) --- #</span>
        <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensured title is str for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensured description is str for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># --- End Casting --- #</span>

        <span class="c1"># --- Keep choices in json_schema_extra even when using Literal ---</span>
        <span class="c1"># This preserves the (value, label) mapping as metadata alongside the Literal type.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">is_choices</span>
            <span class="ow">and</span> <span class="s2">&quot;json_schema_extra&quot;</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span>
            <span class="ow">and</span> <span class="s2">&quot;choices&quot;</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kept choices in json_schema_extra for Literal field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_choices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has choices, but they weren&#39;t added to json_schema_extra by the mapping unit.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Clean up redundant `default=None` for Optional fields handled by Pydantic v2.</span>
        <span class="c1"># Do not force-add default=None; only keep explicit defaults (e.g., for AutoPK).</span>
        <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_auto_pk</span><span class="p">:</span>
                <span class="c1"># Remove implicit default=None for Optional fields</span>
                <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed redundant default=None for Optional field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">is_auto_pk</span> <span class="ow">and</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span><span class="p">:</span>
                <span class="c1"># Keep default=None for AutoPK if not already set</span>
                <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set default=None for AutoPK Optional field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Final Pydantic mapping for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: Type=</span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">, Kwargs=</span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">final_pydantic_type</span><span class="p">,</span> <span class="n">field_info_kwargs</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_django_mapping" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_django_mapping</span><span class="p">(</span><span class="n">python_type</span><span class="p">,</span> <span class="n">field_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_pydantic_model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_django_mapping" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the corresponding Django Field type and constructor kwargs for a Python type.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/bidirectional_mapper.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_django_mapping</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">python_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">parent_pydantic_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add parent model for self-ref check</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the corresponding Django Field type and constructor kwargs for a Python type.&quot;&quot;&quot;</span>
    <span class="n">processed_type_info</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">process_field_type</span><span class="p">(</span><span class="n">python_type</span><span class="p">)</span>
    <span class="n">original_py_type</span> <span class="o">=</span> <span class="n">python_type</span>
    <span class="n">is_optional</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;is_optional&quot;</span><span class="p">]</span>
    <span class="n">is_list</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;is_list&quot;</span><span class="p">]</span>

    <span class="n">unit_cls</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize unit_cls</span>
    <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>  <span class="c1"># Start with original</span>
    <span class="n">union_details</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Store details if it&#39;s a Union[BaseModel,...]</span>
    <span class="n">gfk_details</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># --- Check for M2M case FIRST ---</span>
    <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
        <span class="c1"># Get the type inside the list, handling Optional[List[T]]</span>
        <span class="n">list_inner_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
        <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
            <span class="n">args_check</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">list_inner_type</span><span class="p">)</span>
            <span class="n">list_inner_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args_check</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span> <span class="n">Any</span><span class="p">)</span>

        <span class="c1"># Now get the type *inside* the list</span>
        <span class="n">list_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">list_inner_type</span><span class="p">)</span>  <span class="c1"># Should be List[T]</span>
        <span class="n">inner_type</span> <span class="o">=</span> <span class="n">list_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">list_args</span> <span class="k">else</span> <span class="n">Any</span>

        <span class="c1"># --- GFK Check: Is the inner type a Union of known models? ---</span>
        <span class="n">inner_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
        <span class="n">inner_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inner_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inner_args</span><span class="p">:</span>
            <span class="n">union_models</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">other_types</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">arg</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inner_args</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">union_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inner_args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_types</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">union_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_types</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected GFK List[Union[...]] with models: </span><span class="si">{</span><span class="n">union_models</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">gfk_details</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;gfk&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">union_models</span><span class="p">,</span>
                    <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>

        <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># --- M2M Check: Is the inner type a known related BaseModel OR Dataclass? ---</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">inner_type</span><span class="p">))</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">inner_type</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">ManyToManyFieldMapping</span>
                <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">inner_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected List[RelatedModel] (</span><span class="si">{</span><span class="n">inner_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">), mapping to ManyToManyField.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># --- Fallback for other lists ---</span>
                <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected List of non-models (</span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">), mapping directly to JSONField.&quot;</span><span class="p">)</span>

    <span class="c1"># --- If not a list, find unit for the base (non-list) type ---</span>
    <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># --- Handle Union[BaseModel,...] Signaling FIRST --- #</span>
        <span class="n">simplified_base_type</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;type_obj&quot;</span><span class="p">]</span>
        <span class="n">simplified_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">simplified_base_type</span><span class="p">)</span>
        <span class="n">simplified_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">simplified_base_type</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Checking simplified type for Union[Model,...]: </span><span class="si">{</span><span class="n">simplified_base_type</span><span class="si">!r}</span><span class="s2"> (Origin: </span><span class="si">{</span><span class="n">simplified_origin</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Log the is_optional flag determined by TypeHandler</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TypeHandler returned is_optional: </span><span class="si">{</span><span class="n">is_optional</span><span class="si">}</span><span class="s2"> for original type: </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check if the simplified origin is Union[...] or T | U</span>
        <span class="k">if</span> <span class="n">simplified_origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">simplified_args</span><span class="p">:</span>
            <span class="n">union_models</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">other_types_in_union</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">simplified_args</span><span class="p">:</span>
                <span class="c1"># We already unwrapped Optional, so no need to check for NoneType here</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-- Checking simplified Union arg: </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Check if arg is a known BaseModel or Dataclass</span>
                <span class="n">is_class</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="c1"># Need try-except for issubclass with non-class types</span>
                <span class="n">is_pyd_model</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_dc</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">is_known_by_accessor</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">is_class</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_pyd_model</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                        <span class="n">is_dc</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="c1"># Only check accessor if it&#39;s a model type</span>
                        <span class="k">if</span> <span class="n">is_pyd_model</span> <span class="ow">or</span> <span class="n">is_dc</span><span class="p">:</span>
                            <span class="n">is_known_by_accessor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="c1"># issubclass might fail if arg is not a class (e.g., a type alias)</span>
                        <span class="k">pass</span>  <span class="c1"># Keep flags as False</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;    is_class: </span><span class="si">{</span><span class="n">is_class</span><span class="si">}</span><span class="s2">, is_pyd_model: </span><span class="si">{</span><span class="n">is_pyd_model</span><span class="si">}</span><span class="s2">, is_dc: </span><span class="si">{</span><span class="n">is_dc</span><span class="si">}</span><span class="s2">, is_known_by_accessor: </span><span class="si">{</span><span class="n">is_known_by_accessor</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">is_known_model_or_dc</span> <span class="o">=</span> <span class="n">is_class</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_pyd_model</span> <span class="ow">or</span> <span class="n">is_dc</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_known_by_accessor</span>

                <span class="k">if</span> <span class="n">is_known_model_or_dc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Added </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> to union_models&quot;</span><span class="p">)</span>  <span class="c1"># More specific logging</span>
                    <span class="n">union_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Make sure we don&#39;t add NoneType here if Optional wasn&#39;t fully handled upstream somehow</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    -&gt; Added </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2"> to other_types_in_union&quot;</span><span class="p">)</span>  <span class="c1"># More specific logging</span>
                        <span class="n">other_types_in_union</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

            <span class="c1"># --- EDIT: Only set union_details IF ONLY models were found ---</span>
            <span class="c1"># Add logging just before the check</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Finished Union arg loop. union_models: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">union_models</span><span class="p">]</span><span class="si">}</span><span class="s2">, other_types: </span><span class="si">{</span><span class="n">other_types_in_union</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">union_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">other_types_in_union</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Detected Union containing ONLY known models: </span><span class="si">{</span><span class="n">union_models</span><span class="si">}</span><span class="s2">. Generating _union_details signal.&quot;</span>
                <span class="p">)</span>
                <span class="n">union_details</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;multi_fk&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;models&quot;</span><span class="p">:</span> <span class="n">union_models</span><span class="p">,</span>
                    <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>  <span class="c1"># Use the flag determined earlier</span>
                <span class="p">}</span>
                <span class="c1"># Log the created union_details</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated union_details: </span><span class="si">{</span><span class="n">union_details</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Set unit_cls to JsonFieldMapping for model unions</span>
                <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
                <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">original_py_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting unit_cls to JsonFieldMapping for model union&quot;</span><span class="p">)</span>

        <span class="c1"># --- Now, find the unit for the (potentially complex) base type --- #</span>
        <span class="c1"># Only find unit if not already set (e.g. by model union handling)</span>
        <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Determine the type to use for finding the unit.</span>
            <span class="c1"># If it was M2M or handled List, unit_cls is already set.</span>
            <span class="c1"># Otherwise, use the processed type_obj which handles Optional/Annotated.</span>
            <span class="n">type_for_unit_finding</span> <span class="o">=</span> <span class="n">processed_type_info</span><span class="p">[</span><span class="s2">&quot;type_obj&quot;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type used for finding unit (after Union check): </span><span class="si">{</span><span class="n">type_for_unit_finding</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Use the simplified base type after processing Optional/Annotated</span>
            <span class="n">base_py_type</span> <span class="o">=</span> <span class="n">type_for_unit_finding</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finding unit for base type: </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">!r}</span><span class="s2"> with field_info: </span><span class="si">{</span><span class="n">field_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">unit_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_unit_for_pydantic_type</span><span class="p">(</span><span class="n">base_py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>

    <span class="c1"># --- Check if a unit was found --- #</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_cls</span><span class="p">:</span>
        <span class="c1"># If _find_unit_for_pydantic_type returned None, fallback to JSON</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No mapping unit found by scoring for base type </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(derived from </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">), falling back to JSONField.&quot;</span>
        <span class="p">)</span>
        <span class="n">unit_cls</span> <span class="o">=</span> <span class="n">JsonFieldMapping</span>
        <span class="c1"># Consider raising MappingError if even JSON doesn&#39;t fit?</span>
        <span class="c1"># raise MappingError(f&quot;Could not find mapping unit for Python type: {base_py_type}&quot;)</span>

    <span class="c1"># &gt;&gt; Add logging to check selected unit &lt;&lt;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected Unit for </span><span class="si">{</span><span class="n">original_py_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unit_cls</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">instance_unit</span> <span class="o">=</span> <span class="n">unit_cls</span><span class="p">()</span>  <span class="c1"># Instantiate to call methods</span>

    <span class="c1"># --- Determine Django Field Type ---</span>
    <span class="c1"># Start with the type defined on the selected unit class</span>
    <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">django_field_type</span>

    <span class="c1"># --- Get Kwargs (before potentially overriding field type for Enums) ---</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">pydantic_to_django_kwargs</span><span class="p">(</span><span class="n">base_py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>

    <span class="c1"># --- Add Union or GFK Details if applicable --- #</span>
    <span class="k">if</span> <span class="n">union_details</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding _union_details to kwargs.&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_union_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_optional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_optional&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">gfk_details</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding _gfk_details to kwargs.&quot;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gfk_details</span>
        <span class="c1"># GFK fields are placeholder JSONFields, nullability is based on Optional status</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;union_details and gfk_details are None, skipping addition to kwargs.&quot;</span><span class="p">)</span>
        <span class="c1"># --- Special Handling for Enums/Literals (Only if not multi-FK/GFK union) --- #</span>
        <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">is</span> <span class="n">EnumFieldMapping</span><span class="p">:</span>
            <span class="n">field_type_hint</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_field_type_hint&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_type_hint</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_type_hint</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">field_type_hint</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
                <span class="c1"># Directly use the hinted field type if valid</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Using hinted field type </span><span class="si">{</span><span class="n">field_type_hint</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> from EnumFieldMapping for </span><span class="si">{</span><span class="n">base_py_type</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">field_type_hint</span>
                <span class="c1"># Ensure max_length is removed if type becomes IntegerField</span>
                <span class="k">if</span> <span class="n">django_field_type</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;EnumFieldMapping selected but failed to get valid field type hint from kwargs.&quot;</span><span class="p">)</span>

        <span class="c1"># --- Handle Relationships (Only if not multi-FK union) --- #</span>
        <span class="c1"># This section needs to run *after* unit selection but *before* final nullability checks</span>
        <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">,</span> <span class="n">ManyToManyFieldMapping</span><span class="p">):</span>
            <span class="c1"># Ensure base_py_type is the related model (set during M2M check or found by find_unit for FK/O2O)</span>
            <span class="n">related_py_model</span> <span class="o">=</span> <span class="n">base_py_type</span>

            <span class="c1"># Check if it&#39;s a known Pydantic BaseModel OR a known Dataclass</span>
            <span class="n">is_pyd_or_dc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_pyd_or_dc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Relationship mapping unit </span><span class="si">{</span><span class="n">unit_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> selected, but base type </span><span class="si">{</span><span class="n">related_py_model</span><span class="si">}</span><span class="s2"> is not a known Pydantic model or Dataclass.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check for self-reference BEFORE trying to get the Django model</span>
            <span class="n">is_self_ref</span> <span class="o">=</span> <span class="n">parent_pydantic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">related_py_model</span> <span class="o">==</span> <span class="n">parent_pydantic_model</span>

            <span class="k">if</span> <span class="n">is_self_ref</span><span class="p">:</span>
                <span class="n">model_ref</span> <span class="o">=</span> <span class="s2">&quot;self&quot;</span>
                <span class="c1"># Get the target Django model name for logging/consistency if possible, but use &#39;self&#39;</span>
                <span class="c1"># Check if the related model is a Pydantic BaseModel or a dataclass</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">related_py_model</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">):</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_dataclass</span><span class="p">(</span>
                        <span class="n">related_py_model</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This case should ideally not be reached due to earlier checks, but handle defensively</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Self-reference check: related_py_model &#39;</span><span class="si">{</span><span class="n">related_py_model</span><span class="si">}</span><span class="s2">&#39; is neither BaseModel nor dataclass.&quot;</span>
                    <span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Detected self-reference for </span><span class="si">{</span><span class="n">related_py_model</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">related_py_model</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(Django: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">target_django_model</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">), using &#39;self&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get target Django model based on source type (Pydantic or Dataclass)</span>
                <span class="n">target_django_model</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Ensure related_py_model is actually a type before issubclass check</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                    <span class="c1"># Cast to satisfy type checker, as we&#39;ve confirmed it&#39;s a BaseModel subclass here</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_pydantic</span><span class="p">(</span>
                        <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">related_py_model</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">related_py_model</span><span class="p">):</span>
                    <span class="n">target_django_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_django_model_for_dataclass</span><span class="p">(</span>
                        <span class="n">related_py_model</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">target_django_model</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot map relationship: No corresponding Django model found for source model &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">related_py_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> in RelationshipConversionAccessor.&quot;</span>
                    <span class="p">)</span>
                <span class="c1"># Use lowercase label for internal consistency with existing expectations</span>
                <span class="n">model_ref</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_django_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;label_lower&quot;</span><span class="p">,</span> <span class="n">target_django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_ref</span>
            <span class="n">django_field_type</span> <span class="o">=</span> <span class="n">unit_cls</span><span class="o">.</span><span class="n">django_field_type</span>  <span class="c1"># Re-confirm M2MField, FK, O2O type</span>
            <span class="c1"># Set on_delete for FK/O2O based on Optional status</span>
            <span class="k">if</span> <span class="n">unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">):</span>
                <span class="c1"># Default to CASCADE for non-optional, SET_NULL for optional (matching test expectation)</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
                <span class="p">)</span>  <span class="c1"># Changed PROTECT to CASCADE</span>

    <span class="c1"># --- Final Adjustments (Nullability, etc.) --- #</span>
    <span class="c1"># Apply nullability. M2M fields cannot be null in Django.</span>
    <span class="c1"># Do not override nullability if it was already forced by a multi-FK union</span>
    <span class="k">if</span> <span class="n">django_field_type</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">union_details</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>
        <span class="c1"># Explicitly set blank based on optionality.</span>
        <span class="c1"># Simplified logic: Mirror the null assignment directly</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_optional</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;FINAL RETURN from get_django_mapping: Type=</span><span class="si">{</span><span class="n">django_field_type</span><span class="si">}</span><span class="s2">, Kwargs=</span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>  <span class="c1"># Added final state logging</span>
    <span class="k">return</span> <span class="n">django_field_type</span><span class="p">,</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_pydantic_mapping" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pydantic_mapping</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span></code>

<a href="#pydantic2django.core.bidirectional_mapper.BidirectionalTypeMapper.get_pydantic_mapping" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the corresponding Pydantic type hint and FieldInfo kwargs for a Django Field.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/bidirectional_mapper.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pydantic_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the corresponding Pydantic type hint and FieldInfo kwargs for a Django Field.&quot;&quot;&quot;</span>
    <span class="n">dj_field_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span>
    <span class="n">is_optional</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">null</span>
    <span class="n">is_choices</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>

    <span class="c1"># --- Find base unit (ignoring choices for now) ---</span>
    <span class="c1"># Find the mapping unit based on the specific Django field type MRO</span>
    <span class="c1"># This gives us the correct underlying Python type (str, int, etc.)</span>
    <span class="n">base_unit_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_unit_for_django_field</span><span class="p">(</span><span class="n">dj_field_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_unit_cls</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No base mapping unit for </span><span class="si">{</span><span class="n">dj_field_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, falling back to Any.&quot;</span><span class="p">)</span>
        <span class="n">pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">Any</span>
        <span class="k">return</span> <span class="n">pydantic_type</span><span class="p">,</span> <span class="p">{}</span>

    <span class="n">base_instance_unit</span> <span class="o">=</span> <span class="n">base_unit_cls</span><span class="p">()</span>
    <span class="c1"># Get the base Pydantic type from this unit</span>
    <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>

    <span class="c1"># --- Determine Final Pydantic Type Adjustments --- #</span>
    <span class="c1"># (Relationships, AutoPK, Optional wrapper)</span>

    <span class="c1"># Handle choices FIRST to determine the core type before Optional wrapping</span>
    <span class="k">if</span> <span class="n">is_choices</span><span class="p">:</span>
        <span class="c1"># Default to base type, override if valid choices found</span>
        <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>
        <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>  <span class="c1"># Explicit check before iteration</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">choice_values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">choice_values</span><span class="p">:</span>  <span class="c1"># Ensure the tuple is not empty</span>
                    <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="n">choice_values</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped choices for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to Pydantic type: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has choices defined, but extracted values are empty. Falling back.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Keep final_pydantic_type as base type</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract choices for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Falling back.&quot;</span><span class="p">)</span>
                <span class="c1"># Keep final_pydantic_type as base type</span>
        <span class="c1"># If dj_field.choices was None/empty initially, final_pydantic_type remains the base type</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get the base Pydantic type from this unit if not choices</span>
        <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>

    <span class="c1"># 1. Handle Relationships first, as they determine the core type</span>
    <span class="k">if</span> <span class="n">base_unit_cls</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ForeignKeyMapping</span><span class="p">,</span> <span class="n">OneToOneFieldMapping</span><span class="p">,</span> <span class="n">ManyToManyFieldMapping</span><span class="p">):</span>
        <span class="n">related_dj_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;related_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">related_dj_model</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MappingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine related Django model for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Resolve &#39;self&#39; reference</span>
        <span class="k">if</span> <span class="n">related_dj_model</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
            <span class="c1"># We need the Django model class that dj_field belongs to.</span>
            <span class="c1"># This info isn&#39;t directly passed, so this approach might be limited.</span>
            <span class="c1"># Assuming self-reference points to the same type hierarchy for now.</span>
            <span class="c1"># A better solution might need the model context passed down.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Handling &#39;self&#39; reference for field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;. Mapping might be incomplete without parent model context.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Attempt to get Pydantic model mapped to the field&#39;s owner model if possible (heuristically)</span>
            <span class="c1"># This is complex and potentially fragile.</span>
            <span class="c1"># For now, let&#39;s use a placeholder or raise an error if needed strictly.</span>
            <span class="c1"># Sticking with the base type (e.g., Any or int for PK) might be safer without context.</span>
            <span class="c1"># Use the base type (likely PK int/uuid) as the fallback type here</span>
            <span class="n">target_pydantic_model</span> <span class="o">=</span> <span class="n">base_instance_unit</span><span class="o">.</span><span class="n">python_type</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Any as placeholder for &#39;self&#39; reference &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_pydantic_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_pydantic_model_for_django</span><span class="p">(</span><span class="n">related_dj_model</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_pydantic_model</span> <span class="ow">or</span> <span class="n">target_pydantic_model</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">related_dj_model</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>  <span class="c1"># Avoid redundant warning for self</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot map relationship: No corresponding Pydantic model found for Django model &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">related_dj_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">label</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">related_dj_model</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_meta&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">related_dj_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Using placeholder &#39;</span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Keep final_pydantic_type as the base unit&#39;s python_type (e.g., int for FK)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base_unit_cls</span> <span class="o">==</span> <span class="n">ManyToManyFieldMapping</span><span class="p">:</span>
                <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">target_pydantic_model</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># FK or O2O</span>
                <span class="c1"># Keep the PK type (e.g., int) if target model not found,</span>
                <span class="c1"># otherwise use the target Pydantic model type.</span>
                <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">target_pydantic_model</span>  <span class="c1"># This should now be the related model type</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped relationship field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to Pydantic type: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. AutoPK override (after relationship resolution)</span>
    <span class="n">is_auto_pk</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">dj_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BigAutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallAutoField</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">is_auto_pk</span><span class="p">:</span>
        <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped AutoPK field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; to </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># AutoPKs are always optional in Pydantic input</span>

    <span class="c1"># 3. Apply Optional[...] wrapper if necessary (AFTER relationship/AutoPK)</span>
    <span class="c1"># Do not wrap M2M lists or already Optional AutoPKs in Optional[] again.</span>
    <span class="c1"># Also, don&#39;t wrap if the type is already Literal (choices handled Optionality) - NO, wrap Literal too if null=True</span>
    <span class="k">if</span> <span class="n">is_optional</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_auto_pk</span><span class="p">:</span>  <span class="c1"># Check if is_choices? No, optional applies to literal too.</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">final_pydantic_type</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">final_pydantic_type</span><span class="p">)</span>
        <span class="n">is_already_optional</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Optional</span> <span class="ow">or</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">UnionType</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_already_optional</span><span class="p">:</span>
            <span class="n">final_pydantic_type</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="n">final_pydantic_type</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrapped type for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in Optional: </span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Generate FieldInfo Kwargs --- #</span>
    <span class="c1"># Use EnumFieldMapping logic for kwargs ONLY if choices exist,</span>
    <span class="c1"># otherwise use the base unit determined earlier. # --&gt; NO, always use base unit for kwargs now. Literal type handles choices.</span>
    <span class="c1"># kwargs_unit_cls = EnumFieldMapping if is_choices else base_unit_cls # OLD logic</span>
    <span class="n">instance_unit</span> <span class="o">=</span> <span class="n">base_unit_cls</span><span class="p">()</span>  <span class="c1"># Use the base unit (e.g., StrFieldMapping) for base kwargs</span>

    <span class="n">field_info_kwargs</span> <span class="o">=</span> <span class="n">instance_unit</span><span class="o">.</span><span class="n">django_to_pydantic_field_info_kwargs</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span>

    <span class="c1"># --- Explicitly cast title (verbose_name) and description (help_text) --- #</span>
    <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensured title is str for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensured description is str for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># --- End Casting --- #</span>

    <span class="c1"># --- Keep choices in json_schema_extra even when using Literal ---</span>
    <span class="c1"># This preserves the (value, label) mapping as metadata alongside the Literal type.</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">is_choices</span>
        <span class="ow">and</span> <span class="s2">&quot;json_schema_extra&quot;</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span>
        <span class="ow">and</span> <span class="s2">&quot;choices&quot;</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kept choices in json_schema_extra for Literal field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_choices</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has choices, but they weren&#39;t added to json_schema_extra by the mapping unit.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Clean up redundant `default=None` for Optional fields handled by Pydantic v2.</span>
    <span class="c1"># Do not force-add default=None; only keep explicit defaults (e.g., for AutoPK).</span>
    <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_auto_pk</span><span class="p">:</span>
            <span class="c1"># Remove implicit default=None for Optional fields</span>
            <span class="n">field_info_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed redundant default=None for Optional field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_auto_pk</span> <span class="ow">and</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_info_kwargs</span><span class="p">:</span>
            <span class="c1"># Keep default=None for AutoPK if not already set</span>
            <span class="n">field_info_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set default=None for AutoPK Optional field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Final Pydantic mapping for &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: Type=</span><span class="si">{</span><span class="n">final_pydantic_type</span><span class="si">}</span><span class="s2">, Kwargs=</span><span class="si">{</span><span class="n">field_info_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">final_pydantic_type</span><span class="p">,</span> <span class="n">field_info_kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.mapping_units.TypeMappingUnit"></a>
    <div class="doc doc-contents first">


        <p>Base class defining a bidirectional mapping between a Python type and a Django Field.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TypeMappingUnit</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class defining a bidirectional mapping between a Python type and a Django Field.&quot;&quot;&quot;</span>

    <span class="n">python_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">T_PydanticType</span><span class="p">]</span>
    <span class="n">django_field_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span>  <span class="c1"># Use base class here</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure subclasses define the required types.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;python_type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;django_field_type&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Subclasses of TypeMappingUnit must define &#39;python_type&#39; and &#39;django_field_type&#39; class attributes.&quot;</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">matches</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">py_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate a score indicating how well this unit matches the given Python type and FieldInfo.</span>

<span class="sd">        Args:</span>
<span class="sd">            py_type: The Python type to match against.</span>
<span class="sd">            field_info: Optional Pydantic FieldInfo for context.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A float score (0.0 = no match, higher = better match).</span>
<span class="sd">            Base implementation scores:</span>
<span class="sd">            - 1.0 for exact type match (cls.python_type == py_type)</span>
<span class="sd">            - 0.5 for subclass match (issubclass(py_type, cls.python_type))</span>
<span class="sd">            - 0.0 otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_py_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">python_type</span>
        <span class="k">if</span> <span class="n">py_type</span> <span class="o">==</span> <span class="n">target_py_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check issubclass only if both are actual classes and py_type is not Any</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">py_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Any</span>
                <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">target_py_type</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">target_py_type</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># Don&#39;t match if it&#39;s the same type (already handled by exact match)</span>
                <span class="k">if</span> <span class="n">py_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">target_py_type</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mf">0.5</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># issubclass fails on non-classes (like Any, List[int], etc.)</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pydantic_to_django_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">py_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Django field constructor kwargs from Pydantic FieldInfo.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="p">:</span>
            <span class="c1"># Map common attributes</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;help_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">description</span>

            <span class="c1"># Only consider `default` if `default_factory` is None</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PydanticUndefined</span> <span class="ow">and</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Django doesn&#39;t handle callable defaults easily here</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span>
                <span class="k">elif</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Explicitly check for None default</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Add default=None if present in FieldInfo</span>
            <span class="c1"># else: If default_factory is present, do not add a &#39;default&#39; kwarg.</span>
            <span class="c1"># No warning needed as this is now expected behavior.</span>

            <span class="c1"># Note: Frozen, ge, le etc. are validation rules, map separately if needed</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">django_to_pydantic_field_info_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Pydantic FieldInfo kwargs from a Django field instance.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_field&quot;</span><span class="p">)</span>  <span class="c1"># Get field name for logging</span>

        <span class="c1"># Title: Use verbose_name or generate from field name</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;verbose_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: verbose_name=&#39;</span><span class="si">{</span><span class="n">verbose_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose_name</span><span class="p">:</span>
            <span class="c1"># Ensure verbose_name is a string, handling lazy proxies</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">field_name</span> <span class="o">!=</span> <span class="s2">&quot;unknown_field&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Generate title from name if verbose_name is missing and name is a string</span>
            <span class="n">generated_title</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generated_title</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated title for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">generated_title</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># else: field name is None or &#39;unknown_field&#39;, no title generated by default</span>

        <span class="c1"># Description</span>
        <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">help_text</span><span class="p">:</span>
            <span class="c1"># Ensure help_text is a string, handling lazy proxies</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">help_text</span><span class="p">)</span>

        <span class="c1"># Default value/factory handling</span>
        <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">has_default</span><span class="p">():</span>
            <span class="n">dj_default</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">NOT_PROVIDED</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">dj_default</span><span class="p">):</span>
                    <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>
                        <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
                        <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Add other known callable mappings if needed</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Django field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has an unmapped callable default (</span><span class="si">{</span><span class="n">dj_default</span><span class="si">}</span><span class="s2">), &quot;</span>
                            <span class="s2">&quot;not mapping to Pydantic default/default_factory.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">factory_set</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Handle non-callable defaults</span>
                <span class="c1"># Map default={} back to default_factory=dict for JSONField</span>
                <span class="k">elif</span> <span class="n">dj_default</span> <span class="o">==</span> <span class="p">{}:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dj_default</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Add non-None, non-callable, non-empty-collection defaults</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Processing non-callable default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span><span class="si">}</span><span class="s2">, Value: </span><span class="si">{</span><span class="n">dj_default</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Apply force_str ONLY if the default value&#39;s type suggests it might be a lazy proxy string.</span>
                    <span class="c1"># A simple check is if &#39;proxy&#39; is in the type name.</span>
                    <span class="n">processed_default</span> <span class="o">=</span> <span class="n">dj_default</span>
                    <span class="k">if</span> <span class="s2">&quot;proxy&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">processed_default</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Applied force_str to potential lazy default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. New value: </span><span class="si">{</span><span class="n">processed_default</span><span class="si">!r}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Failed to apply force_str to default value for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Assigning raw default.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">processed_default</span> <span class="o">=</span> <span class="n">dj_default</span>  <span class="c1"># Keep original on error</span>

                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_default</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assigned final default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Handle AutoField PKs -&gt; frozen=True, default=None</span>
        <span class="n">is_auto_pk</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">dj_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BigAutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallAutoField</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_auto_pk</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;frozen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Handle choices (including processing labels and limiting)</span>
        <span class="c1"># Log choices *before* calling handle_choices</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;choices&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Log the raw choices from the Django field</span>
                <span class="n">raw_choices_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">))</span>  <span class="c1"># Materialize and get repr</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Raw choices before handle_choices: </span><span class="si">{</span><span class="n">raw_choices_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Error logging raw choices: </span><span class="si">{</span><span class="n">log_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">handle_choices</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Log choices *after* handle_choices modified kwargs</span>
            <span class="n">processed_choices_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;choices&quot;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Choices in kwargs after handle_choices: </span><span class="si">{</span><span class="n">processed_choices_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Handle non-choice max_length only if choices were NOT processed</span>
        <span class="k">elif</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Only add max_length if not choices - specific units can override</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">max_length</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base kwargs generated for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Django field choices, ensuring lazy translation proxies are resolved.</span>

<span class="sd">        It processes the choices, forces string conversion on labels within an</span>
<span class="sd">        active translation context, limits the number of choices added to the schema,</span>
<span class="sd">        and stores them in `json_schema_extra`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_field&quot;</span><span class="p">)</span>
        <span class="n">processed_choices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">MAX_CHOICES_IN_SCHEMA</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># TODO: Make configurable</span>
        <span class="n">limited_choices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>  <span class="c1"># Use potentially processed default</span>
        <span class="n">default_included</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># --- Ensure Translation Context --- #</span>
        <span class="n">active_translation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">translation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Get the currently active language to restore later</span>
                <span class="n">current_language</span> <span class="o">=</span> <span class="n">translation</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
                <span class="c1"># Activate the default language (or a specific one like &#39;en&#39;)</span>
                <span class="c1"># This forces lazy objects to resolve using a consistent language.</span>
                <span class="c1"># Using settings.LANGUAGE_CODE assumes it&#39;s set correctly.</span>
                <span class="n">default_language</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;LANGUAGE_CODE&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">)</span>  <span class="c1"># Fallback to &#39;en&#39;</span>
                <span class="n">active_translation</span> <span class="o">=</span> <span class="n">translation</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">default_language</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Activated translation override (&#39;</span><span class="si">{</span><span class="n">default_language</span><span class="si">}</span><span class="s2">&#39;) for processing choices of &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="p">)</span>
                <span class="n">active_translation</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>  <span class="c1"># Manually enter context</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">trans_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to activate translation context for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">trans_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">active_translation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensure it&#39;s None if activation failed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Django translation module not available. Lazy choices might not resolve correctly.&quot;</span><span class="p">)</span>

        <span class="c1"># --- Process Choices (within potential translation context) --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">all_choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span> <span class="ow">or</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">all_choices</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Processing choice for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Value=</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">, Label=</span><span class="si">{</span><span class="n">label</span><span class="si">!r}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Apply force_str defensively; should resolve lazy proxies if context is active</span>
                    <span class="n">processed_label</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;  Processed label for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Value=</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">, Label=</span><span class="si">{</span><span class="n">processed_label</span><span class="si">!r}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">processed_label</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">force_str_err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error using force_str on label for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (value: </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">): </span><span class="si">{</span><span class="n">force_str_err</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Fallback: use repr or a placeholder if force_str fails completely</span>
                    <span class="n">processed_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;unresolved: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
                <span class="n">processed_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">processed_label</span><span class="p">))</span>

            <span class="c1"># --- Limit Choices --- #</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Limiting choices for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_choices</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">processed_choices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">default_value</span><span class="p">:</span>
                            <span class="n">limited_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">lbl</span><span class="p">))</span>
                            <span class="n">default_included</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="n">remaining_slots</span> <span class="o">=</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_choices</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remaining_slots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">processed_choices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_choices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">default_included</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">==</span> <span class="n">default_value</span><span class="p">):</span>
                            <span class="n">limited_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">lbl</span><span class="p">))</span>
                <span class="n">final_choices_list</span> <span class="o">=</span> <span class="n">limited_choices</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_choices_list</span> <span class="o">=</span> <span class="n">processed_choices</span>

            <span class="c1"># --- Store Choices --- #</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="p">{})[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_choices_list</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Remove max_length if choices are present</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored final choices in json_schema_extra for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing or limiting choices for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># --- Deactivate Translation Context --- #</span>
            <span class="k">if</span> <span class="n">active_translation</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">active_translation</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Manually exit context</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deactivated translation override for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">trans_exit_err</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deactivating translation context for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">trans_exit_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.mapping_units.TypeMappingUnit.__init_subclass__" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#pydantic2django.core.mapping_units.TypeMappingUnit.__init_subclass__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Ensure subclasses define the required types.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure subclasses define the required types.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;python_type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;django_field_type&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Subclasses of TypeMappingUnit must define &#39;python_type&#39; and &#39;django_field_type&#39; class attributes.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.mapping_units.TypeMappingUnit.django_to_pydantic_field_info_kwargs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">django_to_pydantic_field_info_kwargs</span><span class="p">(</span><span class="n">dj_field</span><span class="p">)</span></code>

<a href="#pydantic2django.core.mapping_units.TypeMappingUnit.django_to_pydantic_field_info_kwargs" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate Pydantic FieldInfo kwargs from a Django field instance.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">django_to_pydantic_field_info_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate Pydantic FieldInfo kwargs from a Django field instance.&quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_field&quot;</span><span class="p">)</span>  <span class="c1"># Get field name for logging</span>

    <span class="c1"># Title: Use verbose_name or generate from field name</span>
    <span class="n">verbose_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;verbose_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: verbose_name=&#39;</span><span class="si">{</span><span class="n">verbose_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose_name</span><span class="p">:</span>
        <span class="c1"># Ensure verbose_name is a string, handling lazy proxies</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">field_name</span> <span class="o">!=</span> <span class="s2">&quot;unknown_field&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Generate title from name if verbose_name is missing and name is a string</span>
        <span class="n">generated_title</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generated_title</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated title for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">generated_title</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="c1"># else: field name is None or &#39;unknown_field&#39;, no title generated by default</span>

    <span class="c1"># Description</span>
    <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">help_text</span><span class="p">:</span>
        <span class="c1"># Ensure help_text is a string, handling lazy proxies</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">help_text</span><span class="p">)</span>

    <span class="c1"># Default value/factory handling</span>
    <span class="k">if</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">has_default</span><span class="p">():</span>
        <span class="n">dj_default</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">get_default</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">NOT_PROVIDED</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">dj_default</span><span class="p">):</span>
                <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>
                    <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
                    <span class="n">factory_set</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Add other known callable mappings if needed</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Django field &#39;</span><span class="si">{</span><span class="n">dj_field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; has an unmapped callable default (</span><span class="si">{</span><span class="n">dj_default</span><span class="si">}</span><span class="s2">), &quot;</span>
                        <span class="s2">&quot;not mapping to Pydantic default/default_factory.&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">factory_set</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Handle non-callable defaults</span>
            <span class="c1"># Map default={} back to default_factory=dict for JSONField</span>
            <span class="k">elif</span> <span class="n">dj_default</span> <span class="o">==</span> <span class="p">{}:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dj_default</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default_factory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dj_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Add non-None, non-callable, non-empty-collection defaults</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Processing non-callable default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span><span class="si">}</span><span class="s2">, Value: </span><span class="si">{</span><span class="n">dj_default</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Apply force_str ONLY if the default value&#39;s type suggests it might be a lazy proxy string.</span>
                <span class="c1"># A simple check is if &#39;proxy&#39; is in the type name.</span>
                <span class="n">processed_default</span> <span class="o">=</span> <span class="n">dj_default</span>
                <span class="k">if</span> <span class="s2">&quot;proxy&quot;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">processed_default</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">dj_default</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Applied force_str to potential lazy default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. New value: </span><span class="si">{</span><span class="n">processed_default</span><span class="si">!r}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to apply force_str to default value for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Assigning raw default.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">processed_default</span> <span class="o">=</span> <span class="n">dj_default</span>  <span class="c1"># Keep original on error</span>

                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_default</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assigned final default for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Handle AutoField PKs -&gt; frozen=True, default=None</span>
    <span class="n">is_auto_pk</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">dj_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BigAutoField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallAutoField</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">is_auto_pk</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;frozen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Handle choices (including processing labels and limiting)</span>
    <span class="c1"># Log choices *before* calling handle_choices</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;choices&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Log the raw choices from the Django field</span>
            <span class="n">raw_choices_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span><span class="p">))</span>  <span class="c1"># Materialize and get repr</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Raw choices before handle_choices: </span><span class="si">{</span><span class="n">raw_choices_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Error logging raw choices: </span><span class="si">{</span><span class="n">log_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_choices</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Log choices *after* handle_choices modified kwargs</span>
        <span class="n">processed_choices_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;choices&quot;</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Choices in kwargs after handle_choices: </span><span class="si">{</span><span class="n">processed_choices_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Handle non-choice max_length only if choices were NOT processed</span>
    <span class="k">elif</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Only add max_length if not choices - specific units can override</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dj_field</span><span class="o">.</span><span class="n">max_length</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base kwargs generated for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.mapping_units.TypeMappingUnit.handle_choices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_choices</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></code>

<a href="#pydantic2django.core.mapping_units.TypeMappingUnit.handle_choices" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Handles Django field choices, ensuring lazy translation proxies are resolved.</p>
<p>It processes the choices, forces string conversion on labels within an
active translation context, limits the number of choices added to the schema,
and stores them in <code>json_schema_extra</code>.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_choices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dj_field</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles Django field choices, ensuring lazy translation proxies are resolved.</span>

<span class="sd">    It processes the choices, forces string conversion on labels within an</span>
<span class="sd">    active translation context, limits the number of choices added to the schema,</span>
<span class="sd">    and stores them in `json_schema_extra`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">dj_field</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown_field&quot;</span><span class="p">)</span>
    <span class="n">processed_choices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">MAX_CHOICES_IN_SCHEMA</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># TODO: Make configurable</span>
    <span class="n">limited_choices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>  <span class="c1"># Use potentially processed default</span>
    <span class="n">default_included</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># --- Ensure Translation Context --- #</span>
    <span class="n">active_translation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">translation</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the currently active language to restore later</span>
            <span class="n">current_language</span> <span class="o">=</span> <span class="n">translation</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
            <span class="c1"># Activate the default language (or a specific one like &#39;en&#39;)</span>
            <span class="c1"># This forces lazy objects to resolve using a consistent language.</span>
            <span class="c1"># Using settings.LANGUAGE_CODE assumes it&#39;s set correctly.</span>
            <span class="n">default_language</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;LANGUAGE_CODE&quot;</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">)</span>  <span class="c1"># Fallback to &#39;en&#39;</span>
            <span class="n">active_translation</span> <span class="o">=</span> <span class="n">translation</span><span class="o">.</span><span class="n">override</span><span class="p">(</span><span class="n">default_language</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Activated translation override (&#39;</span><span class="si">{</span><span class="n">default_language</span><span class="si">}</span><span class="s2">&#39;) for processing choices of &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>
            <span class="n">active_translation</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>  <span class="c1"># Manually enter context</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">trans_err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to activate translation context for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">trans_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">active_translation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Ensure it&#39;s None if activation failed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Django translation module not available. Lazy choices might not resolve correctly.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Process Choices (within potential translation context) --- #</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">all_choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dj_field</span><span class="o">.</span><span class="n">choices</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">all_choices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Processing choice for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Value=</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">, Label=</span><span class="si">{</span><span class="n">label</span><span class="si">!r}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Apply force_str defensively; should resolve lazy proxies if context is active</span>
                <span class="n">processed_label</span> <span class="o">=</span> <span class="n">force_str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Processed label for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Value=</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">, Label=</span><span class="si">{</span><span class="n">processed_label</span><span class="si">!r}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">processed_label</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">force_str_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error using force_str on label for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (value: </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">): </span><span class="si">{</span><span class="n">force_str_err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Fallback: use repr or a placeholder if force_str fails completely</span>
                <span class="n">processed_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;unresolved: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
            <span class="n">processed_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="n">processed_label</span><span class="p">))</span>

        <span class="c1"># --- Limit Choices --- #</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processed_choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Limiting choices for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">processed_choices</span><span class="p">)</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">processed_choices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">default_value</span><span class="p">:</span>
                        <span class="n">limited_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">lbl</span><span class="p">))</span>
                        <span class="n">default_included</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="n">remaining_slots</span> <span class="o">=</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_choices</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining_slots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">processed_choices</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">limited_choices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_CHOICES_IN_SCHEMA</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">default_included</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">==</span> <span class="n">default_value</span><span class="p">):</span>
                        <span class="n">limited_choices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">lbl</span><span class="p">))</span>
            <span class="n">final_choices_list</span> <span class="o">=</span> <span class="n">limited_choices</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_choices_list</span> <span class="o">=</span> <span class="n">processed_choices</span>

        <span class="c1"># --- Store Choices --- #</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="p">{})[</span><span class="s2">&quot;choices&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_choices_list</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Remove max_length if choices are present</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored final choices in json_schema_extra for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing or limiting choices for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;json_schema_extra&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># --- Deactivate Translation Context --- #</span>
        <span class="k">if</span> <span class="n">active_translation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">active_translation</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Manually exit context</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deactivated translation override for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">trans_exit_err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deactivating translation context for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">trans_exit_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.mapping_units.TypeMappingUnit.matches" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">matches</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.core.mapping_units.TypeMappingUnit.matches" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Calculate a score indicating how well this unit matches the given Python type and FieldInfo.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>py_type</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Python type to match against.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>field_info</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="pydantic.fields.FieldInfo">FieldInfo</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Pydantic FieldInfo for context.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A float score (0.0 = no match, higher = better match).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base implementation scores:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>1.0 for exact type match (cls.python_type == py_type)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>0.5 for subclass match (issubclass(py_type, cls.python_type))</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>0.0 otherwise</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">matches</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">py_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score indicating how well this unit matches the given Python type and FieldInfo.</span>

<span class="sd">    Args:</span>
<span class="sd">        py_type: The Python type to match against.</span>
<span class="sd">        field_info: Optional Pydantic FieldInfo for context.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A float score (0.0 = no match, higher = better match).</span>
<span class="sd">        Base implementation scores:</span>
<span class="sd">        - 1.0 for exact type match (cls.python_type == py_type)</span>
<span class="sd">        - 0.5 for subclass match (issubclass(py_type, cls.python_type))</span>
<span class="sd">        - 0.0 otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_py_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">python_type</span>
    <span class="k">if</span> <span class="n">py_type</span> <span class="o">==</span> <span class="n">target_py_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check issubclass only if both are actual classes and py_type is not Any</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">py_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Any</span>
            <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">target_py_type</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">target_py_type</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># Don&#39;t match if it&#39;s the same type (already handled by exact match)</span>
            <span class="k">if</span> <span class="n">py_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">target_py_type</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.5</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="c1"># issubclass fails on non-classes (like Any, List[int], etc.)</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="mf">0.0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.mapping_units.TypeMappingUnit.pydantic_to_django_kwargs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pydantic_to_django_kwargs</span><span class="p">(</span><span class="n">py_type</span><span class="p">,</span> <span class="n">field_info</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.core.mapping_units.TypeMappingUnit.pydantic_to_django_kwargs" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate Django field constructor kwargs from Pydantic FieldInfo.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/mapping_units.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">pydantic_to_django_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">py_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate Django field constructor kwargs from Pydantic FieldInfo.&quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">field_info</span><span class="p">:</span>
        <span class="c1"># Map common attributes</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;help_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">description</span>

        <span class="c1"># Only consider `default` if `default_factory` is None</span>
        <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">PydanticUndefined</span> <span class="ow">and</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Django doesn&#39;t handle callable defaults easily here</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span>
            <span class="k">elif</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Explicitly check for None default</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Add default=None if present in FieldInfo</span>
        <span class="c1"># else: If default_factory is present, do not add a &#39;default&#39; kwarg.</span>
        <span class="c1"># No warning needed as this is now expected behavior.</span>

        <span class="c1"># Note: Frozen, ge, le etc. are validation rules, map separately if needed</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Relationships and cross-model resolution</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.relationships.RelationshipConversionAccessor"></a>
    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RelationshipConversionAccessor</span><span class="p">:</span>
    <span class="n">available_relationships</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RelationshipMapper</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># dependencies: Optional[dict[str, set[str]]] = field(default=None) # Keep if used</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">relationship_mapping_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RelationshipConversionAccessor&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a dictionary of strings representing model qualified names to a RelationshipConversionAccessor</span>

<span class="sd">        The dictionary should be of the form:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;pydantic_model_qualified_name&quot;: &quot;django_model_qualified_name&quot;,</span>
<span class="sd">            ...</span>
<span class="sd">        }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">available_relationships</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pydantic_mqn</span><span class="p">,</span> <span class="n">django_mqn</span> <span class="ow">in</span> <span class="n">relationship_mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Split the module path and class name</span>
                <span class="n">pydantic_module_path</span><span class="p">,</span> <span class="n">pydantic_class_name</span> <span class="o">=</span> <span class="n">pydantic_mqn</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">django_module_path</span><span class="p">,</span> <span class="n">django_class_name</span> <span class="o">=</span> <span class="n">django_mqn</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Import the modules</span>
                <span class="n">pydantic_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">pydantic_module_path</span><span class="p">)</span>
                <span class="n">django_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">django_module_path</span><span class="p">)</span>

                <span class="c1"># Get the actual class objects</span>
                <span class="n">pydantic_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_module</span><span class="p">,</span> <span class="n">pydantic_class_name</span><span class="p">)</span>
                <span class="n">django_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">django_module</span><span class="p">,</span> <span class="n">django_class_name</span><span class="p">)</span>

                <span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">pydantic_model</span><span class="p">,</span> <span class="n">django_model</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error importing model </span><span class="si">{</span><span class="n">pydantic_mqn</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">django_mqn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">available_relationships</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the relationships to a dictionary of strings representing</span>
<span class="sd">        model qualified names for bidirectional conversion.</span>

<span class="sd">        Can be stored in a JSON field, and used to reconstruct the relationships.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">relationship_mapping_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="c1"># Skip relationships where either model is None</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">pydantic_mqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pydantic_model_qualified_name</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span><span class="p">)</span>
            <span class="n">django_mqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_django_model_qualified_name</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span><span class="p">)</span>
            <span class="n">relationship_mapping_dict</span><span class="p">[</span><span class="n">pydantic_mqn</span><span class="p">]</span> <span class="o">=</span> <span class="n">django_mqn</span>

        <span class="k">return</span> <span class="n">relationship_mapping_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pydantic_model_qualified_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the fully qualified name of a Pydantic model as module.class_name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_django_model_qualified_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the fully qualified name of a Django model as app_label.model_name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_source_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all source models (Pydantic or Dataclass).&quot;&quot;&quot;</span>
        <span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">available_django_models</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of all Django models in the relationship accessor&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">django_model</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_pydantic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a Pydantic model to the relationship accessor&quot;&quot;&quot;</span>
        <span class="c1"># Check if the model is already in available_pydantic_models by comparing class names</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">existing_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_source_models</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_dataclass_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a Dataclass model to the relationship accessor&quot;&quot;&quot;</span>
        <span class="c1"># Check if the model is already mapped</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">model</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">):</span>
            <span class="k">return</span>  <span class="c1"># Already exists</span>
        <span class="c1"># Check if a Pydantic model with the same name is already mapped (potential conflict)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding dataclass </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, but a Pydantic model with the same name exists.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">dataclass_model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a Django model to the relationship accessor&quot;&quot;&quot;</span>
        <span class="c1"># Check if the model is already in available_django_models by comparing class names</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">existing_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_django_models</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_django_model_for_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the corresponding Django model for a given Pydantic model</span>

<span class="sd">        Returns None if no matching Django model is found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_pydantic_model_for_django</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the corresponding Pydantic model for a given Django model</span>

<span class="sd">        Returns None if no matching Pydantic model is found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">==</span> <span class="n">django_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_django_model_for_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataclass_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the corresponding Django model for a given Dataclass model.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for Django model matching dataclass: </span><span class="si">{</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="c1"># Check if this mapper holds the target dataclass and has a linked Django model</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">dataclass_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found match: </span><span class="si">{</span><span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No match found for dataclass </span><span class="si">{</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create or update a mapping between a source model (Pydantic/Dataclass) and a Django model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_type</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;pydantic&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;dataclass&quot;</span>
            <span class="k">if</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
            <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot map relationship for unknown source type: </span><span class="si">{</span><span class="n">source_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Check if either model already exists in a relationship</span>
        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">source_model</span><span class="p">:</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="n">django_model</span>
                <span class="c1"># Ensure dataclass_model is None if we map pydantic</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated mapping: Pydantic </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">source_model</span><span class="p">:</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="n">django_model</span>
                <span class="c1"># Ensure pydantic_model is None</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated mapping: Dataclass </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">==</span> <span class="n">django_model</span><span class="p">:</span>
                <span class="c1"># Map the source model based on its type</span>
                <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
                    <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">source_model</span><span class="p">)</span>
                    <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Updated mapping: Pydantic </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (found via Django model)&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">:</span>
                    <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">source_model</span><span class="p">)</span>
                    <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Updated mapping: Dataclass </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (found via Django model)&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># If no existing relationship found, create a new one</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Creating new mapping: </span><span class="si">{</span><span class="n">source_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">pydantic_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">source_model</span><span class="p">),</span> <span class="n">django_model</span><span class="o">=</span><span class="n">django_model</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">dataclass_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">source_model</span><span class="p">),</span> <span class="n">django_model</span><span class="o">=</span><span class="n">django_model</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_source_model_known</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a specific source model (Pydantic or Dataclass) is known.&quot;&quot;&quot;</span>
        <span class="n">is_pydantic</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="n">is_dataclass</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_pydantic</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">is_dataclass</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Add a method to lookup source type by name</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_source_model_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a known source model (Pydantic or Dataclass) by its class name.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.available_django_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">available_django_models</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.available_django_models" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get a list of all Django models in the relationship accessor</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.available_source_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">available_source_models</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.available_source_models" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get a list of all source models (Pydantic or Dataclass).</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.add_dataclass_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_dataclass_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_dataclass_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add a Dataclass model to the relationship accessor</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_dataclass_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a Dataclass model to the relationship accessor&quot;&quot;&quot;</span>
    <span class="c1"># Check if the model is already mapped</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">model</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">):</span>
        <span class="k">return</span>  <span class="c1"># Already exists</span>
    <span class="c1"># Check if a Pydantic model with the same name is already mapped (potential conflict)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding dataclass </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, but a Pydantic model with the same name exists.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">dataclass_model</span><span class="o">=</span><span class="n">model</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.add_django_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_django_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_django_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add a Django model to the relationship accessor</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a Django model to the relationship accessor&quot;&quot;&quot;</span>
    <span class="c1"># Check if the model is already in available_django_models by comparing class names</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">existing_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_django_models</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.add_pydantic_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pydantic_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.add_pydantic_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add a Pydantic model to the relationship accessor</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pydantic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a Pydantic model to the relationship accessor&quot;&quot;&quot;</span>
    <span class="c1"># Check if the model is already in available_pydantic_models by comparing class names</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">existing_models</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_source_models</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_models</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.from_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dict</span><span class="p">(</span><span class="n">relationship_mapping_dict</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.from_dict" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dictionary of strings representing model qualified names to a RelationshipConversionAccessor</p>
<p>The dictionary should be of the form:
{
    "pydantic_model_qualified_name": "django_model_qualified_name",
    ...
}</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">relationship_mapping_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RelationshipConversionAccessor&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a dictionary of strings representing model qualified names to a RelationshipConversionAccessor</span>

<span class="sd">    The dictionary should be of the form:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;pydantic_model_qualified_name&quot;: &quot;django_model_qualified_name&quot;,</span>
<span class="sd">        ...</span>
<span class="sd">    }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">available_relationships</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pydantic_mqn</span><span class="p">,</span> <span class="n">django_mqn</span> <span class="ow">in</span> <span class="n">relationship_mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Split the module path and class name</span>
            <span class="n">pydantic_module_path</span><span class="p">,</span> <span class="n">pydantic_class_name</span> <span class="o">=</span> <span class="n">pydantic_mqn</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">django_module_path</span><span class="p">,</span> <span class="n">django_class_name</span> <span class="o">=</span> <span class="n">django_mqn</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Import the modules</span>
            <span class="n">pydantic_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">pydantic_module_path</span><span class="p">)</span>
            <span class="n">django_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">django_module_path</span><span class="p">)</span>

            <span class="c1"># Get the actual class objects</span>
            <span class="n">pydantic_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_module</span><span class="p">,</span> <span class="n">pydantic_class_name</span><span class="p">)</span>
            <span class="n">django_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">django_module</span><span class="p">,</span> <span class="n">django_class_name</span><span class="p">)</span>

            <span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">pydantic_model</span><span class="p">,</span> <span class="n">django_model</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error importing model </span><span class="si">{</span><span class="n">pydantic_mqn</span><span class="si">}</span><span class="s2"> or </span><span class="si">{</span><span class="n">django_mqn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">available_relationships</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_django_model_for_dataclass</span><span class="p">(</span><span class="n">dataclass_model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Find the corresponding Django model for a given Dataclass model.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_django_model_for_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataclass_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the corresponding Django model for a given Dataclass model.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for Django model matching dataclass: </span><span class="si">{</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="c1"># Check if this mapper holds the target dataclass and has a linked Django model</span>
        <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">dataclass_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found match: </span><span class="si">{</span><span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  No match found for dataclass </span><span class="si">{</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_django_model_for_pydantic</span><span class="p">(</span><span class="n">pydantic_model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_django_model_for_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Find the corresponding Django model for a given Pydantic model</p>
<p>Returns None if no matching Django model is found</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_django_model_for_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the corresponding Django model for a given Pydantic model</span>

<span class="sd">    Returns None if no matching Django model is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.get_pydantic_model_for_django" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pydantic_model_for_django</span><span class="p">(</span><span class="n">django_model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_pydantic_model_for_django" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Find the corresponding Pydantic model for a given Django model</p>
<p>Returns None if no matching Pydantic model is found</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_pydantic_model_for_django</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the corresponding Pydantic model for a given Django model</span>

<span class="sd">    Returns None if no matching Pydantic model is found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">==</span> <span class="n">django_model</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.get_source_model_by_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_source_model_by_name</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.get_source_model_by_name" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Find a known source model (Pydantic or Dataclass) by its class name.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_source_model_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find a known source model (Pydantic or Dataclass) by its class name.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.is_source_model_known" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_source_model_known</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.is_source_model_known" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Check if a specific source model (Pydantic or Dataclass) is known.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_source_model_known</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a specific source model (Pydantic or Dataclass) is known.&quot;&quot;&quot;</span>
    <span class="n">is_pydantic</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
    <span class="n">is_dataclass</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_pydantic</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">is_dataclass</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.map_relationship" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">map_relationship</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">django_model</span><span class="p">)</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.map_relationship" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create or update a mapping between a source model (Pydantic/Dataclass) and a Django model.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">map_relationship</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="n">django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create or update a mapping between a source model (Pydantic/Dataclass) and a Django model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_type</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;pydantic&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;dataclass&quot;</span>
        <span class="k">if</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
        <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot map relationship for unknown source type: </span><span class="si">{</span><span class="n">source_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Check if either model already exists in a relationship</span>
    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">==</span> <span class="n">source_model</span><span class="p">:</span>
            <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="n">django_model</span>
            <span class="c1"># Ensure dataclass_model is None if we map pydantic</span>
            <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated mapping: Pydantic </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span> <span class="ow">and</span> <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">==</span> <span class="n">source_model</span><span class="p">:</span>
            <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">=</span> <span class="n">django_model</span>
            <span class="c1"># Ensure pydantic_model is None</span>
            <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated mapping: Dataclass </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="o">==</span> <span class="n">django_model</span><span class="p">:</span>
            <span class="c1"># Map the source model based on its type</span>
            <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">source_model</span><span class="p">)</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Updated mapping: Pydantic </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (found via Django model)&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">:</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">dataclass_model</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">source_model</span><span class="p">)</span>
                <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Updated mapping: Dataclass </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (found via Django model)&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># If no existing relationship found, create a new one</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Creating new mapping: </span><span class="si">{</span><span class="n">source_type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; Django </span><span class="si">{</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">pydantic_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">source_model</span><span class="p">),</span> <span class="n">django_model</span><span class="o">=</span><span class="n">django_model</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RelationshipMapper</span><span class="p">(</span><span class="n">dataclass_model</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">source_model</span><span class="p">),</span> <span class="n">django_model</span><span class="o">=</span><span class="n">django_model</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.relationships.RelationshipConversionAccessor.to_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dict</span><span class="p">()</span></code>

<a href="#pydantic2django.core.relationships.RelationshipConversionAccessor.to_dict" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert the relationships to a dictionary of strings representing
model qualified names for bidirectional conversion.</p>
<p>Can be stored in a JSON field, and used to reconstruct the relationships.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the relationships to a dictionary of strings representing</span>
<span class="sd">    model qualified names for bidirectional conversion.</span>

<span class="sd">    Can be stored in a JSON field, and used to reconstruct the relationships.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">relationship_mapping_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_relationships</span><span class="p">:</span>
        <span class="c1"># Skip relationships where either model is None</span>
        <span class="k">if</span> <span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">pydantic_mqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pydantic_model_qualified_name</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">pydantic_model</span><span class="p">)</span>
        <span class="n">django_mqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_django_model_qualified_name</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">django_model</span><span class="p">)</span>
        <span class="n">relationship_mapping_dict</span><span class="p">[</span><span class="n">pydantic_mqn</span><span class="p">]</span> <span class="o">=</span> <span class="n">django_mqn</span>

    <span class="k">return</span> <span class="n">relationship_mapping_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.relationships.RelationshipMapper"></a>
    <div class="doc doc-contents first">


        <p>Bidirectional mapper between source models (Pydantic/Dataclass) and Django models.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/relationships.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RelationshipMapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bidirectional mapper between source models (Pydantic/Dataclass) and Django models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Allow storing either source type</span>
    <span class="n">pydantic_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dataclass_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">django_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Keep context if needed later</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">source_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the source model (either Pydantic or Dataclass).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_model</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_model</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="pydantic2django.core.relationships.RelationshipMapper.source_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">source_model</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#pydantic2django.core.relationships.RelationshipMapper.source_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return the source model (either Pydantic or Dataclass).</p>

    </div>

</div>





  </div>

    </div>

</div></li>
<li>
<p><strong>Typing utilities</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.typing.TypeHandler"></a>
    <div class="doc doc-contents first">








              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/typing.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TypeHandler</span><span class="p">:</span>
    <span class="n">PATTERNS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;angle_bracket_class&quot;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;class &#39;([^&#39;]+)&#39;&gt;&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Safely add an import to the dictionary.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Avoid adding the module itself if name matches module (e.g., import datetime)</span>
        <span class="c1"># if name == module.split(&#39;.&#39;)[-1]:</span>
        <span class="c1">#     name = module # This logic might be too simplistic, revert for now</span>
        <span class="n">current_names</span> <span class="o">=</span> <span class="n">imports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_names</span><span class="p">:</span>
            <span class="n">current_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_imports</span><span class="p">(</span><span class="n">dict1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dict2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge two import dictionaries.&quot;&quot;&quot;</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">dict1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">dict2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">current_names</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_names</span><span class="p">:</span>
                    <span class="n">current_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Sort names within each module for consistency</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">merged</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_class_name</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract a simple, usable class name from a type object.&quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

        <span class="c1"># Check for Optional[T] specifically first (Union[T, NoneType])</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Optional&quot;</span>

        <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
            <span class="c1"># Now check for other origins</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Handles Union[A, B, ...]</span>
                <span class="k">return</span> <span class="s2">&quot;Union&quot;</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;List&quot;</span>  <span class="c1"># Use capital L consistently</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Dict&quot;</span>  <span class="c1"># Use capital D consistently</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Tuple&quot;</span>  <span class="c1"># Use capital T consistently</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Set&quot;</span>  <span class="c1"># Use capital S consistently</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Callable&quot;</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Type&quot;</span>
            <span class="c1"># Fallback for other generic types</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>

        <span class="c1"># Handle non-generic types</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">type_obj</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">type_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">PATTERNS</span><span class="p">[</span><span class="s2">&quot;angle_bracket_class&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">type_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine necessary imports by traversing a type object.&quot;&quot;&quot;</span>
        <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">processed_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Define modules for known Pydantic types that might need explicit import</span>
        <span class="n">pydantic_module_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;EmailStr&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;IPvAnyAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Json&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
            <span class="c1"># Add others if needed (e.g., SecretStr, UrlStr)</span>
        <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_traverse</span><span class="p">(</span><span class="n">current_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">imports</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">type_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_repr</span> <span class="ow">in</span> <span class="n">processed_types</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">processed_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_repr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Handle unhashable types if necessary, e.g., log a warning</span>
                <span class="k">pass</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
                <span class="c1"># Handle Generic Alias (List, Dict, Union, Optional, Callable, Type)</span>
                <span class="n">origin_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">origin_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Determine the canonical name used in &#39;typing&#39; imports (e.g., List, Dict, Callable)</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;List&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Dict&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Tuple&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Set&quot;</span>
                <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Handle types.UnionType for Python 3.10+</span>
                    <span class="c1"># We don&#39;t need to add Union or Optional imports anymore with | syntax</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Type&quot;</span>
                <span class="c1"># Check both typing.Callable and collections.abc.Callable</span>
                <span class="k">elif</span> <span class="n">origin_module</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="n">origin_name</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Callable&quot;</span>
                <span class="k">elif</span> <span class="n">origin_module</span> <span class="o">==</span> <span class="s2">&quot;collections.abc&quot;</span> <span class="ow">and</span> <span class="n">origin_name</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span><span class="p">:</span>
                    <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Callable&quot;</span>
                <span class="c1"># Add more specific checks if needed (e.g., Sequence, Mapping)</span>

                <span class="c1"># Add import if we identified a standard typing construct</span>
                <span class="k">if</span> <span class="n">typing_name</span><span class="p">:</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="n">typing_name</span><span class="p">)</span>

                <span class="c1"># Traverse arguments regardless of origin&#39;s module</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># Skip NoneType in Optional/Union</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">):</span>
                            <span class="c1"># Handle TypeVar by traversing its constraints/bound</span>
                            <span class="n">constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__constraints__&quot;</span><span class="p">,</span> <span class="p">())</span>
                            <span class="n">bound</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__bound__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
                                <span class="n">_traverse</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                                <span class="n">_traverse</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_traverse</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Recursively traverse arguments</span>
            <span class="c1"># Handle Base Types or Classes (int, str, MyClass, etc.)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
                <span class="n">module_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">type_name</span> <span class="ow">or</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># Skip builtins or types without names</span>
                <span class="k">elif</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NoneType&quot;</span><span class="p">,</span> <span class="s2">&quot;Generic&quot;</span><span class="p">):</span>
                    <span class="c1"># Catch Any, etc. used directly</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
                <span class="c1"># Check for dataclasses and Pydantic models specifically</span>
                <span class="k">elif</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">actual_module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">actual_module</span> <span class="ow">and</span> <span class="n">actual_module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                        <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">actual_module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
                    <span class="c1"># Add specific imports if needed (e.g., dataclasses.dataclass, pydantic.BaseModel)</span>
                    <span class="k">if</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">):</span>
                        <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;dataclasses&quot;</span><span class="p">,</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">)</span>
                    <span class="c1"># No need to add BaseModel here usually, handled by pydantic_module_map or direct usage</span>
                <span class="k">elif</span> <span class="n">module_name</span><span class="p">:</span>
                    <span class="c1"># Handle known standard library modules explicitly</span>
                    <span class="n">known_stdlib</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;pathlib&quot;</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">known_stdlib</span><span class="p">:</span>
                        <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
                    <span class="c1"># Handle known Pydantic types explicitly (redundant with BaseModel check?)</span>
                    <span class="k">elif</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="n">pydantic_module_map</span><span class="p">:</span>
                        <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">pydantic_module_map</span><span class="p">[</span><span class="n">type_name</span><span class="p">],</span> <span class="n">type_name</span><span class="p">)</span>
                    <span class="c1"># Assume other types defined in modules need importing</span>
                    <span class="k">elif</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  <span class="c1"># Avoid importing from main script context</span>
                        <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">current_type</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
                <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="s2">&quot;Any&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">):</span>
                <span class="c1"># Handle TypeVar used directly</span>
                <span class="n">constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__constraints__&quot;</span><span class="p">,</span> <span class="p">())</span>
                <span class="n">bound</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__bound__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
                    <span class="n">_traverse</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                    <span class="n">_traverse</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># Consider adding ForwardRef handling if needed:</span>
            <span class="c1"># elif isinstance(current_type, typing.ForwardRef):</span>
            <span class="c1">#     # Potentially add logic to resolve/import forward refs</span>
            <span class="c1">#     pass</span>

        <span class="n">_traverse</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

        <span class="c1"># Clean up imports (unique, sorted)</span>
        <span class="n">final_imports</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">unique_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">unique_names</span><span class="p">:</span>
                <span class="n">final_imports</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_names</span>
        <span class="k">return</span> <span class="n">final_imports</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_field_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a field type to get name, flags, imports, and contained dataclasses.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TypeHandler] Processing type: </span><span class="si">{</span><span class="n">field_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">is_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize metadata with type hint</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">contained_dataclasses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">current_type</span> <span class="o">=</span> <span class="n">field_type</span>  <span class="c1"># Keep track of the potentially unwrapped type</span>

        <span class="c1"># Helper function (remains the same)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_is_potential_dataclass</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_find_contained_dataclasses</span><span class="p">(</span><span class="n">current_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                        <span class="n">_find_contained_dataclasses</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_is_potential_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">):</span>
                <span class="n">contained_dataclasses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

        <span class="n">_find_contained_dataclasses</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contained_dataclasses</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found potential contained dataclasses: </span><span class="si">{</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">contained_dataclasses</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Simplification Loop ---</span>
        <span class="c1"># Repeatedly unwrap until we hit a base type or Any</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">processed</span><span class="p">:</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

            <span class="c1"># 0. Unwrap Annotated[T, ...]</span>
            <span class="c1"># Check if the origin exists and has the name &#39;Annotated&#39;</span>
            <span class="c1"># This check is more robust than `origin is Annotated` across Python versions</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Annotated</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">core_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">core_type</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped Annotated, current type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">, metadata: </span><span class="si">{</span><span class="n">metadata</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>  <span class="c1"># Restart loop with unwrapped type</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;  Found Annotated without arguments? Treating as Any.&quot;</span><span class="p">)</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>
                    <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>

            <span class="c1"># 1. Unwrap Optional[T] (Union[T, NoneType])</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag it</span>
                <span class="c1"># Rebuild the Union without NoneType</span>
                <span class="n">non_none_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">non_none_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Simplify Union[T, None] to T</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Use UnionType to rebuild</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">|</span> <span class="n">y</span><span class="p">,</span> <span class="n">non_none_args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="c1"># Should not happen if NoneType was in args</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped Union with None, current type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>  <span class="c1"># Restart loop with the non-optional type</span>

            <span class="c1"># 2. Unwrap List[T] or Sequence[T]</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                <span class="n">is_list</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag it</span>
                <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped List/Sequence, current element type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>  <span class="c1"># List without args -&gt; List[Any]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  Unwrapped List/Sequence without args, assuming Any&quot;</span><span class="p">)</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>  <span class="c1"># Restart loop with unwrapped element type</span>

            <span class="c1"># 3. Unwrap Literal[...]</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
                <span class="c1"># Keep the Literal origin, but simplify args if possible?</span>
                <span class="c1"># No, the mapper needs the original Literal to extract choices.</span>
                <span class="c1"># Just log and break the loop for Literal.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  Hit Literal origin, stopping simplification loop.&quot;</span><span class="p">)</span>
                <span class="k">break</span>  <span class="c1"># Stop simplification here, keep Literal type</span>

        <span class="c1"># --- Post-Loop Handling ---</span>
        <span class="c1"># At this point, current_type should be the base type (int, str, datetime, Any, etc.)</span>
        <span class="c1"># or a complex type we don&#39;t simplify further (like a raw Union or a specific class)</span>
        <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">current_type</span>

        <span class="c1"># --- FIX: If the original type was a list, ensure base_type_obj reflects the *List* --- #</span>
        <span class="c1"># The simplification loop above sets current_type to the *inner* type of the list.</span>
        <span class="c1"># We need the actual List type for the mapper logic.</span>
        <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
            <span class="c1"># Determine the simplified inner type from the end of the loop</span>
            <span class="n">simplified_inner_type</span> <span class="o">=</span> <span class="n">base_type_obj</span>

            <span class="c1"># Check if the original type involved Optional wrapping the list</span>
            <span class="c1"># A simple check: was is_optional also flagged?</span>
            <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
                <span class="c1"># Reconstruct Optional[List[SimplifiedInner]]</span>
                <span class="n">reconstructed_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">simplified_inner_type</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Original was Optional[List-like]. Reconstructing List[...] | None &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;around simplified inner type </span><span class="si">{</span><span class="n">simplified_inner_type</span><span class="si">!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">reconstructed_type</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Reconstruct List[SimplifiedInner]</span>
                <span class="n">reconstructed_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">simplified_inner_type</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Original was List-like (non-optional). Reconstructing List[...] &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;around simplified inner type </span><span class="si">{</span><span class="n">simplified_inner_type</span><span class="si">!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">reconstructed_type</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Check against original type structure (might be more robust but complex?)</span>
            <span class="c1"># original_origin = get_origin(field_type)</span>
            <span class="c1"># if original_origin is Optional and get_origin(get_args(field_type)[0]) in (list, Sequence):</span>
            <span class="c1">#     # Handle Optional[List[...]] structure</span>
            <span class="c1"># elif original_origin in (list, Sequence):</span>
            <span class="c1">#     # Handle List[...] structure</span>
            <span class="c1"># else:</span>
            <span class="c1">#     # Handle complex cases like Annotated[Optional[List[...]]]</span>

            <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">reconstructed_type</span>

        <span class="c1"># --- End FIX --- #</span>

        <span class="c1"># Add check for Callable simplification</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">base_type_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">base_type_obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">base_type_obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;collections.abc&quot;</span>
            <span class="ow">and</span> <span class="n">base_type_obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Final type is complex Callable </span><span class="si">{</span><span class="n">base_type_obj</span><span class="si">!r}</span><span class="s2">, simplifying base object to Callable origin.&quot;</span>
            <span class="p">)</span>
            <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">Callable</span>

        <span class="c1"># --- Result Assembly ---</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>  <span class="c1"># Imports based on original</span>
        <span class="n">type_string</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>  <span class="c1"># Formatting based on original</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type_str&quot;</span><span class="p">:</span> <span class="n">type_string</span><span class="p">,</span>
            <span class="s2">&quot;type_obj&quot;</span><span class="p">:</span> <span class="n">base_type_obj</span><span class="p">,</span>  <span class="c1"># THIS is the crucial simplified type object</span>
            <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>
            <span class="s2">&quot;is_list&quot;</span><span class="p">:</span> <span class="n">is_list</span><span class="p">,</span>
            <span class="s2">&quot;imports&quot;</span><span class="p">:</span> <span class="n">imports</span><span class="p">,</span>
            <span class="s2">&quot;contained_dataclasses&quot;</span><span class="p">:</span> <span class="n">contained_dataclasses</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TypeHandler] Processed result: </span><span class="si">{</span><span class="n">result</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">format_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation suitable for generated code.&quot;&quot;&quot;</span>
        <span class="c1"># --- Simplified version to break recursion ---</span>
        <span class="c1"># Get the raw string representation first</span>
        <span class="n">raw_repr</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_get_raw_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

        <span class="c1"># Basic cleanup for common typing constructs</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">raw_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;typing.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Attempt to refine based on origin/args if needed (optional)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># Handle Optional[T]</span>
            <span class="n">inner_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inner_type_str</span><span class="si">}</span><span class="s2"> | None&quot;</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="c1"># Handle List[T] / Sequence[T]</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">inner_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;List[</span><span class="si">{</span><span class="n">inner_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># Prefer List for generated code</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;List[Any]&quot;</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">key_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">value_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Dict[</span><span class="si">{</span><span class="n">key_type_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;dict&quot;</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="c1"># For Callable[[A, B], R], args is ([A, B], R) in Py3.9+</span>
                <span class="c1"># For Callable[A, R], args is (A, R)</span>
                <span class="c1"># For Callable[[], R], args is ([], R)</span>
                <span class="n">param_part</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">return_part</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">param_part</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
                    <span class="n">param_str</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_part</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">param_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_part</span><span class="p">]</span>
                    <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_types</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Single argument</span>
                    <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">param_part</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>

                <span class="n">return_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">return_part</span><span class="p">)</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Callable[</span><span class="si">{</span><span class="n">param_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">return_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Callable&quot;</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Non-optional Union</span>
            <span class="n">inner_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner_types</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
            <span class="n">inner_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Literal[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner_values</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="c1"># Add other origins like Dict, Tuple, Callable if needed</span>

        <span class="c1"># Fallback to the cleaned raw representation</span>
        <span class="k">return</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;collections.abc.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_raw_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">type_obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;typing.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Use name for classes/dataclasses</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">type_obj</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="c1"># Fallback to str</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.typing.TypeHandler.format_type_string" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">format_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#pydantic2django.core.typing.TypeHandler.format_type_string" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return a string representation suitable for generated code.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/typing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">format_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation suitable for generated code.&quot;&quot;&quot;</span>
    <span class="c1"># --- Simplified version to break recursion ---</span>
    <span class="c1"># Get the raw string representation first</span>
    <span class="n">raw_repr</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_get_raw_type_string</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

    <span class="c1"># Basic cleanup for common typing constructs</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">raw_repr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;typing.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Attempt to refine based on origin/args if needed (optional)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="c1"># Handle Optional[T]</span>
        <span class="n">inner_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inner_type_str</span><span class="si">}</span><span class="s2"> | None&quot;</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="c1"># Handle List[T] / Sequence[T]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">inner_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;List[</span><span class="si">{</span><span class="n">inner_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># Prefer List for generated code</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;List[Any]&quot;</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">key_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">value_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Dict[</span><span class="si">{</span><span class="n">key_type_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">value_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;dict&quot;</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># For Callable[[A, B], R], args is ([A, B], R) in Py3.9+</span>
            <span class="c1"># For Callable[A, R], args is (A, R)</span>
            <span class="c1"># For Callable[[], R], args is ([], R)</span>
            <span class="n">param_part</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">return_part</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">param_part</span> <span class="ow">is</span> <span class="o">...</span><span class="p">:</span>
                <span class="n">param_str</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_part</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">param_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_part</span><span class="p">]</span>
                <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param_types</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Single argument</span>
                <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">param_part</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>

            <span class="n">return_type_str</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">return_part</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Callable[</span><span class="si">{</span><span class="n">param_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">return_type_str</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Callable&quot;</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Non-optional Union</span>
        <span class="n">inner_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner_types</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
        <span class="n">inner_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Literal[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inner_values</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="c1"># Add other origins like Dict, Tuple, Callable if needed</span>

    <span class="c1"># Fallback to the cleaned raw representation</span>
    <span class="k">return</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;collections.abc.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.typing.TypeHandler.get_class_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_class_name</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#pydantic2django.core.typing.TypeHandler.get_class_name" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Extract a simple, usable class name from a type object.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/typing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_class_name</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract a simple, usable class name from a type object.&quot;&quot;&quot;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

    <span class="c1"># Check for Optional[T] specifically first (Union[T, NoneType])</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Optional&quot;</span>

    <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
        <span class="c1"># Now check for other origins</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Handles Union[A, B, ...]</span>
            <span class="k">return</span> <span class="s2">&quot;Union&quot;</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;List&quot;</span>  <span class="c1"># Use capital L consistently</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Dict&quot;</span>  <span class="c1"># Use capital D consistently</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Tuple&quot;</span>  <span class="c1"># Use capital T consistently</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Set&quot;</span>  <span class="c1"># Use capital S consistently</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Callable&quot;</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Type&quot;</span>
        <span class="c1"># Fallback for other generic types</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>

    <span class="c1"># Handle non-generic types</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">type_obj</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">type_obj</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="n">type_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">PATTERNS</span><span class="p">[</span><span class="s2">&quot;angle_bracket_class&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">type_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.typing.TypeHandler.get_required_imports" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_required_imports</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#pydantic2django.core.typing.TypeHandler.get_required_imports" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Determine necessary imports by traversing a type object.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/typing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="n">type_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine necessary imports by traversing a type object.&quot;&quot;&quot;</span>
    <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">processed_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Define modules for known Pydantic types that might need explicit import</span>
    <span class="n">pydantic_module_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;EmailStr&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IPvAnyAddress&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Json&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BaseModel&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>
        <span class="c1"># Add others if needed (e.g., SecretStr, UrlStr)</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_traverse</span><span class="p">(</span><span class="n">current_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">imports</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">type_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_repr</span> <span class="ow">in</span> <span class="n">processed_types</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">processed_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_repr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># Handle unhashable types if necessary, e.g., log a warning</span>
            <span class="k">pass</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
            <span class="c1"># Handle Generic Alias (List, Dict, Union, Optional, Callable, Type)</span>
            <span class="n">origin_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">origin_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Determine the canonical name used in &#39;typing&#39; imports (e.g., List, Dict, Callable)</span>
            <span class="n">typing_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;List&quot;</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Dict&quot;</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Tuple&quot;</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">set</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Set&quot;</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">):</span>  <span class="c1"># Handle types.UnionType for Python 3.10+</span>
                <span class="c1"># We don&#39;t need to add Union or Optional imports anymore with | syntax</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Type&quot;</span>
            <span class="c1"># Check both typing.Callable and collections.abc.Callable</span>
            <span class="k">elif</span> <span class="n">origin_module</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="n">origin_name</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Callable&quot;</span>
            <span class="k">elif</span> <span class="n">origin_module</span> <span class="o">==</span> <span class="s2">&quot;collections.abc&quot;</span> <span class="ow">and</span> <span class="n">origin_name</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span><span class="p">:</span>
                <span class="n">typing_name</span> <span class="o">=</span> <span class="s2">&quot;Callable&quot;</span>
            <span class="c1"># Add more specific checks if needed (e.g., Sequence, Mapping)</span>

            <span class="c1"># Add import if we identified a standard typing construct</span>
            <span class="k">if</span> <span class="n">typing_name</span><span class="p">:</span>
                <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="n">typing_name</span><span class="p">)</span>

            <span class="c1"># Traverse arguments regardless of origin&#39;s module</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># Skip NoneType in Optional/Union</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">):</span>
                        <span class="c1"># Handle TypeVar by traversing its constraints/bound</span>
                        <span class="n">constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__constraints__&quot;</span><span class="p">,</span> <span class="p">())</span>
                        <span class="n">bound</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__bound__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
                            <span class="n">_traverse</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                            <span class="n">_traverse</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_traverse</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Recursively traverse arguments</span>
        <span class="c1"># Handle Base Types or Classes (int, str, MyClass, etc.)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">type_name</span> <span class="ow">or</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Skip builtins or types without names</span>
            <span class="k">elif</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">and</span> <span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NoneType&quot;</span><span class="p">,</span> <span class="s2">&quot;Generic&quot;</span><span class="p">):</span>
                <span class="c1"># Catch Any, etc. used directly</span>
                <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
            <span class="c1"># Check for dataclasses and Pydantic models specifically</span>
            <span class="k">elif</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">actual_module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">actual_module</span> <span class="ow">and</span> <span class="n">actual_module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">actual_module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
                <span class="c1"># Add specific imports if needed (e.g., dataclasses.dataclass, pydantic.BaseModel)</span>
                <span class="k">if</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">):</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;dataclasses&quot;</span><span class="p">,</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">)</span>
                <span class="c1"># No need to add BaseModel here usually, handled by pydantic_module_map or direct usage</span>
            <span class="k">elif</span> <span class="n">module_name</span><span class="p">:</span>
                <span class="c1"># Handle known standard library modules explicitly</span>
                <span class="n">known_stdlib</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;decimal&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="s2">&quot;pathlib&quot;</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">known_stdlib</span><span class="p">:</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>
                <span class="c1"># Handle known Pydantic types explicitly (redundant with BaseModel check?)</span>
                <span class="k">elif</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="n">pydantic_module_map</span><span class="p">:</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">pydantic_module_map</span><span class="p">[</span><span class="n">type_name</span><span class="p">],</span> <span class="n">type_name</span><span class="p">)</span>
                <span class="c1"># Assume other types defined in modules need importing</span>
                <span class="k">elif</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>  <span class="c1"># Avoid importing from main script context</span>
                    <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">current_type</span> <span class="ow">is</span> <span class="n">Any</span><span class="p">:</span>
            <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_add_import</span><span class="p">(</span><span class="n">imports</span><span class="p">,</span> <span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="s2">&quot;Any&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">):</span>
            <span class="c1"># Handle TypeVar used directly</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__constraints__&quot;</span><span class="p">,</span> <span class="p">())</span>
            <span class="n">bound</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">current_type</span><span class="p">,</span> <span class="s2">&quot;__bound__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bound</span><span class="p">:</span>
                <span class="n">_traverse</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="n">_traverse</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="c1"># Consider adding ForwardRef handling if needed:</span>
        <span class="c1"># elif isinstance(current_type, typing.ForwardRef):</span>
        <span class="c1">#     # Potentially add logic to resolve/import forward refs</span>
        <span class="c1">#     pass</span>

    <span class="n">_traverse</span><span class="p">(</span><span class="n">type_obj</span><span class="p">)</span>

    <span class="c1"># Clean up imports (unique, sorted)</span>
    <span class="n">final_imports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">unique_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">unique_names</span><span class="p">:</span>
            <span class="n">final_imports</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_names</span>
    <span class="k">return</span> <span class="n">final_imports</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.typing.TypeHandler.process_field_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_field_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#pydantic2django.core.typing.TypeHandler.process_field_type" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Process a field type to get name, flags, imports, and contained dataclasses.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/typing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_field_type</span><span class="p">(</span><span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a field type to get name, flags, imports, and contained dataclasses.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TypeHandler] Processing type: </span><span class="si">{</span><span class="n">field_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize metadata with type hint</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">contained_dataclasses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">current_type</span> <span class="o">=</span> <span class="n">field_type</span>  <span class="c1"># Keep track of the potentially unwrapped type</span>

    <span class="c1"># Helper function (remains the same)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_potential_dataclass</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_dataclass</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_contained_dataclasses</span><span class="p">(</span><span class="n">current_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">_find_contained_dataclasses</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_is_potential_dataclass</span><span class="p">(</span><span class="n">current_type</span><span class="p">):</span>
            <span class="n">contained_dataclasses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

    <span class="n">_find_contained_dataclasses</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">contained_dataclasses</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Found potential contained dataclasses: </span><span class="si">{</span><span class="p">[</span><span class="n">dc</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dc</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">contained_dataclasses</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Simplification Loop ---</span>
    <span class="c1"># Repeatedly unwrap until we hit a base type or Any</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">processed</span><span class="p">:</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>

        <span class="c1"># 0. Unwrap Annotated[T, ...]</span>
        <span class="c1"># Check if the origin exists and has the name &#39;Annotated&#39;</span>
        <span class="c1"># This check is more robust than `origin is Annotated` across Python versions</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Annotated</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">core_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">core_type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped Annotated, current type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">, metadata: </span><span class="si">{</span><span class="n">metadata</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>  <span class="c1"># Restart loop with unwrapped type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;  Found Annotated without arguments? Treating as Any.&quot;</span><span class="p">)</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>

        <span class="c1"># 1. Unwrap Optional[T] (Union[T, NoneType])</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Union</span><span class="p">,</span> <span class="n">UnionType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">is_optional</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag it</span>
            <span class="c1"># Rebuild the Union without NoneType</span>
            <span class="n">non_none_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">non_none_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Simplify Union[T, None] to T</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_none_args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Use UnionType to rebuild</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">|</span> <span class="n">y</span><span class="p">,</span> <span class="n">non_none_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="c1"># Should not happen if NoneType was in args</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped Union with None, current type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>  <span class="c1"># Restart loop with the non-optional type</span>

        <span class="c1"># 2. Unwrap List[T] or Sequence[T]</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">is_list</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag it</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unwrapped List/Sequence, current element type: </span><span class="si">{</span><span class="n">current_type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_type</span> <span class="o">=</span> <span class="n">Any</span>  <span class="c1"># List without args -&gt; List[Any]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  Unwrapped List/Sequence without args, assuming Any&quot;</span><span class="p">)</span>
            <span class="n">processed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>  <span class="c1"># Restart loop with unwrapped element type</span>

        <span class="c1"># 3. Unwrap Literal[...]</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Literal</span><span class="p">:</span>
            <span class="c1"># Keep the Literal origin, but simplify args if possible?</span>
            <span class="c1"># No, the mapper needs the original Literal to extract choices.</span>
            <span class="c1"># Just log and break the loop for Literal.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  Hit Literal origin, stopping simplification loop.&quot;</span><span class="p">)</span>
            <span class="k">break</span>  <span class="c1"># Stop simplification here, keep Literal type</span>

    <span class="c1"># --- Post-Loop Handling ---</span>
    <span class="c1"># At this point, current_type should be the base type (int, str, datetime, Any, etc.)</span>
    <span class="c1"># or a complex type we don&#39;t simplify further (like a raw Union or a specific class)</span>
    <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">current_type</span>

    <span class="c1"># --- FIX: If the original type was a list, ensure base_type_obj reflects the *List* --- #</span>
    <span class="c1"># The simplification loop above sets current_type to the *inner* type of the list.</span>
    <span class="c1"># We need the actual List type for the mapper logic.</span>
    <span class="k">if</span> <span class="n">is_list</span><span class="p">:</span>
        <span class="c1"># Determine the simplified inner type from the end of the loop</span>
        <span class="n">simplified_inner_type</span> <span class="o">=</span> <span class="n">base_type_obj</span>

        <span class="c1"># Check if the original type involved Optional wrapping the list</span>
        <span class="c1"># A simple check: was is_optional also flagged?</span>
        <span class="k">if</span> <span class="n">is_optional</span><span class="p">:</span>
            <span class="c1"># Reconstruct Optional[List[SimplifiedInner]]</span>
            <span class="n">reconstructed_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">simplified_inner_type</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Original was Optional[List-like]. Reconstructing List[...] | None &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;around simplified inner type </span><span class="si">{</span><span class="n">simplified_inner_type</span><span class="si">!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">reconstructed_type</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Reconstruct List[SimplifiedInner]</span>
            <span class="n">reconstructed_type</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">simplified_inner_type</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Original was List-like (non-optional). Reconstructing List[...] &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;around simplified inner type </span><span class="si">{</span><span class="n">simplified_inner_type</span><span class="si">!r}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">reconstructed_type</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Check against original type structure (might be more robust but complex?)</span>
        <span class="c1"># original_origin = get_origin(field_type)</span>
        <span class="c1"># if original_origin is Optional and get_origin(get_args(field_type)[0]) in (list, Sequence):</span>
        <span class="c1">#     # Handle Optional[List[...]] structure</span>
        <span class="c1"># elif original_origin in (list, Sequence):</span>
        <span class="c1">#     # Handle List[...] structure</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # Handle complex cases like Annotated[Optional[List[...]]]</span>

        <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">reconstructed_type</span>

    <span class="c1"># --- End FIX --- #</span>

    <span class="c1"># Add check for Callable simplification</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">base_type_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Callable</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="nb">hasattr</span><span class="p">(</span><span class="n">base_type_obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">base_type_obj</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;collections.abc&quot;</span>
        <span class="ow">and</span> <span class="n">base_type_obj</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;Callable&quot;</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Final type is complex Callable </span><span class="si">{</span><span class="n">base_type_obj</span><span class="si">!r}</span><span class="s2">, simplifying base object to Callable origin.&quot;</span>
        <span class="p">)</span>
        <span class="n">base_type_obj</span> <span class="o">=</span> <span class="n">Callable</span>

    <span class="c1"># --- Result Assembly ---</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>  <span class="c1"># Imports based on original</span>
    <span class="n">type_string</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>  <span class="c1"># Formatting based on original</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type_str&quot;</span><span class="p">:</span> <span class="n">type_string</span><span class="p">,</span>
        <span class="s2">&quot;type_obj&quot;</span><span class="p">:</span> <span class="n">base_type_obj</span><span class="p">,</span>  <span class="c1"># THIS is the crucial simplified type object</span>
        <span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="n">is_optional</span><span class="p">,</span>
        <span class="s2">&quot;is_list&quot;</span><span class="p">:</span> <span class="n">is_list</span><span class="p">,</span>
        <span class="s2">&quot;imports&quot;</span><span class="p">:</span> <span class="n">imports</span><span class="p">,</span>
        <span class="s2">&quot;contained_dataclasses&quot;</span><span class="p">:</span> <span class="n">contained_dataclasses</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[TypeHandler] Processed result: </span><span class="si">{</span><span class="n">result</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Import aggregation for generated code</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.imports.ImportHandler"></a>
    <div class="doc doc-contents first">


        <p>Handles import statements for generated Django models and their context classes.
Tracks and deduplicates imports from multiple sources while ensuring all necessary
dependencies are included.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImportHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles import statements for generated Django models and their context classes.</span>
<span class="sd">    Tracks and deduplicates imports from multiple sources while ensuring all necessary</span>
<span class="sd">    dependencies are included.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize empty collections for different types of imports.</span>

<span class="sd">        Args:</span>
<span class="sd">            module_mappings: Optional mapping of modules to remap (e.g. {&quot;__main__&quot;: &quot;my_app.models&quot;})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Track imports by category</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For typing and other utility imports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For Pydantic model imports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For context class and field type imports</span>

        <span class="c1"># For tracking imported names to avoid duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps type name to its module</span>

        <span class="c1"># For tracking field type dependencies we&#39;ve already processed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Module mappings to remap imports (e.g. &quot;__main__&quot; -&gt; &quot;my_app.models&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span> <span class="o">=</span> <span class="n">module_mappings</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ImportHandler initialized&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using module mappings: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds a single import based on module and name strings.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Apply module mappings</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>

        <span class="c1"># Clean name (e.g., remove generics for import statement)</span>
        <span class="n">clean_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Check if already imported</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
            <span class="c1"># Could verify module matches, but usually name is unique enough</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (from module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">clean_name</span> <span class="o">!=</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">clean_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported clean name: </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2"> (from module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Determine category</span>
        <span class="c1"># Simplistic: If module is known Pydantic, Django, or common stdlib -&gt; context</span>
        <span class="c1"># Otherwise, if it&#39;s &#39;typing&#39; -&gt; extra_type</span>
        <span class="c1"># TODO: Refine categorization if needed (e.g., dedicated django_imports set)</span>
        <span class="n">import_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clean_name</span><span class="p">)</span>  <span class="c1"># Add only name to typing imports set</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding typing import: </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># elif module.startswith(&quot;django.&quot;):</span>
        <span class="c1"># Add to a dedicated django set if we create one</span>
        <span class="c1">#    self.context_class_imports.add(import_statement)</span>
        <span class="c1">#    logger.info(f&quot;Adding Django import: {import_statement}&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default to context imports for non-typing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_statement</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding context class import: </span><span class="si">{</span><span class="n">import_statement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Mark as imported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
        <span class="k">if</span> <span class="n">clean_name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">clean_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_pydantic_model_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an import statement for a Pydantic model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_class: The Pydantic model class to import</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot add import for </span><span class="si">{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">: missing __module__ or __name__&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">module_path</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># Apply module mappings if needed</span>
        <span class="k">if</span> <span class="n">module_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
            <span class="n">actual_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">[</span><span class="n">module_path</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remapping module import: </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">actual_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">module_path</span> <span class="o">=</span> <span class="n">actual_module</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing Pydantic model import: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Skip if already imported</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">import_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Pydantic import: </span><span class="si">{</span><span class="n">import_statement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_statement</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_path</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_context_field_type_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an import statement for a context field type with recursive dependency detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type: The field type to import</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip if we&#39;ve already processed this field type</span>
        <span class="n">field_type_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_type_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already processed field type: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing context field type: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

        <span class="c1"># Try to add direct import for the field type if it&#39;s a class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

        <span class="c1"># Handle nested types in generics, unions, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_nested_types</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

        <span class="c1"># Add typing imports based on the field type string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_typing_imports</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an import for a single type object if it has module and name attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type: The type to import</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
                <span class="n">type_module</span> <span class="o">=</span> <span class="n">field_type</span><span class="o">.</span><span class="vm">__module__</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="n">field_type</span><span class="o">.</span><span class="vm">__name__</span>

                <span class="c1"># Apply module mappings if needed</span>
                <span class="k">if</span> <span class="n">type_module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
                    <span class="n">actual_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">[</span><span class="n">type_module</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remapping module import: </span><span class="si">{</span><span class="n">type_module</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">actual_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">type_module</span> <span class="o">=</span> <span class="n">actual_module</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Examining type: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2"> from module </span><span class="si">{</span><span class="n">type_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Skip built-in types and typing module types</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">type_module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;typing&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">type_module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span>
                    <span class="ow">or</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;float&quot;</span><span class="p">,</span> <span class="s2">&quot;bool&quot;</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping built-in or typing type: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Skip TypeVar definitions to avoid conflicts</span>
                <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span> <span class="ow">or</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;TypeVar&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping TypeVar definition: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2"> - will be defined locally&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Clean up any parametrized generic types for the import statement</span>
                <span class="n">clean_type_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>

                <span class="c1"># Use the original type_name (potentially with generics) for the imported_names check</span>
                <span class="k">if</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported type: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="c1"># Add to context class imports *before* marking as imported</span>
                <span class="c1"># Use the clean name for the import statement itself</span>
                <span class="n">import_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">type_module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">clean_type_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding context class import: </span><span class="si">{</span><span class="n">import_statement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_statement</span><span class="p">)</span>

                <span class="c1"># Add the original type name to imported_names to prevent re-processing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_module</span>
                <span class="c1"># Also add the cleaned name in case it&#39;s encountered separately</span>
                <span class="k">if</span> <span class="n">clean_type_name</span> <span class="o">!=</span> <span class="n">type_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">clean_type_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_module</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing type import for </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_nested_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively process nested types in generics, unions, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type: The type that might contain nested types</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle __args__ for generic types, unions, etc.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="s2">&quot;__args__&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing nested types for </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg_type</span> <span class="ow">in</span> <span class="n">field_type</span><span class="o">.</span><span class="n">__args__</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found nested type argument: </span><span class="si">{</span><span class="n">arg_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Recursively process each argument type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_context_field_type_import</span><span class="p">(</span><span class="n">arg_type</span><span class="p">)</span>

        <span class="c1"># Handle __origin__ for generic types (like List, Dict, etc.)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="s2">&quot;__origin__&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing origin type for </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">field_type</span><span class="o">.</span><span class="n">__origin__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_context_field_type_import</span><span class="p">(</span><span class="n">field_type</span><span class="o">.</span><span class="n">__origin__</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_typing_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add required typing imports based on the string representation of the field type.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type_str: String representation of the field type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for common typing constructs</span>
        <span class="k">if</span> <span class="s2">&quot;List[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span> <span class="ow">or</span> <span class="s2">&quot;list[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding List import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;List&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Dict[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span> <span class="ow">or</span> <span class="s2">&quot;dict[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Dict import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Dict&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Tuple[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span> <span class="ow">or</span> <span class="s2">&quot;tuple[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Tuple import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Tuple&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Optional[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span> <span class="ow">or</span> <span class="s2">&quot;Union[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span> <span class="ow">or</span> <span class="s2">&quot;None&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Optional import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Optional&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Union[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Union import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Union&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Callable[&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Callable import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Callable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Any&quot;</span> <span class="ow">in</span> <span class="n">field_type_str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Any import from </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Any&quot;</span><span class="p">)</span>

        <span class="c1"># Extract custom types from the field type string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_custom_types_from_string</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_custom_types_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract custom type names from a string representation of a field type.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type_str: String representation of the field type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract potential type names from the string</span>
        <span class="c1"># This regex looks for capitalized words that might be type names</span>
        <span class="n">type_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[A-Z][a-zA-Z0-9]*&quot;</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted potential type names from string </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">type_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="n">type_names</span><span class="p">:</span>
            <span class="c1"># Skip common type names that are already handled</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;List&quot;</span><span class="p">,</span> <span class="s2">&quot;Dict&quot;</span><span class="p">,</span> <span class="s2">&quot;Optional&quot;</span><span class="p">,</span> <span class="s2">&quot;Union&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;Callable&quot;</span><span class="p">,</span> <span class="s2">&quot;Any&quot;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping common typing name: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Skip if already in imported names</span>
            <span class="k">if</span> <span class="n">type_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported name: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Log potential custom type</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding potential custom type to extra_type_imports: </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Add to extra type imports - these are types that we couldn&#39;t resolve to a module</span>
            <span class="c1"># They&#39;ll need to be imported elsewhere or we might generate an error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get typing and custom type imports required for a field type.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_type_str: String representation of a field type</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with &quot;typing&quot; and &quot;custom&quot; import lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting required imports for: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_typing_imports</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

        <span class="c1"># Get custom types (non-typing types)</span>
        <span class="n">custom_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;List&quot;</span><span class="p">,</span> <span class="s2">&quot;Dict&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;Set&quot;</span><span class="p">,</span> <span class="s2">&quot;Optional&quot;</span><span class="p">,</span> <span class="s2">&quot;Union&quot;</span><span class="p">,</span> <span class="s2">&quot;Any&quot;</span><span class="p">,</span> <span class="s2">&quot;Callable&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found custom types: </span><span class="si">{</span><span class="n">custom_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Return the latest state of imports</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
            <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="n">custom_types</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        De-duplicate imports between Pydantic models and context field types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict with de-duplicated import sets</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deduplicating imports&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current pydantic imports: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current context imports: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract class names and modules from import statements</span>
        <span class="n">pydantic_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">context_classes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Handle special case for TypeVar imports</span>
        <span class="n">typevars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">import_stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot; import &quot;</span> <span class="ow">in</span> <span class="n">import_stmt</span><span class="p">:</span>
                <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; import &quot;</span><span class="p">)</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Skip __main__ and rewrite to real module paths if possible</span>
                <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping __main__ import: </span><span class="si">{</span><span class="n">import_stmt</span><span class="si">}</span><span class="s2"> - these won&#39;t work when imported&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
                    <span class="c1"># Check if it&#39;s a TypeVar to handle duplicate definitions</span>
                    <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span> <span class="ow">or</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;TypeVar&quot;</span><span class="p">:</span>
                        <span class="n">typevars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Clean up any parameterized generic types in class names</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="n">pydantic_classes</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

        <span class="k">for</span> <span class="n">import_stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot; import &quot;</span> <span class="ow">in</span> <span class="n">import_stmt</span><span class="p">:</span>
                <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; import &quot;</span><span class="p">)</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="c1"># Skip __main__ imports or rewrite to real module paths if possible</span>
                <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping __main__ import: </span><span class="si">{</span><span class="n">import_stmt</span><span class="si">}</span><span class="s2"> - these won&#39;t work when imported&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
                    <span class="c1"># Check if it&#39;s a TypeVar to handle duplicate definitions</span>
                    <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span> <span class="ow">or</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;TypeVar&quot;</span><span class="p">:</span>
                        <span class="n">typevars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Clean up any parameterized generic types in class names</span>
                    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="c1"># If this class is already imported in pydantic imports, skip it</span>
                    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">pydantic_classes</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping duplicate context import for </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">, already in pydantic imports&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">context_classes</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c1"># Rebuild import statements</span>
        <span class="n">module_to_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">pydantic_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="p">:</span>
                <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="n">deduplicated_pydantic_imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">deduplicated_pydantic_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Same for context imports</span>
        <span class="n">module_to_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">context_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="p">:</span>
                <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="n">deduplicated_context_imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">deduplicated_context_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final pydantic imports: </span><span class="si">{</span><span class="n">deduplicated_pydantic_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final context imports: </span><span class="si">{</span><span class="n">deduplicated_context_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Log any TypeVar names we&#39;re skipping</span>
        <span class="k">if</span> <span class="n">typevars</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping TypeVar imports: </span><span class="si">{</span><span class="n">typevars</span><span class="si">}</span><span class="s2"> - these will be defined locally&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pydantic&quot;</span><span class="p">:</span> <span class="n">deduplicated_pydantic_imports</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">deduplicated_context_imports</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_generic_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean generic parameters from a type name.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The type name to clean</span>

<span class="sd">        Returns:</span>
<span class="sd">            The cleaned type name without generic parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned generic type </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">cleaned</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cleaned</span>
        <span class="k">return</span> <span class="n">name</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">module_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize empty collections for different types of imports.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>module_mappings</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional mapping of modules to remap (e.g. {"<strong>main</strong>": "my_app.models"})</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize empty collections for different types of imports.</span>

<span class="sd">    Args:</span>
<span class="sd">        module_mappings: Optional mapping of modules to remap (e.g. {&quot;__main__&quot;: &quot;my_app.models&quot;})</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Track imports by category</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For typing and other utility imports</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For Pydantic model imports</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For context class and field type imports</span>

    <span class="c1"># For tracking imported names to avoid duplicates</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Maps type name to its module</span>

    <span class="c1"># For tracking field type dependencies we&#39;ve already processed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Module mappings to remap imports (e.g. &quot;__main__&quot; -&gt; &quot;my_app.models&quot;)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span> <span class="o">=</span> <span class="n">module_mappings</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ImportHandler initialized&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using module mappings: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.add_context_field_type_import" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_context_field_type_import</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.add_context_field_type_import" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add an import statement for a context field type with recursive dependency detection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_type</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The field type to import</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_context_field_type_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an import statement for a context field type with recursive dependency detection.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_type: The field type to import</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Skip if we&#39;ve already processed this field type</span>
    <span class="n">field_type_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field_type_str</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already processed field type: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing context field type: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

    <span class="c1"># Try to add direct import for the field type if it&#39;s a class</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

    <span class="c1"># Handle nested types in generics, unions, etc.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_process_nested_types</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>

    <span class="c1"># Add typing imports based on the field type string</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_typing_imports</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.add_import" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_import</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.add_import" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Adds a single import based on module and name strings.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds a single import based on module and name strings.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">or</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Apply module mappings</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>

    <span class="c1"># Clean name (e.g., remove generics for import statement)</span>
    <span class="n">clean_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Check if already imported</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
        <span class="c1"># Could verify module matches, but usually name is unique enough</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (from module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">clean_name</span> <span class="o">!=</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">clean_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported clean name: </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2"> (from module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Determine category</span>
    <span class="c1"># Simplistic: If module is known Pydantic, Django, or common stdlib -&gt; context</span>
    <span class="c1"># Otherwise, if it&#39;s &#39;typing&#39; -&gt; extra_type</span>
    <span class="c1"># TODO: Refine categorization if needed (e.g., dedicated django_imports set)</span>
    <span class="n">import_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;typing&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clean_name</span><span class="p">)</span>  <span class="c1"># Add only name to typing imports set</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding typing import: </span><span class="si">{</span><span class="n">clean_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># elif module.startswith(&quot;django.&quot;):</span>
    <span class="c1"># Add to a dedicated django set if we create one</span>
    <span class="c1">#    self.context_class_imports.add(import_statement)</span>
    <span class="c1">#    logger.info(f&quot;Adding Django import: {import_statement}&quot;)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default to context imports for non-typing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_statement</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding context class import: </span><span class="si">{</span><span class="n">import_statement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Mark as imported</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
    <span class="k">if</span> <span class="n">clean_name</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">clean_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.add_pydantic_model_import" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_pydantic_model_import</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.add_pydantic_model_import" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add an import statement for a Pydantic model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_class</code>
            </td>
            <td>
                  <code><span title="type">type</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Pydantic model class to import</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_pydantic_model_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an import statement for a Pydantic model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_class: The Pydantic model class to import</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot add import for </span><span class="si">{</span><span class="n">model_class</span><span class="si">}</span><span class="s2">: missing __module__ or __name__&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">module_path</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Apply module mappings if needed</span>
    <span class="k">if</span> <span class="n">module_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">:</span>
        <span class="n">actual_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_mappings</span><span class="p">[</span><span class="n">module_path</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remapping module import: </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">actual_module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">module_path</span> <span class="o">=</span> <span class="n">actual_module</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing Pydantic model import: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Skip if already imported</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping already imported model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">import_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding Pydantic import: </span><span class="si">{</span><span class="n">import_statement</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">import_statement</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imported_names</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.deduplicate_imports" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">deduplicate_imports</span><span class="p">()</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.deduplicate_imports" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>De-duplicate imports between Pydantic models and context field types.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="set">set</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict with de-duplicated import sets</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    De-duplicate imports between Pydantic models and context field types.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with de-duplicated import sets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deduplicating imports&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current pydantic imports: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current context imports: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract class names and modules from import statements</span>
    <span class="n">pydantic_classes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">context_classes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Handle special case for TypeVar imports</span>
    <span class="n">typevars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">import_stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot; import &quot;</span> <span class="ow">in</span> <span class="n">import_stmt</span><span class="p">:</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; import &quot;</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Skip __main__ and rewrite to real module paths if possible</span>
            <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping __main__ import: </span><span class="si">{</span><span class="n">import_stmt</span><span class="si">}</span><span class="s2"> - these won&#39;t work when imported&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
                <span class="c1"># Check if it&#39;s a TypeVar to handle duplicate definitions</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span> <span class="ow">or</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;TypeVar&quot;</span><span class="p">:</span>
                    <span class="n">typevars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Clean up any parameterized generic types in class names</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="n">pydantic_classes</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

    <span class="k">for</span> <span class="n">import_stmt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_class_imports</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot; import &quot;</span> <span class="ow">in</span> <span class="n">import_stmt</span><span class="p">:</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">import_stmt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; import &quot;</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># Skip __main__ imports or rewrite to real module paths if possible</span>
            <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping __main__ import: </span><span class="si">{</span><span class="n">import_stmt</span><span class="si">}</span><span class="s2"> - these won&#39;t work when imported&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">):</span>
                <span class="c1"># Check if it&#39;s a TypeVar to handle duplicate definitions</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span> <span class="ow">or</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s2">&quot;TypeVar&quot;</span><span class="p">:</span>
                    <span class="n">typevars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Clean up any parameterized generic types in class names</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="c1"># If this class is already imported in pydantic imports, skip it</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">pydantic_classes</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping duplicate context import for </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">, already in pydantic imports&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">context_classes</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>

    <span class="c1"># Rebuild import statements</span>
    <span class="n">module_to_classes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">pydantic_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="p">:</span>
            <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="n">deduplicated_pydantic_imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">deduplicated_pydantic_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Same for context imports</span>
    <span class="n">module_to_classes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">context_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="p">:</span>
            <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">module_to_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="n">deduplicated_context_imports</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">module_to_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">deduplicated_context_imports</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final pydantic imports: </span><span class="si">{</span><span class="n">deduplicated_pydantic_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final context imports: </span><span class="si">{</span><span class="n">deduplicated_context_imports</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Log any TypeVar names we&#39;re skipping</span>
    <span class="k">if</span> <span class="n">typevars</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping TypeVar imports: </span><span class="si">{</span><span class="n">typevars</span><span class="si">}</span><span class="s2"> - these will be defined locally&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pydantic&quot;</span><span class="p">:</span> <span class="n">deduplicated_pydantic_imports</span><span class="p">,</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">deduplicated_context_imports</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.imports.ImportHandler.get_required_imports" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_required_imports</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span></code>

<a href="#pydantic2django.core.imports.ImportHandler.get_required_imports" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get typing and custom type imports required for a field type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_type_str</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of a field type</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with "typing" and "custom" import lists</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/imports.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get typing and custom type imports required for a field type.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_type_str: String representation of a field type</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with &quot;typing&quot; and &quot;custom&quot; import lists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting required imports for: </span><span class="si">{</span><span class="n">field_type_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_typing_imports</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

    <span class="c1"># Get custom types (non-typing types)</span>
    <span class="n">custom_types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">name</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;List&quot;</span><span class="p">,</span> <span class="s2">&quot;Dict&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;Set&quot;</span><span class="p">,</span> <span class="s2">&quot;Optional&quot;</span><span class="p">,</span> <span class="s2">&quot;Union&quot;</span><span class="p">,</span> <span class="s2">&quot;Any&quot;</span><span class="p">,</span> <span class="s2">&quot;Callable&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found custom types: </span><span class="si">{</span><span class="n">custom_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return the latest state of imports</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
        <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="n">custom_types</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Context handling for non-serializable fields</strong></p>
</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.context.ModelContext"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.core.context.SourceModelType">SourceModelType</span>]</code></p>


        <p>Base class for model context classes.
Stores context information for a Django model's fields that require special handling
during conversion back to the source object (Pydantic/Dataclass).</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelContext</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]):</span>  <span class="c1"># Make ModelContext generic</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for model context classes.</span>
<span class="sd">    Stores context information for a Django model&#39;s fields that require special handling</span>
<span class="sd">    during conversion back to the source object (Pydantic/Dataclass).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">django_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span>
    <span class="n">source_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">SourceModelType</span><span class="p">]</span>  <span class="c1"># Changed from pydantic_class</span>
    <span class="n">context_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">FieldContext</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">context_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">required_context_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">fc</span><span class="o">.</span><span class="n">field_name</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fc</span><span class="o">.</span><span class="n">is_optional</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">required_fields</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">is_optional</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a field to the context storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_name: Name of the field.</span>
<span class="sd">            field_type_str: String representation of the field&#39;s type.</span>
<span class="sd">            is_optional: Whether the field is optional.</span>
<span class="sd">            is_list: Whether the field is a list.</span>
<span class="sd">            **kwargs: Additional metadata for the field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pass is_optional, is_list explicitly</span>
        <span class="n">field_context</span> <span class="o">=</span> <span class="n">FieldContext</span><span class="p">(</span>
            <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
            <span class="n">field_type_str</span><span class="o">=</span><span class="n">field_type_str</span><span class="p">,</span>
            <span class="n">is_optional</span><span class="o">=</span><span class="n">is_optional</span><span class="p">,</span>
            <span class="n">is_list</span><span class="o">=</span><span class="n">is_list</span><span class="p">,</span>
            <span class="n">additional_metadata</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate that all required context fields are present.</span>

<span class="sd">        Args:</span>
<span class="sd">            context: The context dictionary to validate</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required context fields are missing</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">missing_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_context_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required context fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_type_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the string representation type of a context field.&quot;&quot;&quot;</span>
        <span class="n">field_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span> <span class="k">if</span> <span class="n">field_context</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldContext</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a field context by name.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_name: Name of the field to find</span>

<span class="sd">        Returns:</span>
<span class="sd">            The FieldContext if found, None otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_conversion_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert context to a dictionary format suitable for conversion back to source object.&quot;&quot;&quot;</span>
        <span class="c1"># Renamed from to_dict to be more generic</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">field_name</span><span class="p">:</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the value for a context field.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_name: Name of the field</span>
<span class="sd">            value: Value to set</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the field doesn&#39;t exist in the context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> not found in context&quot;</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the value of a context field.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_name: Name of the field</span>

<span class="sd">        Returns:</span>
<span class="sd">            The field value if it exists and has been set, None otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>  <span class="c1"># Return sets for auto-dedup</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all required imports for the context class fields using TypeHandler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()}</span>

        <span class="c1"># Process each field</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Use TypeHandler with the stored type string</span>
            <span class="n">type_imports</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">(</span><span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span><span class="p">)</span>

            <span class="c1"># Add to our overall imports</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="p">[]))</span>  <span class="c1"># Example specific types</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;decimal&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="c1"># Add any other known modules TypeHandler might return</span>

            <span class="c1"># Add Optional/List based on flags</span>
            <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">is_optional</span><span class="p">:</span>
                <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Optional&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">is_list</span><span class="p">:</span>
                <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;List&quot;</span><span class="p">)</span>

        <span class="c1"># Add base source model import</span>
        <span class="n">source_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_module</span> <span class="ow">and</span> <span class="n">source_name</span> <span class="ow">and</span> <span class="n">source_module</span> <span class="o">!=</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">source_module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Add BaseModel or dataclass import</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;from pydantic import BaseModel&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">):</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;from dataclasses import dataclass&quot;</span><span class="p">)</span>

        <span class="c1"># Add Any import if needed</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;Any&quot;</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">field_type_str</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Any&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imports</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_context_class_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_context</span><span class="p">:</span> <span class="s2">&quot;ModelContext&quot;</span><span class="p">,</span> <span class="n">jinja_env</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a string representation of the context class.</span>

<span class="sd">        Args:</span>
<span class="sd">            model_context: The ModelContext to generate a class for</span>
<span class="sd">            jinja_env: Optional Jinja2 environment to use for rendering</span>

<span class="sd">        Returns:</span>
<span class="sd">            String representation of the context class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a ContextClassGenerator and use it to generate the class</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">ContextClassGenerator</span><span class="p">(</span><span class="n">jinja_env</span><span class="o">=</span><span class="n">jinja_env</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_context_class</span><span class="p">(</span><span class="n">model_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.add_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_type_str</span><span class="p">,</span> <span class="n">is_optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.add_field" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Add a field to the context storage.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the field.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>field_type_str</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of the field's type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_optional</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the field is optional.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_list</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether the field is a list.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional metadata for the field.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_field</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">field_type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_optional</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">is_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a field to the context storage.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_name: Name of the field.</span>
<span class="sd">        field_type_str: String representation of the field&#39;s type.</span>
<span class="sd">        is_optional: Whether the field is optional.</span>
<span class="sd">        is_list: Whether the field is a list.</span>
<span class="sd">        **kwargs: Additional metadata for the field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pass is_optional, is_list explicitly</span>
    <span class="n">field_context</span> <span class="o">=</span> <span class="n">FieldContext</span><span class="p">(</span>
        <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
        <span class="n">field_type_str</span><span class="o">=</span><span class="n">field_type_str</span><span class="p">,</span>
        <span class="n">is_optional</span><span class="o">=</span><span class="n">is_optional</span><span class="p">,</span>
        <span class="n">is_list</span><span class="o">=</span><span class="n">is_list</span><span class="p">,</span>
        <span class="n">additional_metadata</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_context</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.generate_context_class_code" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_context_class_code</span><span class="p">(</span><span class="n">model_context</span><span class="p">,</span> <span class="n">jinja_env</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.core.context.ModelContext.generate_context_class_code" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate a string representation of the context class.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelContext (pydantic2django.core.context.ModelContext)" href="#pydantic2django.core.context.ModelContext">ModelContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ModelContext to generate a class for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>jinja_env</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Jinja2 environment to use for rendering</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String representation of the context class</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_context_class_code</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_context</span><span class="p">:</span> <span class="s2">&quot;ModelContext&quot;</span><span class="p">,</span> <span class="n">jinja_env</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a string representation of the context class.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_context: The ModelContext to generate a class for</span>
<span class="sd">        jinja_env: Optional Jinja2 environment to use for rendering</span>

<span class="sd">    Returns:</span>
<span class="sd">        String representation of the context class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a ContextClassGenerator and use it to generate the class</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">ContextClassGenerator</span><span class="p">(</span><span class="n">jinja_env</span><span class="o">=</span><span class="n">jinja_env</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate_context_class</span><span class="p">(</span><span class="n">model_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.get_field_by_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.get_field_by_name" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get a field context by name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the field to find</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="FieldContext


  
      dataclass
   (pydantic2django.core.context.FieldContext)" href="../../reference/pydantic2django/core/context/#pydantic2django.core.context.FieldContext">FieldContext</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FieldContext if found, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_field_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FieldContext</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a field context by name.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_name: Name of the field to find</span>

<span class="sd">    Returns:</span>
<span class="sd">        The FieldContext if found, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.get_field_type_str" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_field_type_str</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.get_field_type_str" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the string representation type of a context field.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_field_type_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the string representation type of a context field.&quot;&quot;&quot;</span>
    <span class="n">field_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span> <span class="k">if</span> <span class="n">field_context</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.get_required_imports" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_required_imports</span><span class="p">()</span></code>

<a href="#pydantic2django.core.context.ModelContext.get_required_imports" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get all required imports for the context class fields using TypeHandler.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_required_imports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>  <span class="c1"># Return sets for auto-dedup</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all required imports for the context class fields using TypeHandler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()}</span>

    <span class="c1"># Process each field</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Use TypeHandler with the stored type string</span>
        <span class="n">type_imports</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">(</span><span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span><span class="p">)</span>

        <span class="c1"># Add to our overall imports</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;typing&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="p">[]))</span>  <span class="c1"># Example specific types</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;decimal&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">type_imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="c1"># Add any other known modules TypeHandler might return</span>

        <span class="c1"># Add Optional/List based on flags</span>
        <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">is_optional</span><span class="p">:</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Optional&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">is_list</span><span class="p">:</span>
            <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;List&quot;</span><span class="p">)</span>

    <span class="c1"># Add base source model import</span>
    <span class="n">source_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">source_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source_module</span> <span class="ow">and</span> <span class="n">source_name</span> <span class="ow">and</span> <span class="n">source_module</span> <span class="o">!=</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">source_module</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Add BaseModel or dataclass import</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;from pydantic import BaseModel&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class</span><span class="p">):</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;from dataclasses import dataclass&quot;</span><span class="p">)</span>

    <span class="c1"># Add Any import if needed</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;Any&quot;</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">field_type_str</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Any&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">imports</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.get_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_value</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.get_value" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Get the value of a context field.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the field</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The field value if it exists and has been set, None otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the value of a context field.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_name: Name of the field</span>

<span class="sd">    Returns:</span>
<span class="sd">        The field value if it exists and has been set, None otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.set_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_value</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.set_value" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Set the value for a context field.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>field_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the field</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Value to set</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the field doesn't exist in the context</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the value for a context field.</span>

<span class="sd">    Args:</span>
<span class="sd">        field_name: Name of the field</span>
<span class="sd">        value: Value to set</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the field doesn&#39;t exist in the context</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> not found in context&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.to_conversion_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_conversion_dict</span><span class="p">()</span></code>

<a href="#pydantic2django.core.context.ModelContext.to_conversion_dict" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert context to a dictionary format suitable for conversion back to source object.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_conversion_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert context to a dictionary format suitable for conversion back to source object.&quot;&quot;&quot;</span>
    <span class="c1"># Renamed from to_dict to be more generic</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">field_name</span><span class="p">:</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ModelContext.validate_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ModelContext.validate_context" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Validate that all required context fields are present.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The context dictionary to validate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required context fields are missing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate that all required context fields are present.</span>

<span class="sd">    Args:</span>
<span class="sd">        context: The context dictionary to validate</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required context fields are missing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">missing_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_context_keys</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required context fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.core.context.ContextClassGenerator"></a>
    <div class="doc doc-contents first">


        <p>Utility class for generating context class code from ModelContext objects.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContextClassGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility class for generating context class code from ModelContext objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jinja_env</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ContextClassGenerator.</span>

<span class="sd">        Args:</span>
<span class="sd">            jinja_env: Optional Jinja2 environment to use for template rendering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">jinja_env</span>
        <span class="c1"># Initialize imports needed for the context class generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load Jinja2 template.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback to basic string formatting if Jinja2 is not available</span>
            <span class="c1"># Note: This is a simplified fallback and might not handle complex templates</span>
            <span class="c1"># Load template content from file or define as string here</span>
            <span class="c1"># Example using basic string formatting:</span>
            <span class="c1"># template_content = &quot;... {model_name} ... {field_definitions} ...&quot;</span>
            <span class="c1"># return template_content</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Jinja2 environment not provided for template loading.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify_type_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simplifies complex type strings for cleaner code generation.</span>
<span class="sd">        Removes module paths like &#39;typing.&#39; or full paths for common types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Basic simplification: remove typing module path</span>
        <span class="n">simplified</span> <span class="o">=</span> <span class="n">type_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;typing.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Use TypeHandler to potentially clean further if needed</span>
        <span class="c1"># simplified = TypeHandler.clean_type_string(simplified)</span>

        <span class="c1"># Regex to remove full paths for nested standard types like list, dict, etc.</span>
        <span class="c1"># Define common standard types that might appear with full paths</span>
        <span class="n">standard_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">,</span> <span class="s2">&quot;tuple&quot;</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="s2">&quot;Optional&quot;</span><span class="p">,</span> <span class="s2">&quot;Union&quot;</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">replacer_class</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># Extract the class name after the last dot</span>
            <span class="n">class_name</span> <span class="o">=</span> <span class="n">full_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Check if the extracted class name is a standard type we want to simplify</span>
            <span class="k">if</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">standard_types</span><span class="p">:</span>
                <span class="c1"># If it is, return just the class name</span>
                <span class="k">return</span> <span class="n">class_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, keep the full path (or handle custom imports)</span>
                <span class="c1"># For now, keeping full path for non-standard types</span>
                <span class="c1"># self._maybe_add_type_to_imports(full_path) # Add import for custom type</span>
                <span class="k">return</span> <span class="n">full_path</span>

        <span class="c1"># Pattern to find qualified names (e.g., some.module.ClassName)</span>
        <span class="c1"># This needs careful crafting to avoid unintended replacements</span>
        <span class="c1"># Example: r&#39;\b([a-zA-Z_][\w\.]*\.)?([A-Z][a-zA-Z0-9_]*)\b&#39; might be too broad</span>
        <span class="c1"># Focusing on paths likely coming from TypeHandler.get_required_imports might be safer</span>
        <span class="c1"># For now, rely on basic replace and potential TypeHandler cleaning</span>

        <span class="k">return</span> <span class="n">simplified</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_context_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_context</span><span class="p">:</span> <span class="n">ModelContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the Python code string for a context dataclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_template</span><span class="p">(</span><span class="s2">&quot;context_class.py.j2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="n">model_context</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">()</span>  <span class="c1"># Get imports first</span>

        <span class="n">field_definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field_type_str</span> <span class="o">=</span> <span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span>  <span class="c1"># field_type is now the string representation</span>

            <span class="c1"># Use TypeHandler._get_raw_type_string to get the clean, unquoted type string</span>
            <span class="c1"># --- Corrected import path for TypeHandler ---</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeHandler</span>

            <span class="n">clean_type</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_get_raw_type_string</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

            <span class="c1"># Simplify the type string for display</span>
            <span class="n">simplified_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplify_type_string</span><span class="p">(</span><span class="n">clean_type</span><span class="p">)</span>

            <span class="c1"># Add necessary imports based on the simplified type</span>
            <span class="c1"># (Assuming _simplify_type_string and get_required_imports handle this)</span>

            <span class="c1"># Format default value if present</span>
            <span class="n">default_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">field_context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

            <span class="n">field_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">simplified_type</span><span class="si">}</span><span class="s2"> = field(default=</span><span class="si">{</span><span class="n">default_repr</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_def</span><span class="p">)</span>

        <span class="c1"># Prepare imports for the template</span>
        <span class="n">typing_imports_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]))</span>
        <span class="n">custom_imports_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">])</span>  <span class="c1"># Keep as list of strings</span>

        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_context</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">source_class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_context</span><span class="o">.</span><span class="n">source_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="c1"># Use source_class_name instead of pydantic_class</span>
            <span class="n">source_class_name</span><span class="o">=</span><span class="n">source_class_name</span><span class="p">,</span>
            <span class="n">source_module</span><span class="o">=</span><span class="n">model_context</span><span class="o">.</span><span class="n">source_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="n">field_definitions</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_definitions</span><span class="p">),</span>
            <span class="n">typing_imports</span><span class="o">=</span><span class="n">typing_imports_str</span><span class="p">,</span>
            <span class="n">custom_imports</span><span class="o">=</span><span class="n">custom_imports_list</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_generic_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove generic parameters like [T] from class names.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ContextClassGenerator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">jinja_env</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ContextClassGenerator.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize the ContextClassGenerator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>jinja_env</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional Jinja2 environment to use for template rendering.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jinja_env</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the ContextClassGenerator.</span>

<span class="sd">    Args:</span>
<span class="sd">        jinja_env: Optional Jinja2 environment to use for template rendering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">jinja_env</span>
    <span class="c1"># Initialize imports needed for the context class generation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.core.context.ContextClassGenerator.generate_context_class" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_context_class</span><span class="p">(</span><span class="n">model_context</span><span class="p">)</span></code>

<a href="#pydantic2django.core.context.ContextClassGenerator.generate_context_class" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates the Python code string for a context dataclass.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/context.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_context_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_context</span><span class="p">:</span> <span class="n">ModelContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the Python code string for a context dataclass.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_template</span><span class="p">(</span><span class="s2">&quot;context_class.py.j2&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="n">model_context</span><span class="o">.</span><span class="n">get_required_imports</span><span class="p">()</span>  <span class="c1"># Get imports first</span>

    <span class="n">field_definitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_context</span> <span class="ow">in</span> <span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">field_type_str</span> <span class="o">=</span> <span class="n">field_context</span><span class="o">.</span><span class="n">field_type_str</span>  <span class="c1"># field_type is now the string representation</span>

        <span class="c1"># Use TypeHandler._get_raw_type_string to get the clean, unquoted type string</span>
        <span class="c1"># --- Corrected import path for TypeHandler ---</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeHandler</span>

        <span class="n">clean_type</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">_get_raw_type_string</span><span class="p">(</span><span class="n">field_type_str</span><span class="p">)</span>

        <span class="c1"># Simplify the type string for display</span>
        <span class="n">simplified_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplify_type_string</span><span class="p">(</span><span class="n">clean_type</span><span class="p">)</span>

        <span class="c1"># Add necessary imports based on the simplified type</span>
        <span class="c1"># (Assuming _simplify_type_string and get_required_imports handle this)</span>

        <span class="c1"># Format default value if present</span>
        <span class="n">default_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">field_context</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_context</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

        <span class="n">field_def</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">simplified_type</span><span class="si">}</span><span class="s2"> = field(default=</span><span class="si">{</span><span class="n">default_repr</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_def</span><span class="p">)</span>

    <span class="c1"># Prepare imports for the template</span>
    <span class="n">typing_imports_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s2">&quot;typing&quot;</span><span class="p">]))</span>
    <span class="n">custom_imports_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imports</span><span class="p">[</span><span class="s2">&quot;custom&quot;</span><span class="p">])</span>  <span class="c1"># Keep as list of strings</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_context</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">source_class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">model_context</span><span class="o">.</span><span class="n">source_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="c1"># Use source_class_name instead of pydantic_class</span>
        <span class="n">source_class_name</span><span class="o">=</span><span class="n">source_class_name</span><span class="p">,</span>
        <span class="n">source_module</span><span class="o">=</span><span class="n">model_context</span><span class="o">.</span><span class="n">source_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
        <span class="n">field_definitions</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_definitions</span><span class="p">),</span>
        <span class="n">typing_imports</span><span class="o">=</span><span class="n">typing_imports_str</span><span class="p">,</span>
        <span class="n">custom_imports</span><span class="o">=</span><span class="n">custom_imports_list</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p><strong>Serialization helpers</strong></p>
</li>
<li>


<div class="doc doc-object doc-function">



<a id="pydantic2django.core.serialization.serialize_value"></a>
    <div class="doc doc-contents first">

        <p>Serialize a value using the most appropriate method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value to serialize</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The serialized value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/serialization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serialize a value using the most appropriate method.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: The value to serialize</span>

<span class="sd">    Returns:</span>
<span class="sd">        The serialized value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span><span class="p">,</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">get_serialization_method</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
        <span class="c1"># If no serialization method is found, return the value as is</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">serializer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If serialization fails, return the string representation</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div></li>
<li>


<div class="doc doc-object doc-function">



<a id="pydantic2django.core.serialization.get_serialization_method"></a>
    <div class="doc doc-contents first">

        <p>Get the appropriate serialization method for an object.</p>
<p>This function checks for various serialization methods in order of preference:
1. model_dump (Pydantic)
2. to_json
3. to_dict
4. <strong>str</strong> (if overridden)
5. <strong>dict</strong></p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>obj</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The object to check for serialization methods</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<a class="autorefs autorefs-internal" title="SerializationMethod (pydantic2django.core.serialization.SerializationMethod)" href="../../reference/pydantic2django/core/serialization/#pydantic2django.core.serialization.SerializationMethod">SerializationMethod</a>, <span title="typing.Optional">Optional</span>[<span title="collections.abc.Callable">Callable</span>[[], <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (SerializationMethod, Optional[Callable]). The callable is None if no method is found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/core/serialization.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_serialization_method</span><span class="p">(</span>
    <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SerializationMethod</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the appropriate serialization method for an object.</span>

<span class="sd">    This function checks for various serialization methods in order of preference:</span>
<span class="sd">    1. model_dump (Pydantic)</span>
<span class="sd">    2. to_json</span>
<span class="sd">    3. to_dict</span>
<span class="sd">    4. __str__ (if overridden)</span>
<span class="sd">    5. __dict__</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: The object to check for serialization methods</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of (SerializationMethod, Optional[Callable]). The callable is None if no method is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for Pydantic model_dump</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">MODEL_DUMP</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">model_dump</span>

    <span class="c1"># Check for to_json method</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;to_json&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">TO_JSON</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_json</span>

    <span class="c1"># Check for to_dict method</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;to_dict&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">TO_DICT</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_dict</span>

    <span class="c1"># Check for overridden __str__ method</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__str__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="fm">__str__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__str__</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">STR</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__str__</span>

    <span class="c1"># Check for __dict__ attribute</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">):</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">dict_serializer</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;__class__&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">DICT</span><span class="p">,</span> <span class="n">dict_serializer</span>

    <span class="k">return</span> <span class="n">SerializationMethod</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div></li>
</ul>
<h3 id="what-all-implementations-have-in-common">What all implementations have in common<a class="headerlink" href="#what-all-implementations-have-in-common" title="Permanent link">&para;</a></h3>
<p>Each implementation integrates the same core concepts:</p>
<ul>
<li>A <code>Discovery</code> that lists eligible source models and computes a safe registration order.</li>
<li>A <code>ModelFactory</code> and <code>FieldFactory</code> pair that build Django fields using the shared <code>BidirectionalTypeMapper</code>.</li>
<li>A <code>Generator</code> that subclasses <code>BaseStaticGenerator</code>, wires up discovery/factories, and prepares template context.</li>
<li>Use of <code>RelationshipConversionAccessor</code> so relationship fields (FK/O2O/M2M) can be resolved across generated models.</li>
<li>Shared <code>ImportHandler</code>, <code>TypeHandler</code>, and <code>ModelContext</code> mechanisms.</li>
</ul>
<h3 id="implementations">Implementations<a class="headerlink" href="#implementations" title="Permanent link">&para;</a></h3>
<h4 id="pydantic">Pydantic<a class="headerlink" href="#pydantic" title="Permanent link">&para;</a></h4>
<ul>
<li>Discovery, factory, and generator:</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.pydantic.discovery.PydanticDiscovery"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDiscovery (pydantic2django.core.discovery.BaseDiscovery)" href="#pydantic2django.core.discovery.BaseDiscovery">BaseDiscovery</a>[<span title="type">type</span>[<span title="pydantic.BaseModel">BaseModel</span>]]</code></p>


        <p>Discovers Pydantic models within specified packages.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/pydantic/discovery.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PydanticDiscovery</span><span class="p">(</span><span class="n">BaseDiscovery</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovers Pydantic models within specified packages.&quot;&quot;&quot;</span>

    <span class="c1"># __init__ is inherited and sufficient</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_target_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object is a Pydantic BaseModel, excluding the base itself.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">BaseModel</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_eligibility_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check default eligibility: not abstract and not inheriting directly from ABC.&quot;&quot;&quot;</span>
        <span class="c1"># Skip models that directly inherit from ABC</span>
        <span class="k">if</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering out </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (inherits directly from ABC)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Skip models that are marked as abstract</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering out </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (marked as __abstract__)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Example for potentially filtering Pydantic internal models (uncomment if needed)</span>
        <span class="c1"># if model.__module__.startswith(&#39;pydantic._internal&#39;):</span>
        <span class="c1">#     logger.debug(f&quot;Filtering out internal Pydantic model: {model.__name__}&quot;)</span>
        <span class="c1">#     return False</span>

        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Eligible by default</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">user_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover Pydantic models in the specified packages, applying filters.&quot;&quot;&quot;</span>
        <span class="c1"># Pass user_filters directly to the base class method</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">discover_models</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">user_filters</span><span class="o">=</span><span class="n">user_filters</span><span class="p">)</span>

    <span class="c1"># --- analyze_dependencies and get_models_in_registration_order remain ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the dependency graph for the filtered Pydantic models.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered Pydantic models...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">model_type</span><span class="p">:</span>
                <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Initialize if missing (shouldn&#39;t happen often with new base discover_models)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> wasn&#39;t pre-initialized in dependencies dict during analysis. Initializing now.&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dep_model_obj</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for model &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not object in filtered set.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Initialize keys based on filtered models (important step)</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Analyze fields</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model_type</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">annotation</span>
                <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

                <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="n">arg_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">arg_origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">nested_model_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">nested_model_type</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dependency analysis complete.&quot;</span><span class="p">)</span>
        <span class="c1"># Debug logging moved inside BaseDiscovery</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return models sorted topologically based on dependencies.</span>
<span class="sd">        Models with no dependencies come first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No dependencies found or analyzed, returning Pydantic models in arbitrary order.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">sorted_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visiting</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">filtered_model_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visiting</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circular dependency detected involving Pydantic model </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Option: raise TypeError(...)</span>
                <span class="k">return</span>  <span class="c1"># Break cycle</span>

            <span class="n">visiting</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="c1"># Use .get for safety, ensure deps are also in filtered set</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">filtered_model_objects</span><span class="p">:</span>
                        <span class="n">visit</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

            <span class="n">visiting</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">sorted_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">all_target_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">all_target_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pydantic models sorted for registration: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted_models</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_models</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.discovery.PydanticDiscovery.analyze_dependencies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_dependencies</span><span class="p">()</span></code>

<a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.analyze_dependencies" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Build the dependency graph for the filtered Pydantic models.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the dependency graph for the filtered Pydantic models.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered Pydantic models...&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">model_type</span><span class="p">:</span>
            <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Initialize if missing (shouldn&#39;t happen often with new base discover_models)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> wasn&#39;t pre-initialized in dependencies dict during analysis. Initializing now.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dep_model_obj</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for model &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not object in filtered set.&quot;</span>
                <span class="p">)</span>

    <span class="c1"># Initialize keys based on filtered models (important step)</span>
    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Analyze fields</span>
    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model_type</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">annotation</span>
            <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">arg_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">arg_origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">nested_model_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                        <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">nested_model_type</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dependency analysis complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.discovery.PydanticDiscovery.discover_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">discover_models</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">user_filters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.discover_models" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Discover Pydantic models in the specified packages, applying filters.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discover_models</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover Pydantic models in the specified packages, applying filters.&quot;&quot;&quot;</span>
    <span class="c1"># Pass user_filters directly to the base class method</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">discover_models</span><span class="p">(</span><span class="n">packages</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">user_filters</span><span class="o">=</span><span class="n">user_filters</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.discovery.PydanticDiscovery.get_models_in_registration_order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_models_in_registration_order</span><span class="p">()</span></code>

<a href="#pydantic2django.pydantic.discovery.PydanticDiscovery.get_models_in_registration_order" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return models sorted topologically based on dependencies.
Models with no dependencies come first.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return models sorted topologically based on dependencies.</span>
<span class="sd">    Models with no dependencies come first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No dependencies found or analyzed, returning Pydantic models in arbitrary order.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">sorted_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">visiting</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">filtered_model_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visiting</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circular dependency detected involving Pydantic model </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Option: raise TypeError(...)</span>
            <span class="k">return</span>  <span class="c1"># Break cycle</span>

        <span class="n">visiting</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="c1"># Use .get for safety, ensure deps are also in filtered set</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">filtered_model_objects</span><span class="p">:</span>
                    <span class="n">visit</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="n">visiting</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">sorted_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">all_target_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">all_target_models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">visit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pydantic models sorted for registration: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted_models</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sorted_models</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.pydantic.factory.PydanticModelFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseModelFactory (pydantic2django.core.factories.BaseModelFactory)" href="#pydantic2django.core.factories.BaseModelFactory">BaseModelFactory</a>[<span title="type">type</span>[<span title="pydantic.BaseModel">BaseModel</span>], <span title="pydantic.fields.FieldInfo">FieldInfo</span>]</code></p>


        <p>Creates Django models from Pydantic models.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PydanticModelFactory</span><span class="p">(</span><span class="n">BaseModelFactory</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates Django models from Pydantic models.&quot;&quot;&quot;</span>

    <span class="c1"># Cache specific to Pydantic models</span>
    <span class="n">_converted_models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span>
    <span class="c1"># No need for field_factory instance here if Base class handles it</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_factory</span><span class="p">:</span> <span class="n">PydanticFieldFactory</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with field factory and relationship accessor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
        <span class="c1"># Pass the field_factory up to the base class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="o">=</span><span class="n">field_factory</span><span class="p">)</span>

    <span class="c1"># Overrides the base method to add caching and relationship mapping</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a Django model from Pydantic, checking cache first and mapping relationships.&quot;&quot;&quot;</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Attempting to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --- Check Cache --- #</span>
        <span class="k">if</span> <span class="n">model_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Using cached conversion result for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cached_carrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
            <span class="c1"># Update the passed-in carrier with cached results</span>
            <span class="n">carrier</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cached_carrier</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="c1"># Ensure used_related_names is properly updated (dict update might not merge sets correctly)</span>
            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">cached_carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># --- Call Base Implementation for Core Logic --- #</span>
        <span class="c1"># This calls _process_source_fields, _assemble_django_model_class etc.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

        <span class="c1"># --- Register Relationship Mapping (if successful) --- #</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;PydanticFactory: Registering mapping for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">map_relationship</span><span class="p">(</span>
                <span class="n">source_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span>
            <span class="p">)</span>

        <span class="c1"># --- Cache Result --- #</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Caching conversion result for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Store a copy to prevent modification issues? Simple assignment for now.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;PydanticFactory: Failed to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">. Invalid fields: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># --- Implementation of Abstract Methods --- #</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_source_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate through Pydantic fields and convert them using the field factory.&quot;&quot;&quot;</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">for</span> <span class="n">field_name_original</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">get_model_fields</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">source_model</span><span class="p">))</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">alias</span> <span class="ow">or</span> <span class="n">field_name_original</span>

            <span class="c1"># Normalize the output Django field identifier consistently with XML/dataclass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">..core.utils.naming</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_field_identifier</span>

                <span class="n">normalized_field_name</span> <span class="o">=</span> <span class="n">sanitize_field_identifier</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">normalized_field_name</span> <span class="o">=</span> <span class="n">field_name</span>

            <span class="c1"># Skip &#39;id&#39; field if updating an existing model definition</span>
            <span class="c1"># Note: _handle_id_field in field factory handles primary key logic</span>
            <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping &#39;id&#39; field for existing model update: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Cast needed because BaseFactory uses generic TFieldInfo</span>
            <span class="n">field_factory_typed</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticFieldFactory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span><span class="p">)</span>
            <span class="n">conversion_result</span> <span class="o">=</span> <span class="n">field_factory_typed</span><span class="o">.</span><span class="n">create_field</span><span class="p">(</span>
                <span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">carrier</span><span class="o">=</span><span class="n">carrier</span>
            <span class="p">)</span>

            <span class="c1"># Store results in the carrier</span>
            <span class="k">if</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">django_field</span><span class="p">:</span>
                <span class="c1"># Store definition string first</span>
                <span class="k">if</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">field_definition_str</span><span class="p">:</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">field_definition_str</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Missing field definition string for successfully created field &#39;</span><span class="si">{</span><span class="n">normalized_field_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Store the field instance itself</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">conversion_result</span><span class="o">.</span><span class="n">django_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">django_field</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">django_field</span>

            <span class="k">elif</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">context_field</span><span class="p">:</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">context_field</span>
            <span class="k">elif</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">error_str</span><span class="p">:</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">normalized_field_name</span><span class="p">,</span> <span class="n">conversion_result</span><span class="o">.</span><span class="n">error_str</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Should not happen if FieldConversionResult is used correctly</span>
                <span class="n">error</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Field factory returned unexpected empty result for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name_original</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">normalized_field_name</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_pydantic_model_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the ModelContext specifically for Pydantic source models.&quot;&quot;&quot;</span>
        <span class="c1"># Renamed to match base class expectation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_model_context</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

    <span class="c1"># Actual implementation of the abstract method</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_model_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the ModelContext specifically for Pydantic source models.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping context build: missing source or django model.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_context</span> <span class="o">=</span> <span class="n">ModelContext</span><span class="p">(</span>  <span class="c1"># Removed generic type hint for base class compatibility</span>
                <span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">,</span>
                <span class="n">source_class</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">FieldInfo</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">optional</span> <span class="o">=</span> <span class="n">is_pydantic_model_field_optional</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="c1"># Use repr() for field_type_str as expected by ModelContext.add_field</span>
                    <span class="n">field_type_str</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">model_context</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                        <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                        <span class="n">field_type_str</span><span class="o">=</span><span class="n">field_type_str</span><span class="p">,</span>  <span class="c1"># Pass string representation</span>
                        <span class="n">is_optional</span><span class="o">=</span><span class="n">optional</span><span class="p">,</span>
                        <span class="n">annotation</span><span class="o">=</span><span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span><span class="p">,</span>  <span class="c1"># Keep annotation if needed elsewhere</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">FieldInfo</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; has no annotation, cannot add to ModelContext.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Context field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is not a FieldInfo (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">field_info</span><span class="p">)</span><span class="si">}</span><span class="s2">), cannot add to ModelContext.&quot;</span>
                    <span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="n">model_context</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully built ModelContext for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Call model_key()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to build ModelContext for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.factory.PydanticModelFactory.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">)</span></code>

<a href="#pydantic2django.pydantic.factory.PydanticModelFactory.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize with field factory and relationship accessor.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_factory</span><span class="p">:</span> <span class="n">PydanticFieldFactory</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize with field factory and relationship accessor.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
    <span class="c1"># Pass the field_factory up to the base class</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="o">=</span><span class="n">field_factory</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.factory.PydanticModelFactory.make_django_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.pydantic.factory.PydanticModelFactory.make_django_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Creates a Django model from Pydantic, checking cache first and mapping relationships.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a Django model from Pydantic, checking cache first and mapping relationships.&quot;&quot;&quot;</span>
    <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Attempting to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># --- Check Cache --- #</span>
    <span class="k">if</span> <span class="n">model_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Using cached conversion result for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cached_carrier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
        <span class="c1"># Update the passed-in carrier with cached results</span>
        <span class="n">carrier</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cached_carrier</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="c1"># Ensure used_related_names is properly updated (dict update might not merge sets correctly)</span>
        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">cached_carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># --- Call Base Implementation for Core Logic --- #</span>
    <span class="c1"># This calls _process_source_fields, _assemble_django_model_class etc.</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

    <span class="c1"># --- Register Relationship Mapping (if successful) --- #</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PydanticFactory: Registering mapping for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">map_relationship</span><span class="p">(</span>
            <span class="n">source_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span>
        <span class="p">)</span>

    <span class="c1"># --- Cache Result --- #</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PydanticFactory: Caching conversion result for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Store a copy to prevent modification issues? Simple assignment for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PydanticFactory: Failed to create Django model for </span><span class="si">{</span><span class="n">model_key</span><span class="si">}</span><span class="s2">. Invalid fields: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.pydantic.factory.PydanticFieldFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseFieldFactory (pydantic2django.core.factories.BaseFieldFactory)" href="#pydantic2django.core.factories.BaseFieldFactory">BaseFieldFactory</a>[<span title="pydantic.fields.FieldInfo">FieldInfo</span>]</code></p>


        <p>Creates Django fields from Pydantic fields (FieldInfo).</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PydanticFieldFactory</span><span class="p">(</span><span class="n">BaseFieldFactory</span><span class="p">[</span><span class="n">FieldInfo</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates Django fields from Pydantic fields (FieldInfo).&quot;&quot;&quot;</span>

    <span class="c1"># Dependencies injected</span>
    <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span>
    <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes with dependencies.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">bidirectional_mapper</span>
        <span class="c1"># No super().__init__() needed</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">FieldInfo</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a Pydantic FieldInfo to a Django field instance.</span>
<span class="sd">        Implements the abstract method from BaseFieldFactory.</span>
<span class="sd">        Uses BidirectionalTypeMapper and local instantiation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use alias first, then the actual key from model_fields as name</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">alias</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">field_info</span><span class="p">),</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Initialize result with the source field info and determined name</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">FieldConversionResult</span><span class="p">(</span><span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Handle potential &#39;id&#39; field conflict</span>
            <span class="k">if</span> <span class="n">id_field</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_id_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">id_field</span>
                <span class="c1"># Need to capture kwargs for serialization if possible</span>
                <span class="c1"># For now, assume default kwargs for ID fields</span>
                <span class="c1"># TODO: Extract actual kwargs used in _handle_id_field</span>
                <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">):</span>
                    <span class="k">pass</span>  <span class="c1"># No extra kwargs needed typically</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># AutoField</span>
                    <span class="k">pass</span>  <span class="c1"># No extra kwargs needed typically</span>

                <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>  <span class="c1"># ID field handled, return early</span>

            <span class="c1"># Get field type from annotation</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; has no annotation, treating as context field.&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># --- Use BidirectionalTypeMapper --- #</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">django_field_class</span><span class="p">,</span> <span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="o">.</span><span class="n">get_django_mapping</span><span class="p">(</span>
                    <span class="n">python_type</span><span class="o">=</span><span class="n">field_type</span><span class="p">,</span> <span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">MappingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle errors specifically from the mapper (e.g., missing relationship)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping error for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Treat as context on mapping error</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Handle unexpected errors during mapping lookup</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error getting Django mapping for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected mapping error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Store raw kwargs before modifications/checks</span>
            <span class="n">result</span><span class="o">.</span><span class="n">raw_mapper_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># --- Check for Multi-FK Union Signal --- #</span>
            <span class="n">union_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_union_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">union_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">union_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># If GFK mode is enabled and policy says to use it, record as pending GFK child</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_route_to_gfk</span><span class="p">(</span><span class="n">union_details</span><span class="p">,</span> <span class="n">carrier</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GFK] Routing union field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; to GenericEntry (policy=</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">gfk_policy</span><span class="si">}</span><span class="s2">).&quot;</span>
                    <span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                            <span class="s2">&quot;union_details&quot;</span><span class="p">:</span> <span class="n">union_details</span><span class="p">,</span>
                            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="c1"># Do not generate a concrete field for this union</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="c1"># Otherwise, fall back to existing multi-FK behavior</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected multi-FK union signal for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Deferring field generation.&quot;</span><span class="p">)</span>
                <span class="c1"># Store the original field name and the details for the generator</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">union_details</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Return early, deferring generation</span>

            <span class="c1"># --- Check for GFK placeholder signal from mapper --- #</span>
            <span class="n">gfk_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gfk_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gfk_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GFK] Mapper signaled GFK for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;. Recording as pending GFK child.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                            <span class="s2">&quot;gfk_details&quot;</span><span class="p">:</span> <span class="n">gfk_details</span><span class="p">,</span>
                            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="c1"># Do not generate a concrete field</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Received _gfk_details for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; but enable_gfk is False. Falling back to JSON field.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># --- Handle Relationships Specifically (Adjust Kwargs) --- #</span>
            <span class="c1"># Check if it&#39;s a relationship type *after* getting mapping AND checking for union signal</span>
            <span class="n">is_relationship</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">django_field_class</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_relationship</span><span class="p">:</span>
                <span class="c1"># Apply specific relationship logic (like related_name uniqueness)</span>
                <span class="c1"># The mapper should have set &#39;to&#39; and basic &#39;on_delete&#39;</span>
                <span class="k">if</span> <span class="s2">&quot;to&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
                    <span class="c1"># This indicates an issue in the mapper or relationship accessor setup</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapper failed to determine &#39;to&#39; for relationship field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                    <span class="k">return</span> <span class="n">result</span>

                <span class="c1"># Sanitize and ensure unique related_name</span>
                <span class="c1"># Check Pydantic Field(..., json_schema_extra={&quot;related_name&quot;: ...})</span>
                <span class="n">user_related_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">field_info</span><span class="o">.</span><span class="n">json_schema_extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_name&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">json_schema_extra</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>
                <span class="n">target_django_model_str</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>  <span class="c1"># Mapper returns string like app_label.ModelName</span>

                <span class="c1"># Try to get the actual target model class to pass to sanitize_related_name if possible</span>
                <span class="c1"># This relies on the target model being importable/available</span>
                <span class="n">target_model_cls</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span>  <span class="c1"># Default fallback</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">target_model_cls</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span><span class="p">)</span>  <span class="c1"># Use apps.get_model</span>
                    <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">model_cls_name</span>  <span class="c1"># Use name from split</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not get target model class for &#39;</span><span class="si">{</span><span class="n">target_django_model_str</span><span class="si">}</span><span class="s2">&#39; when generating related_name for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Using model name string.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Fallback: try splitting by dot just for name, otherwise use whole string</span>
                    <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">related_name_base</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">user_related_name</span>
                    <span class="k">if</span> <span class="n">user_related_name</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_set&quot;</span>
                <span class="p">)</span>
                <span class="n">final_related_name_base</span> <span class="o">=</span> <span class="n">sanitize_related_name</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">related_name_base</span><span class="p">),</span>
                    <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_model_cls_name_only</span><span class="p">,</span>
                    <span class="n">field_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Ensure uniqueness using carrier&#39;s tracker</span>
                <span class="n">target_model_key_for_tracker</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_django_model_str</span>
                <span class="p">)</span>
                <span class="n">target_related_names</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="n">target_model_key_for_tracker</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">unique_related_name</span> <span class="o">=</span> <span class="n">final_related_name_base</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">unique_related_name</span> <span class="ow">in</span> <span class="n">target_related_names</span><span class="p">:</span>
                    <span class="n">unique_related_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_related_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">target_related_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique_related_name</span><span class="p">)</span>
                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;related_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_related_name</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[REL] Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Assigning related_name=&#39;</span><span class="si">{</span><span class="n">unique_related_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="c1"># Re-confirm on_delete (mapper should set default based on Optional)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">django_field_class</span> <span class="ow">in</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="s2">&quot;on_delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span>
                <span class="p">):</span>
                    <span class="n">is_optional</span> <span class="o">=</span> <span class="n">is_pydantic_model_field_optional</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
                    <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
                <span class="k">elif</span> <span class="n">django_field_class</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">:</span>
                    <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;on_delete&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="c1"># M2M doesn&#39;t use null=True, mapper handles this</span>
                    <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blank&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># M2M usually blank=True</span>

            <span class="c1"># --- Perform Instantiation Locally --- #</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Instantiating </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; with kwargs: </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">django_field_class</span><span class="p">(</span><span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Store final kwargs</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to instantiate Django field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) with kwargs </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Fallback to context</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># --- Generate Field Definition String --- #</span>
            <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Success</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch-all for unexpected errors during conversion</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error converting field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Fallback to context</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_route_to_gfk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">union_details</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this union field should be handled via GFK based on carrier policy.</span>

<span class="sd">        For now, support simple policies:</span>
<span class="sd">        - &quot;all_nested&quot;: always route</span>
<span class="sd">        - &quot;threshold_by_children&quot;: route when number of union models &gt;= gfk_threshold_children</span>
<span class="sd">        Otherwise: False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">gfk_policy</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;all_nested&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="s2">&quot;threshold_by_children&quot;</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">gfk_threshold_children</span> <span class="ow">or</span> <span class="mi">0</span>
                <span class="n">models_in_union</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">union_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;models&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="p">[])</span>
                <span class="k">return</span> <span class="n">models_in_union</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_field_def_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">FieldConversionResult</span><span class="p">,</span> <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the field definition string safely.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;# Field generation failed&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">generate_field_definition_string</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">),</span> <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">,</span> <span class="n">app_label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not generate definition string for &#39;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: final kwargs not found in result. Using basic serialization.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">FieldSerializer</span><span class="o">.</span><span class="n">serialize_field</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to generate field definition string for &#39;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;# Error generating definition: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_id_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">FieldInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle potential ID field naming conflicts (logic moved from original factory).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span>
            <span class="c1"># Default to AutoField unless explicitly specified by type</span>
            <span class="n">field_class</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span>
            <span class="n">field_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ID&quot;</span><span class="p">}</span>

            <span class="c1"># Use mapper to find appropriate Django PK field if type is specified</span>
            <span class="c1"># But only override AutoField if it&#39;s clearly not a standard int sequence</span>
            <span class="n">pk_field_class_override</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">field_type</span> <span class="ow">is</span> <span class="n">UUID</span><span class="p">:</span>
                <span class="n">pk_field_class_override</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span>
                <span class="n">field_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">)</span>  <span class="c1"># UUIDField doesn&#39;t need verbose_name=&#39;ID&#39;</span>
            <span class="k">elif</span> <span class="n">field_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># Default Pydantic str ID to CharField PK</span>
                <span class="n">pk_field_class_override</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span>
                <span class="n">field_kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># Default length</span>
            <span class="k">elif</span> <span class="n">field_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Default AutoField is fine</span>
            <span class="k">elif</span> <span class="n">field_type</span><span class="p">:</span>
                <span class="c1"># Check if mapper finds a specific non-auto int field (e.g., BigIntegerField)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mapped_cls</span><span class="p">,</span> <span class="n">mapped_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="o">.</span><span class="n">get_django_mapping</span><span class="p">(</span><span class="n">field_type</span><span class="p">,</span> <span class="n">field_info</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">):</span>
                        <span class="n">pk_field_class_override</span> <span class="o">=</span> <span class="n">mapped_cls</span>
                        <span class="n">field_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapped_kwargs</span><span class="p">)</span>
                        <span class="c1"># Ensure primary_key=True is set</span>
                        <span class="n">field_kwargs</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Field &#39;id&#39; has type </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2"> mapping to non-integer </span><span class="si">{</span><span class="n">mapped_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. Using AutoField PK.&quot;</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="n">MappingError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;id&#39; has unmappable type </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">. Using AutoField PK.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pk_field_class_override</span><span class="p">:</span>
                <span class="n">field_class</span> <span class="o">=</span> <span class="n">pk_field_class_override</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Stick with AutoField, apply title if present</span>
                <span class="k">if</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
                    <span class="n">field_kwargs</span><span class="p">[</span><span class="s2">&quot;verbose_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">title</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; as primary key using </span><span class="si">{</span><span class="n">field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Instantiate the ID field</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">field_class</span><span class="p">(</span><span class="o">**</span><span class="n">field_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to instantiate ID field </span><span class="si">{</span><span class="n">field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with kwargs </span><span class="si">{</span><span class="n">field_kwargs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Fallback to basic AutoField? Or let error propagate?</span>
                <span class="c1"># Let&#39;s return None and let the main create_field handle error reporting</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.factory.PydanticFieldFactory.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">relationship_accessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">)</span></code>

<a href="#pydantic2django.pydantic.factory.PydanticFieldFactory.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initializes with dependencies.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes with dependencies.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">bidirectional_mapper</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.factory.PydanticFieldFactory.create_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_field</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.pydantic.factory.PydanticFieldFactory.create_field" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a Pydantic FieldInfo to a Django field instance.
Implements the abstract method from BaseFieldFactory.
Uses BidirectionalTypeMapper and local instantiation.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">FieldInfo</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a Pydantic FieldInfo to a Django field instance.</span>
<span class="sd">    Implements the abstract method from BaseFieldFactory.</span>
<span class="sd">    Uses BidirectionalTypeMapper and local instantiation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use alias first, then the actual key from model_fields as name</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">alias</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">field_info</span><span class="p">),</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Initialize result with the source field info and determined name</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">FieldConversionResult</span><span class="p">(</span><span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Handle potential &#39;id&#39; field conflict</span>
        <span class="k">if</span> <span class="n">id_field</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_id_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">id_field</span>
            <span class="c1"># Need to capture kwargs for serialization if possible</span>
            <span class="c1"># For now, assume default kwargs for ID fields</span>
            <span class="c1"># TODO: Extract actual kwargs used in _handle_id_field</span>
            <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">[</span><span class="s2">&quot;max_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_field</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">):</span>
                <span class="k">pass</span>  <span class="c1"># No extra kwargs needed typically</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># AutoField</span>
                <span class="k">pass</span>  <span class="c1"># No extra kwargs needed typically</span>

            <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>  <span class="c1"># ID field handled, return early</span>

        <span class="c1"># Get field type from annotation</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">annotation</span>
        <span class="k">if</span> <span class="n">field_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; has no annotation, treating as context field.&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># --- Use BidirectionalTypeMapper --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">django_field_class</span><span class="p">,</span> <span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="o">.</span><span class="n">get_django_mapping</span><span class="p">(</span>
                <span class="n">python_type</span><span class="o">=</span><span class="n">field_type</span><span class="p">,</span> <span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">MappingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle errors specifically from the mapper (e.g., missing relationship)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping error for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">field_type</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Treat as context on mapping error</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle unexpected errors during mapping lookup</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error getting Django mapping for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected mapping error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Store raw kwargs before modifications/checks</span>
        <span class="n">result</span><span class="o">.</span><span class="n">raw_mapper_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># --- Check for Multi-FK Union Signal --- #</span>
        <span class="n">union_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_union_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">union_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">union_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># If GFK mode is enabled and policy says to use it, record as pending GFK child</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_route_to_gfk</span><span class="p">(</span><span class="n">union_details</span><span class="p">,</span> <span class="n">carrier</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GFK] Routing union field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; to GenericEntry (policy=</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">gfk_policy</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                        <span class="s2">&quot;union_details&quot;</span><span class="p">:</span> <span class="n">union_details</span><span class="p">,</span>
                        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># Do not generate a concrete field for this union</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="c1"># Otherwise, fall back to existing multi-FK behavior</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected multi-FK union signal for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Deferring field generation.&quot;</span><span class="p">)</span>
            <span class="c1"># Store the original field name and the details for the generator</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">pending_multi_fk_unions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">union_details</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Return early, deferring generation</span>

        <span class="c1"># --- Check for GFK placeholder signal from mapper --- #</span>
        <span class="n">gfk_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gfk_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gfk_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GFK] Mapper signaled GFK for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;. Recording as pending GFK child.&quot;</span>
                <span class="p">)</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                        <span class="s2">&quot;gfk_details&quot;</span><span class="p">:</span> <span class="n">gfk_details</span><span class="p">,</span>
                        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># Do not generate a concrete field</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Received _gfk_details for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; but enable_gfk is False. Falling back to JSON field.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- Handle Relationships Specifically (Adjust Kwargs) --- #</span>
        <span class="c1"># Check if it&#39;s a relationship type *after* getting mapping AND checking for union signal</span>
        <span class="n">is_relationship</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span>
            <span class="n">django_field_class</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_relationship</span><span class="p">:</span>
            <span class="c1"># Apply specific relationship logic (like related_name uniqueness)</span>
            <span class="c1"># The mapper should have set &#39;to&#39; and basic &#39;on_delete&#39;</span>
            <span class="k">if</span> <span class="s2">&quot;to&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
                <span class="c1"># This indicates an issue in the mapper or relationship accessor setup</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapper failed to determine &#39;to&#39; for relationship field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Sanitize and ensure unique related_name</span>
            <span class="c1"># Check Pydantic Field(..., json_schema_extra={&quot;related_name&quot;: ...})</span>
            <span class="n">user_related_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">field_info</span><span class="o">.</span><span class="n">json_schema_extra</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">json_schema_extra</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">target_django_model_str</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>  <span class="c1"># Mapper returns string like app_label.ModelName</span>

            <span class="c1"># Try to get the actual target model class to pass to sanitize_related_name if possible</span>
            <span class="c1"># This relies on the target model being importable/available</span>
            <span class="n">target_model_cls</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span>  <span class="c1"># Default fallback</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">target_model_cls</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span><span class="p">)</span>  <span class="c1"># Use apps.get_model</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">model_cls_name</span>  <span class="c1"># Use name from split</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not get target model class for &#39;</span><span class="si">{</span><span class="n">target_django_model_str</span><span class="si">}</span><span class="s2">&#39; when generating related_name for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Using model name string.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Fallback: try splitting by dot just for name, otherwise use whole string</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">related_name_base</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">user_related_name</span>
                <span class="k">if</span> <span class="n">user_related_name</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_set&quot;</span>
            <span class="p">)</span>
            <span class="n">final_related_name_base</span> <span class="o">=</span> <span class="n">sanitize_related_name</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">related_name_base</span><span class="p">),</span>
                <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_model_cls_name_only</span><span class="p">,</span>
                <span class="n">field_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Ensure uniqueness using carrier&#39;s tracker</span>
            <span class="n">target_model_key_for_tracker</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_django_model_str</span>
            <span class="p">)</span>
            <span class="n">target_related_names</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">target_model_key_for_tracker</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">unique_related_name</span> <span class="o">=</span> <span class="n">final_related_name_base</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">unique_related_name</span> <span class="ow">in</span> <span class="n">target_related_names</span><span class="p">:</span>
                <span class="n">unique_related_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_related_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">target_related_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique_related_name</span><span class="p">)</span>
            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;related_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_related_name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[REL] Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Assigning related_name=&#39;</span><span class="si">{</span><span class="n">unique_related_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Re-confirm on_delete (mapper should set default based on Optional)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">django_field_class</span> <span class="ow">in</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">&quot;on_delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span>
            <span class="p">):</span>
                <span class="n">is_optional</span> <span class="o">=</span> <span class="n">is_pydantic_model_field_optional</span><span class="p">(</span><span class="n">field_type</span><span class="p">)</span>
                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
            <span class="k">elif</span> <span class="n">django_field_class</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">:</span>
                <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;on_delete&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># M2M doesn&#39;t use null=True, mapper handles this</span>
                <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blank&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># M2M usually blank=True</span>

        <span class="c1"># --- Perform Instantiation Locally --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Instantiating </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; with kwargs: </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">django_field_class</span><span class="p">(</span><span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Store final kwargs</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to instantiate Django field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) with kwargs </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Fallback to context</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># --- Generate Field Definition String --- #</span>
        <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch-all for unexpected errors during conversion</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error converting field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>  <span class="c1"># Fallback to context</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.pydantic.generator.StaticPydanticModelGenerator"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseStaticGenerator (pydantic2django.core.base_generator.BaseStaticGenerator)" href="#pydantic2django.core.base_generator.BaseStaticGenerator">BaseStaticGenerator</a>[<span title="type">type</span>[<span title="pydantic.BaseModel">BaseModel</span>], <span title="pydantic.fields.FieldInfo">FieldInfo</span>]</code></p>


        <p>Generates Django models and their context classes from Pydantic models.
Inherits common logic from BaseStaticGenerator.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/pydantic/generator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StaticPydanticModelGenerator</span><span class="p">(</span>
    <span class="n">BaseStaticGenerator</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">FieldInfo</span><span class="p">]</span>
<span class="p">):</span>  <span class="c1"># TModel=type[BaseModel], TFieldInfo=FieldInfo</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates Django models and their context classes from Pydantic models.</span>
<span class="sd">    Inherits common logic from BaseStaticGenerator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;generated_models.py&quot;</span><span class="p">,</span>  <span class="c1"># Keep original default</span>
        <span class="n">packages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;django_app&quot;</span><span class="p">,</span>  <span class="c1"># Keep original default</span>
        <span class="n">filter_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">discovery_module</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PydanticDiscovery</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Pydantic specific factories can be passed or constructed here</span>
        <span class="c1"># NOTE: Injecting factory instances is less preferred now due to mapper dependency</span>
        <span class="c1"># field_factory_instance: Optional[PydanticFieldFactory] = None,</span>
        <span class="c1"># model_factory_instance: Optional[PydanticModelFactory] = None,</span>
        <span class="c1"># Inject mapper instead?</span>
        <span class="n">bidirectional_mapper_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BidirectionalTypeMapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># --- GFK flags ---</span>
        <span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;threshold_by_children&quot;</span><span class="p">,</span>
        <span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">,</span>
        <span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># 1. Initialize Pydantic-specific discovery</span>
        <span class="c1"># Use provided instance or create a default one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_discovery_instance</span> <span class="o">=</span> <span class="n">discovery_module</span> <span class="ow">or</span> <span class="n">PydanticDiscovery</span><span class="p">()</span>

        <span class="c1"># 2. Initialize RelationshipAccessor (needed by factories and mapper)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">RelationshipConversionAccessor</span><span class="p">()</span>

        <span class="c1"># 3. Initialize BidirectionalTypeMapper (pass relationship accessor)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">bidirectional_mapper_instance</span> <span class="ow">or</span> <span class="n">BidirectionalTypeMapper</span><span class="p">(</span>
            <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span>
        <span class="p">)</span>

        <span class="c1"># 4. Initialize Pydantic-specific factories (pass mapper and accessor)</span>
        <span class="c1"># Remove dependency on passed-in factory instances, create them here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pydantic_model_factory</span> <span class="o">=</span> <span class="n">create_pydantic_factory</span><span class="p">(</span>
            <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span>
        <span class="p">)</span>

        <span class="c1"># 5. Call the base class __init__ with all required arguments</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">packages</span><span class="o">=</span><span class="n">packages</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;pydantic_models&quot;</span><span class="p">],</span>  <span class="c1"># Default Pydantic package</span>
            <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">filter_function</span><span class="o">=</span><span class="n">filter_function</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">discovery_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pydantic_discovery_instance</span><span class="p">,</span>  <span class="c1"># Pass the specific discovery instance</span>
            <span class="n">model_factory_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pydantic_model_factory</span><span class="p">,</span>  <span class="c1"># Pass the newly created model factory</span>
            <span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span><span class="p">,</span>
            <span class="n">base_model_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_base_model_class</span><span class="p">(),</span>
            <span class="c1"># Jinja setup is handled by base class</span>
            <span class="n">enable_timescale</span><span class="o">=</span><span class="n">enable_timescale</span><span class="p">,</span>
            <span class="n">enable_gfk</span><span class="o">=</span><span class="n">enable_gfk</span><span class="p">,</span>
            <span class="n">gfk_policy</span><span class="o">=</span><span class="n">gfk_policy</span><span class="p">,</span>
            <span class="n">gfk_threshold_children</span><span class="o">=</span><span class="n">gfk_threshold_children</span><span class="p">,</span>
            <span class="n">gfk_value_mode</span><span class="o">=</span><span class="n">gfk_value_mode</span><span class="p">,</span>
            <span class="n">gfk_normalize_common_attrs</span><span class="o">=</span><span class="n">gfk_normalize_common_attrs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 6. Pydantic-specific Jinja setup or context generator</span>
        <span class="c1"># Context generator needs the jinja_env from the base class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_generator</span> <span class="o">=</span> <span class="n">ContextClassGenerator</span><span class="p">(</span><span class="n">jinja_env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="p">)</span>

        <span class="c1"># 7. Track context-specific info during generation (reset in generate_models_file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># Timescale classification results cached per run (name -&gt; role)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TimescaleRole</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- Implement Abstract Methods from Base ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_source_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the original Pydantic model.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure source_model is not None before accessing __name__</span>
        <span class="k">return</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="k">else</span> <span class="s2">&quot;UnknownPydanticModel&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_source_model_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add import for the original Pydantic model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">:</span>
            <span class="c1"># Use the correct method from ImportHandler</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_pydantic_model_import</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot add source model import: source_model is missing from carrier.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_models_in_processing_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return models in Pydantic dependency order.&quot;&quot;&quot;</span>
        <span class="c1"># Discovery must have run first (called by base generate_models_file -&gt; discover_models)</span>
        <span class="c1"># Cast the discovery_instance from the base class to the specific Pydantic type</span>
        <span class="n">discovery</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticDiscovery</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">discovery</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No models discovered or passed filter, cannot determine processing order.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># Ensure dependencies are analyzed if not already done (base class should handle this)</span>
        <span class="c1"># if not discovery.dependencies:</span>
        <span class="c1">#     discovery.analyze_dependencies() # Base class analyze_dependencies called in discover_models</span>
        <span class="k">return</span> <span class="n">discovery</span><span class="o">.</span><span class="n">get_models_in_registration_order</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_template_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the Pydantic-specific context for the main models_file.py.j2 template.&quot;&quot;&quot;</span>
        <span class="c1"># Base context items (model_definitions, django_model_names, imports) are passed in.</span>
        <span class="c1"># Add Pydantic-specific items gathered during generate_models_file override.</span>
        <span class="n">base_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_definitions&quot;</span><span class="p">:</span> <span class="n">unique_model_definitions</span><span class="p">,</span>
            <span class="s2">&quot;django_model_names&quot;</span><span class="p">:</span> <span class="n">django_model_names</span><span class="p">,</span>  <span class="c1"># For __all__</span>
            <span class="c1"># --- Imports (already structured by base class import_handler) ---</span>
            <span class="s2">&quot;django_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s2">&quot;pydantic_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pydantic&quot;</span><span class="p">,</span> <span class="p">[])),</span>  <span class="c1"># Check if import handler categorizes these</span>
            <span class="s2">&quot;general_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s2">&quot;context_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">imports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">[])),</span>  <span class="c1"># Check if import handler categorizes these</span>
            <span class="c1"># It might be simpler to rely on the structured imports dict directly in the template</span>
            <span class="s2">&quot;imports&quot;</span><span class="p">:</span> <span class="n">imports</span><span class="p">,</span>  <span class="c1"># Pass the whole structured dict</span>
            <span class="c1"># --- Pydantic Specific ---</span>
            <span class="s2">&quot;context_definitions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span><span class="p">,</span>  <span class="c1"># Populated in generate_models_file override</span>
            <span class="s2">&quot;all_models&quot;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1"># This seems redundant if django_model_names covers __all__</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">django_model_names</span>  <span class="c1"># Use Django names for __all__ consistency?</span>
            <span class="p">],</span>
            <span class="s2">&quot;context_class_names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span><span class="p">,</span>  <span class="c1"># Populated in generate_models_file override</span>
            <span class="s2">&quot;model_has_context&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span><span class="p">,</span>  <span class="c1"># Populated in generate_models_file override</span>
            <span class="s2">&quot;generation_source_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pydantic&quot;</span><span class="p">,</span>  <span class="c1"># Flag for template logic</span>
        <span class="p">}</span>
        <span class="c1"># Note: Common items like timestamp, base_model info, extra_type_imports</span>
        <span class="c1"># are added by the base class generate_models_file method after calling this.</span>
        <span class="k">return</span> <span class="n">base_context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_model_definition_extra_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide Pydantic-specific context for model_definition.py.j2.&quot;&quot;&quot;</span>
        <span class="n">context_fields_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">context_class_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">has_context_for_this_model</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Track if this specific model has context</span>

        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
            <span class="n">has_context_for_this_model</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">django_model_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span> <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="k">else</span> <span class="s2">&quot;UnknownModel&quot;</span>
            <span class="p">)</span>
            <span class="n">context_class_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">Context&quot;</span>

            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_context_info</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field_type_attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field_context_info</span><span class="p">,</span> <span class="s2">&quot;field_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">field_context_info</span><span class="p">,</span> <span class="s2">&quot;annotation&quot;</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">field_type_attr</span><span class="p">:</span>
                    <span class="n">type_name</span> <span class="o">=</span> <span class="n">TypeHandler</span><span class="o">.</span><span class="n">format_type_string</span><span class="p">(</span><span class="n">field_type_attr</span><span class="p">)</span>
                    <span class="c1"># Add imports for context field types via import_handler</span>
                    <span class="c1"># Use the correct method which handles nested types and typing imports</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_context_field_type_import</span><span class="p">(</span><span class="n">field_type_attr</span><span class="p">)</span>

                    <span class="c1"># Remove explicit add_extra_import calls, handled by add_context_field_type_import</span>
                    <span class="c1"># if getattr(field_context_info, &#39;is_optional&#39;, False):</span>
                    <span class="c1">#      self.import_handler.add_extra_import(&quot;Optional&quot;, &quot;typing&quot;)</span>
                    <span class="c1"># if getattr(field_context_info, &#39;is_list&#39;, False):</span>
                    <span class="c1">#      self.import_handler.add_extra_import(&quot;List&quot;, &quot;typing&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">type_name</span> <span class="o">=</span> <span class="s2">&quot;Any&quot;</span>  <span class="c1"># Fallback</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not determine context type annotation for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">context_fields_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;context_class_name&quot;</span><span class="p">:</span> <span class="n">context_class_name</span><span class="p">,</span>
            <span class="s2">&quot;context_fields&quot;</span><span class="p">:</span> <span class="n">context_fields_info</span><span class="p">,</span>
            <span class="s2">&quot;is_pydantic_source&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;is_dataclass_source&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;has_context&quot;</span><span class="p">:</span> <span class="n">has_context_for_this_model</span><span class="p">,</span>
            <span class="s2">&quot;field_definitions&quot;</span><span class="p">:</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_default_base_model_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the default Django base model for Pydantic conversion.</span>

<span class="sd">        Raises a clear ImportError if the base cannot be imported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">django_apps</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AppRegistryNotReady</span><span class="p">(</span>
                <span class="s2">&quot;Django apps are not loaded. Call django.setup() or run within a configured Django context before &quot;</span>
                <span class="s2">&quot;instantiating StaticPydanticModelGenerator.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">typed2django.django.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pydantic2DjangoBaseClass</span> <span class="k">as</span> <span class="n">_Base</span>

            <span class="k">return</span> <span class="n">_Base</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive path</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;typed2django.django.models.Pydantic2DjangoBaseClass is required for Pydantic generation.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

    <span class="c1"># --- Override generate_models_file to handle Pydantic context class generation ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the complete models.py file content, including Pydantic context classes.</span>
<span class="sd">        Overrides the base method to add context class handling during the generation loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Base discovery and model ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>  <span class="c1"># Calls base discovery and dependency analysis</span>
        <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>  <span class="c1"># Uses overridden method</span>

        <span class="c1"># 2. Reset state for this run (imports handled by base reset)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Manually reset ImportHandler state instead of calling non-existent reset()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Re-add base model import after clearing</span>
        <span class="c1"># Note: add_pydantic_model_import might not be the right method here if base_model_class isn&#39;t Pydantic</span>
        <span class="c1"># Need a more general import method on ImportHandler or handle it differently.</span>
        <span class="c1"># For now, let&#39;s assume a general import is needed or handled by template.</span>
        <span class="c1"># self.import_handler.add_import(self.base_model_class.__module__, self.base_model_class.__name__)</span>
        <span class="c1"># Let&#39;s add it back using _add_type_import, although it&#39;s protected.</span>
        <span class="c1"># A public add_general_import(module, name) on ImportHandler would be better.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This is a workaround - ideally ImportHandler would have a public method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add base model import via _add_type_import: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Reset Pydantic-specific tracking lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map of Pydantic model name -&gt; bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For __all__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For deduplication of definitions</span>

        <span class="c1"># --- State tracking within the loop ---</span>
        <span class="n">model_definitions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store generated Django model definition strings</span>
        <span class="n">django_model_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store generated Django model names for __all__</span>
        <span class="n">context_only_models</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track Pydantic models yielding only context</span>
        <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># 3. Setup Django models (populates self.carriers via base method calling factory)</span>
        <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>  <span class="c1"># Uses base setup_django_model</span>

        <span class="c1"># 4. Generate definitions (Django models AND Pydantic Context classes)</span>
        <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Pydantic model name</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># --- GFK finalize hook: inject GenericRelation on parents ---</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pending_gfk_children&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="c1"># Ensure imports for contenttypes</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>

                    <span class="c1"># Inject a GenericRelation field into the parent model definition strings</span>
                    <span class="c1"># Field name &#39;entries&#39; for reverse access</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span>
                            <span class="s2">&quot;entries&quot;</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GenericRelation(&#39;GenericEntry&#39;, related_query_name=&#39;entries&#39;)&quot;</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">django_model_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">django_model_name_cleaned</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="c1"># --- A. Generate Django Model Definition (if applicable) ---</span>
                <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
                    <span class="c1"># Check fields using safe getattr for many_to_many</span>
                    <span class="n">has_concrete_fields</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
                    <span class="c1"># Use getattr for safety</span>
                    <span class="n">m2m_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;many_to_many&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">has_m2m</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">m2m_fields</span><span class="p">)</span>
                    <span class="n">has_fields</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">has_concrete_fields</span> <span class="ow">or</span> <span class="n">has_m2m</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_concrete_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_m2m</span> <span class="ow">and</span> <span class="n">has_fields</span><span class="p">):</span>
                        <span class="n">django_model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">django_model_def</span><span class="p">:</span>
                            <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">django_model_def</span><span class="p">)</span>
                            <span class="n">django_model_name_cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                            <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_name_cleaned</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base generate_model_definition returned empty for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Model exists but seems empty (no concrete fields/M2M)</span>
                        <span class="c1"># Check if it *does* have context fields</span>
                        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
                            <span class="n">context_only_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping Django model definition for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> - only has context fields.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> resulted in an empty Django model with no context fields. Skipping definition.&quot;</span>
                            <span class="p">)</span>
                            <span class="c1"># Continue to next carrier if no Django model AND no context</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">):</span>
                                <span class="k">continue</span>

                <span class="c1"># --- B. Generate Context Class Definition (Pydantic Specific) ---</span>
                <span class="n">has_context</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
                    <span class="n">has_context</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Generate context class definition string using the context_generator</span>
                    <span class="c1"># This also handles adding necessary imports for context fields via TypeHandler/ImportHandler calls within it</span>
                    <span class="n">context_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_generator</span><span class="o">.</span><span class="n">generate_context_class</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="p">)</span>

                    <span class="c1"># Determine context class name (needs Django model name)</span>
                    <span class="c1"># Use the cleaned name if available, otherwise construct from Pydantic name?</span>
                    <span class="n">base_name_for_context</span> <span class="o">=</span> <span class="n">django_model_name_cleaned</span> <span class="k">if</span> <span class="n">django_model_name_cleaned</span> <span class="k">else</span> <span class="n">model_name</span>
                    <span class="n">context_class_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name_for_context</span><span class="si">}</span><span class="s2">Context&quot;</span>

                    <span class="c1"># Add context class definition if not seen before</span>
                    <span class="k">if</span> <span class="n">context_class_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_def</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">context_class_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">context_class_name</span><span class="p">)</span>

                    <span class="c1"># Add imports for context fields (should be handled by context_generator now)</span>
                    <span class="c1"># self.import_handler.add_context_field_imports(carrier.model_context) # Example hypothetical method</span>

                <span class="c1"># --- C. Update Tracking and Add Source Import ---</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">has_context</span>

                <span class="c1"># Add import for the original source model (Pydantic model)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_source_model_import</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing carrier for source model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 5. Log Summary</span>
        <span class="k">if</span> <span class="n">context_only_models</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipped Django definitions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context_only_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> models with only context fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_only_models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If GFK is used anywhere, emit GenericEntry model once per file</span>
        <span class="k">if</span> <span class="n">gfk_used</span><span class="p">:</span>
            <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_generic_entry_model_definition</span><span class="p">())</span>
            <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;GenericEntry&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># 6. Deduplicate Definitions (Django models only, context defs deduplicated by name during loop)</span>
        <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>  <span class="c1"># Use base method</span>

        <span class="c1"># 7. Get Imports (handled by base import_handler)</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>

        <span class="c1"># 8. Prepare Template Context (using overridden Pydantic-specific method)</span>
        <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>

        <span class="c1"># 9. Add Common Context Items (handled by base class) - Reuse base class logic</span>
        <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
                <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
                <span class="c1"># Ensure generation_source_type is set by _prepare_template_context</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># 10. Render the main template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_generic_entry_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the GenericEntry model definition string.</span>

<span class="sd">        Uses contenttypes GenericForeignKey to attach to any parent model.</span>
<span class="sd">        Includes common columns and optional typed value columns based on flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure imports present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>

        <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;content_type = models.ForeignKey(&#39;contenttypes.ContentType&#39;, on_delete=models.CASCADE)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;object_id = models.PositiveIntegerField()&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;content_object = GenericForeignKey(&#39;content_type&#39;, &#39;object_id&#39;)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;element_qname = models.CharField(max_length=255)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;type_qname = models.CharField(max_length=255, null=True, blank=True)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs_json = models.JSONField(default=dict, blank=True)&quot;</span><span class="p">)</span>
        <span class="c1"># Optional typed value columns if configured</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gfk_value_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;text_value = models.TextField(null=True, blank=True)&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;num_value = models.DecimalField(max_digits=20, decimal_places=6, null=True, blank=True)&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;time_value = models.DateTimeField(null=True, blank=True)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;order_index = models.IntegerField(default=0)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path_hint = models.CharField(max_length=255, null=True, blank=True)&quot;</span><span class="p">)</span>

        <span class="c1"># Build indexes list</span>
        <span class="n">indexes_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;models.Index(fields=[&#39;content_type&#39;, &#39;object_id&#39;])&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gfk_value_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">:</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;element_qname&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;type_qname&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;time_value&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;content_type&#39;, &#39;object_id&#39;, &#39;-time_value&#39;])&quot;</span><span class="p">)</span>

        <span class="c1"># Compose class string</span>
        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class GenericEntry(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    class Meta:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        app_label = &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        abstract = False&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        indexes = [&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indexes_lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        ]&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1"># Choose Timescale base per model (lazy roles computation)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic2django.django.timescale.bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">PydanticTimescaleBase</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic2django.django.timescale.heuristics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">classify_pydantic_models</span><span class="p">,</span>
                <span class="n">should_use_timescale_base</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">classify_pydantic_models</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="n">should_use_timescale_base</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="n">PydanticTimescaleBase</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Compute roles lazily if not present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_timescale_roles&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">roles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TimescaleRole</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">models_to_score</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">models_to_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">models_to_score</span><span class="p">:</span>
                    <span class="n">models_to_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_model</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">classify_pydantic_models</span><span class="p">:</span>
                    <span class="n">roles</span> <span class="o">=</span> <span class="n">classify_pydantic_models</span><span class="p">(</span><span class="n">models_to_score</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">roles</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span> <span class="o">=</span> <span class="n">roles</span>

        <span class="c1"># Select base class</span>
        <span class="n">base_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">if</span> <span class="n">should_use_timescale_base</span> <span class="ow">and</span> <span class="n">PydanticTimescaleBase</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">should_use_timescale_base</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span><span class="p">):</span>  <span class="c1"># type: ignore[arg-type]</span>
                        <span class="n">base_cls</span> <span class="o">=</span> <span class="n">PydanticTimescaleBase</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">prev_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">base_cls</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">carrier</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">prev_base</span>

        <span class="k">if</span> <span class="n">carrier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;_timescale_roles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_timescale_roles&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">carrier</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.pydantic.generator.StaticPydanticModelGenerator.generate_models_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_models_file</span><span class="p">()</span></code>

<a href="#pydantic2django.pydantic.generator.StaticPydanticModelGenerator.generate_models_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates the complete models.py file content, including Pydantic context classes.
Overrides the base method to add context class handling during the generation loop.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/pydantic/generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the complete models.py file content, including Pydantic context classes.</span>
<span class="sd">    Overrides the base method to add context class handling during the generation loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Base discovery and model ordering</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>  <span class="c1"># Calls base discovery and dependency analysis</span>
    <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>  <span class="c1"># Uses overridden method</span>

    <span class="c1"># 2. Reset state for this run (imports handled by base reset)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Manually reset ImportHandler state instead of calling non-existent reset()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Re-add base model import after clearing</span>
    <span class="c1"># Note: add_pydantic_model_import might not be the right method here if base_model_class isn&#39;t Pydantic</span>
    <span class="c1"># Need a more general import method on ImportHandler or handle it differently.</span>
    <span class="c1"># For now, let&#39;s assume a general import is needed or handled by template.</span>
    <span class="c1"># self.import_handler.add_import(self.base_model_class.__module__, self.base_model_class.__name__)</span>
    <span class="c1"># Let&#39;s add it back using _add_type_import, although it&#39;s protected.</span>
    <span class="c1"># A public add_general_import(module, name) on ImportHandler would be better.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># This is a workaround - ideally ImportHandler would have a public method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not add base model import via _add_type_import: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Reset Pydantic-specific tracking lists</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map of Pydantic model name -&gt; bool</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># For __all__</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># For deduplication of definitions</span>

    <span class="c1"># --- State tracking within the loop ---</span>
    <span class="n">model_definitions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store generated Django model definition strings</span>
    <span class="n">django_model_names</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store generated Django model names for __all__</span>
    <span class="n">context_only_models</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track Pydantic models yielding only context</span>
    <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># 3. Setup Django models (populates self.carriers via base method calling factory)</span>
    <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>  <span class="c1"># Uses base setup_django_model</span>

    <span class="c1"># 4. Generate definitions (Django models AND Pydantic Context classes)</span>
    <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_source_model_name</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>  <span class="c1"># Pydantic model name</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># --- GFK finalize hook: inject GenericRelation on parents ---</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pending_gfk_children&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># Ensure imports for contenttypes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>

                <span class="c1"># Inject a GenericRelation field into the parent model definition strings</span>
                <span class="c1"># Field name &#39;entries&#39; for reverse access</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span>
                        <span class="s2">&quot;entries&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GenericRelation(&#39;GenericEntry&#39;, related_query_name=&#39;entries&#39;)&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">django_model_def</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">django_model_name_cleaned</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># --- A. Generate Django Model Definition (if applicable) ---</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
                <span class="c1"># Check fields using safe getattr for many_to_many</span>
                <span class="n">has_concrete_fields</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
                <span class="c1"># Use getattr for safety</span>
                <span class="n">m2m_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="s2">&quot;many_to_many&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">has_m2m</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">m2m_fields</span><span class="p">)</span>
                <span class="n">has_fields</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">has_concrete_fields</span> <span class="ow">or</span> <span class="n">has_m2m</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_concrete_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_m2m</span> <span class="ow">and</span> <span class="n">has_fields</span><span class="p">):</span>
                    <span class="n">django_model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">django_model_def</span><span class="p">:</span>
                        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">django_model_def</span><span class="p">)</span>
                        <span class="n">django_model_name_cleaned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                        <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">django_model_name_cleaned</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base generate_model_definition returned empty for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Model exists but seems empty (no concrete fields/M2M)</span>
                    <span class="c1"># Check if it *does* have context fields</span>
                    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
                        <span class="n">context_only_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping Django model definition for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> - only has context fields.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> resulted in an empty Django model with no context fields. Skipping definition.&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Continue to next carrier if no Django model AND no context</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">):</span>
                            <span class="k">continue</span>

            <span class="c1"># --- B. Generate Context Class Definition (Pydantic Specific) ---</span>
            <span class="n">has_context</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="o">.</span><span class="n">context_fields</span><span class="p">:</span>
                <span class="n">has_context</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Generate context class definition string using the context_generator</span>
                <span class="c1"># This also handles adding necessary imports for context fields via TypeHandler/ImportHandler calls within it</span>
                <span class="n">context_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_generator</span><span class="o">.</span><span class="n">generate_context_class</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span><span class="p">)</span>

                <span class="c1"># Determine context class name (needs Django model name)</span>
                <span class="c1"># Use the cleaned name if available, otherwise construct from Pydantic name?</span>
                <span class="n">base_name_for_context</span> <span class="o">=</span> <span class="n">django_model_name_cleaned</span> <span class="k">if</span> <span class="n">django_model_name_cleaned</span> <span class="k">else</span> <span class="n">model_name</span>
                <span class="n">context_class_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name_for_context</span><span class="si">}</span><span class="s2">Context&quot;</span>

                <span class="c1"># Add context class definition if not seen before</span>
                <span class="k">if</span> <span class="n">context_class_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context_def</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context_class_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">context_class_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seen_context_classes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">context_class_name</span><span class="p">)</span>

                <span class="c1"># Add imports for context fields (should be handled by context_generator now)</span>
                <span class="c1"># self.import_handler.add_context_field_imports(carrier.model_context) # Example hypothetical method</span>

            <span class="c1"># --- C. Update Tracking and Add Source Import ---</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_has_context</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">has_context</span>

            <span class="c1"># Add import for the original source model (Pydantic model)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_source_model_import</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing carrier for source model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 5. Log Summary</span>
    <span class="k">if</span> <span class="n">context_only_models</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Skipped Django definitions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">context_only_models</span><span class="p">)</span><span class="si">}</span><span class="s2"> models with only context fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context_only_models</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># If GFK is used anywhere, emit GenericEntry model once per file</span>
    <span class="k">if</span> <span class="n">gfk_used</span><span class="p">:</span>
        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_generic_entry_model_definition</span><span class="p">())</span>
        <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;GenericEntry&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># 6. Deduplicate Definitions (Django models only, context defs deduplicated by name during loop)</span>
    <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>  <span class="c1"># Use base method</span>

    <span class="c1"># 7. Get Imports (handled by base import_handler)</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>

    <span class="c1"># 8. Prepare Template Context (using overridden Pydantic-specific method)</span>
    <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>

    <span class="c1"># 9. Add Common Context Items (handled by base class) - Reuse base class logic</span>
    <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
            <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
            <span class="c1"># Ensure generation_source_type is set by _prepare_template_context</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># 10. Render the main template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p>Notes:</p>
</li>
<li>Relies on Pydantic <code>FieldInfo</code> for field metadata and constraints.</li>
<li>Generates optional per-model context classes when non-serializable fields are detected.</li>
</ul>
<h4 id="dataclass">Dataclass<a class="headerlink" href="#dataclass" title="Permanent link">&para;</a></h4>
<ul>
<li>Discovery, factory, and generator:</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.dataclass.discovery.DataclassDiscovery"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDiscovery (pydantic2django.core.discovery.BaseDiscovery)" href="#pydantic2django.core.discovery.BaseDiscovery">BaseDiscovery</a>[<span title="pydantic2django.dataclass.discovery.DataclassType">DataclassType</span>]</code></p>


        <p>Discovers Python dataclasses within specified packages.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/dataclass/discovery.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataclassDiscovery</span><span class="p">(</span><span class="n">BaseDiscovery</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovers Python dataclasses within specified packages.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Dataclass specific attributes (all_models now in base)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_target_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object is a dataclass type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_eligibility_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check default eligibility for dataclasses (e.g., not inheriting directly from ABC).&quot;&quot;&quot;</span>
        <span class="c1"># Skip models that directly inherit from ABC</span>
        <span class="k">if</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering out dataclass </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (inherits directly from ABC)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Dataclasses don&#39;t have a standard __abstract__ marker like Pydantic</span>
        <span class="c1"># Add other default checks if needed for dataclasses</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># discover_models is now implemented in the BaseDiscovery class</span>
    <span class="c1"># It will call the _is_target_model and _default_eligibility_filter defined above.</span>

    <span class="c1"># --- analyze_dependencies and get_models_in_registration_order remain ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the dependency graph for the filtered dataclasses.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered dataclasses...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">,</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">model_type</span><span class="p">:</span>
                <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> wasn&#39;t pre-initialized in dependencies dict during analysis. Initializing now.&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dep_model_obj</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for dataclass &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not object in filtered set.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># Initialize keys based on filtered models</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Analyze fields using dataclasses.fields</span>
        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">model_type</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> to be a dataclass&quot;</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">model_type</span><span class="p">):</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

                <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="n">arg_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">arg_origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">nested_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">nested_type</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataclass dependency analysis complete.&quot;</span><span class="p">)</span>
        <span class="c1"># Debug logging moved inside BaseDiscovery</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return dataclasses sorted topologically based on dependencies.</span>
<span class="sd">        (Largely similar to Pydantic version, uses DataclassType)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No dependencies found or analyzed, returning dataclasses in arbitrary order.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">sorted_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visiting</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">filtered_model_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visiting</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circular dependency detected involving dataclass </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Option: raise TypeError(...)</span>
                <span class="k">return</span>  <span class="c1"># Break cycle</span>

            <span class="n">visiting</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="c1"># Use .get for safety, ensure deps are also in filtered set</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">filtered_model_objects</span><span class="p">:</span>
                        <span class="n">visit</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

            <span class="n">visiting</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">sorted_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">all_target_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">all_target_models</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">visit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataclasses sorted for registration: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted_models</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sorted_models</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.discovery.DataclassDiscovery.analyze_dependencies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_dependencies</span><span class="p">()</span></code>

<a href="#pydantic2django.dataclass.discovery.DataclassDiscovery.analyze_dependencies" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Build the dependency graph for the filtered dataclasses.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build the dependency graph for the filtered dataclasses.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered dataclasses...&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">,</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">model_type</span><span class="p">:</span>
            <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> wasn&#39;t pre-initialized in dependencies dict during analysis. Initializing now.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">dep_model_obj</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for dataclass &#39;</span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not object in filtered set.&quot;</span>
                <span class="p">)</span>

    <span class="c1"># Initialize keys based on filtered models</span>
    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Analyze fields using dataclasses.fields</span>
    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">model_type</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s2"> to be a dataclass&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">model_type</span><span class="p">):</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

            <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">origin</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">arg_origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">arg_args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">arg_origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg_args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">nested_type</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">arg_args</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                        <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">nested_type</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataclass dependency analysis complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.discovery.DataclassDiscovery.get_models_in_registration_order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_models_in_registration_order</span><span class="p">()</span></code>

<a href="#pydantic2django.dataclass.discovery.DataclassDiscovery.get_models_in_registration_order" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return dataclasses sorted topologically based on dependencies.
(Largely similar to Pydantic version, uses DataclassType)</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return dataclasses sorted topologically based on dependencies.</span>
<span class="sd">    (Largely similar to Pydantic version, uses DataclassType)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No dependencies found or analyzed, returning dataclasses in arbitrary order.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="n">sorted_models</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">visiting</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">filtered_model_objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">visit</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">visiting</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Circular dependency detected involving dataclass </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Option: raise TypeError(...)</span>
            <span class="k">return</span>  <span class="c1"># Break cycle</span>

        <span class="n">visiting</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="c1"># Use .get for safety, ensure deps are also in filtered set</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">set</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">filtered_model_objects</span><span class="p">:</span>
                    <span class="n">visit</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="n">visiting</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">sorted_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">all_target_models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">all_target_models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">visit</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataclasses sorted for registration: </span><span class="si">{</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="vm">__name__</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted_models</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sorted_models</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.dataclass.factory.DataclassModelFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseModelFactory (pydantic2django.core.factories.BaseModelFactory)" href="#pydantic2django.core.factories.BaseModelFactory">BaseModelFactory</a>[<span title="pydantic2django.dataclass.factory.DataclassType">DataclassType</span>, <span title="dataclasses.Field">Field</span>]</code></p>


        <p>Dynamically creates Django model classes from dataclasses.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataclassModelFactory</span><span class="p">(</span><span class="n">BaseModelFactory</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dynamically creates Django model classes from dataclasses.&quot;&quot;&quot;</span>

    <span class="c1"># Cache specific to Dataclass models</span>
    <span class="n">_converted_models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span>  <span class="c1"># Changed Optional to required</span>
    <span class="n">import_handler</span><span class="p">:</span> <span class="n">ImportHandler</span>  <span class="c1"># Added import handler</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_factory</span><span class="p">:</span> <span class="n">DataclassFieldFactory</span><span class="p">,</span>
        <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span>  <span class="c1"># Now required</span>
        <span class="n">import_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImportHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Accept optionally</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with field factory, relationship accessor, and import handler.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span> <span class="o">=</span> <span class="n">import_handler</span> <span class="ow">or</span> <span class="n">ImportHandler</span><span class="p">()</span>
        <span class="c1"># Call super init</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orchestrates the Django model creation process.</span>
<span class="sd">        Subclasses implement _process_source_fields and _build_model_context.</span>
<span class="sd">        Handles caching.</span>
<span class="sd">        Passes import handler down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- Pass import handler via carrier --- (or could add to factory state)</span>
        <span class="c1"># Need to set import handler on carrier if passed during init</span>
        <span class="c1"># NOTE: BaseModelFactory.make_django_model does this now.</span>
        <span class="c1"># carrier.import_handler = self.import_handler</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
        <span class="c1"># Register relationship after successful model creation (moved from original)</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mapping relationship in accessor: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">map_relationship</span><span class="p">(</span>
                <span class="n">source_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span>
            <span class="p">)</span>
        <span class="c1"># Cache result (moved from original)</span>
        <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_source_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate through source dataclass fields, resolve types, create Django fields, and store results.&quot;&quot;&quot;</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot process fields: source model missing in carrier for </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;target_model_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>  <span class="c1"># Safely access target_model_name</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;_source_model&quot;</span><span class="p">,</span> <span class="s2">&quot;Source model missing.&quot;</span><span class="p">))</span>  <span class="c1"># Use invalid_fields</span>
            <span class="k">return</span>

        <span class="c1"># --- Add check: Ensure source_model is a type ---</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cannot process fields: expected source_model to be a type, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">source_model</span><span class="si">!r}</span><span class="s2">). Problem likely upstream in model discovery/ordering.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;_source_model&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="c1"># --- End Add check ---</span>

        <span class="c1"># --- Use dataclasses.fields for introspection ---</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Resolve type hints first to handle forward references (strings)</span>
            <span class="c1"># Need globals and potentially locals from the source model&#39;s module</span>
            <span class="n">source_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>
            <span class="n">globalns</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source_module</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Revert: Use only globals, assuming types are resolvable in module scope</span>

            <span class="c1"># resolved_types = get_type_hints(source_model, globalns=globalns, localns=localns)</span>
            <span class="c1"># logger.debug(f&quot;Resolved types for {source_model.__name__} using {globalns=}, {localns=}: {resolved_types}&quot;)</span>
            <span class="c1"># Use updated call without potentially incorrect locals:</span>
            <span class="n">resolved_types</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="n">source_model</span><span class="p">,</span> <span class="n">globalns</span><span class="o">=</span><span class="n">globalns</span><span class="p">,</span> <span class="n">localns</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved types for </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> using module globals: </span><span class="si">{</span><span class="n">resolved_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">dataclass_fields</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Catch errors during type hint resolution or fields() call</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Could not introspect fields or resolve types for </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;_introspection&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>  <span class="c1"># Use invalid_fields</span>
            <span class="k">return</span>

        <span class="c1"># Use field definitions directly from carrier</span>
        <span class="c1"># field_definitions: dict[str, str] = {}</span>
        <span class="c1"># context_field_definitions: dict[str, str] = {} # Dataclasses likely won&#39;t use this</span>

        <span class="k">for</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">dataclass_fields</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># Normalize output Django field identifier</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">..core.utils.naming</span><span class="w"> </span><span class="kn">import</span> <span class="n">sanitize_field_identifier</span>

                <span class="n">normalized_field_name</span> <span class="o">=</span> <span class="n">sanitize_field_identifier</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">normalized_field_name</span> <span class="o">=</span> <span class="n">field_name</span>

            <span class="c1"># Get the *resolved* type for this field</span>
            <span class="n">resolved_type</span> <span class="o">=</span> <span class="n">resolved_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resolved_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not resolve type hint for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; in </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. Using original: </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Fallback to original, which might be a string</span>
                <span class="n">resolved_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">type</span>

            <span class="c1"># --- Prepare field type for create_field --- #</span>
            <span class="n">type_for_create_field</span> <span class="o">=</span> <span class="n">resolved_type</span>  <span class="c1"># Start with the result from get_type_hints</span>

            <span class="c1"># If the original type annotation was a string (ForwardRef)</span>
            <span class="c1"># and get_type_hints failed to resolve it (resolved_type is None or still the string),</span>
            <span class="c1"># try to find the resolved type from the dict populated earlier.</span>
            <span class="c1"># This specifically handles nested dataclasses defined in local scopes like fixtures.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">explicitly_resolved</span> <span class="o">=</span> <span class="n">resolved_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">explicitly_resolved</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">explicitly_resolved</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Using explicitly resolved type </span><span class="si">{</span><span class="n">explicitly_resolved</span><span class="si">!r}</span><span class="s2"> for forward ref &#39;</span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span>
                    <span class="n">type_for_create_field</span> <span class="o">=</span> <span class="n">explicitly_resolved</span>
                <span class="k">elif</span> <span class="n">resolved_type</span> <span class="ow">is</span> <span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>  <span class="c1"># Check if resolved_type is still the unresolved string</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Type hint for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is string &#39;</span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&#39; but was not resolved by get_type_hints. Skipping field.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Could not resolve forward reference: </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>  <span class="c1"># Skip this field</span>

            <span class="c1"># Temporarily modify a copy of field_info or pass type directly if possible.</span>
            <span class="c1"># Modifying field_info directly is simpler for now.</span>
            <span class="n">original_type_attr</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">type</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_info</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type_for_create_field</span>  <span class="c1"># Use the determined type</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling create_field for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; with type: </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">field_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span><span class="o">.</span><span class="n">create_field</span><span class="p">(</span>
                    <span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">carrier</span><span class="o">=</span><span class="n">carrier</span>
                <span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Restore original type attribute</span>
                <span class="n">field_info</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">original_type_attr</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Restored original field_info.type attribute&quot;</span><span class="p">)</span>

            <span class="c1"># Process the result (errors, definitions)</span>
            <span class="k">if</span> <span class="n">field_result</span><span class="o">.</span><span class="n">error_str</span><span class="p">:</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">normalized_field_name</span><span class="p">,</span> <span class="n">field_result</span><span class="o">.</span><span class="n">error_str</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Store the definition string if available</span>
                <span class="k">if</span> <span class="n">field_result</span><span class="o">.</span><span class="n">field_definition_str</span><span class="p">:</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_result</span><span class="o">.</span><span class="n">field_definition_str</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">normalized_field_name</span><span class="si">}</span><span class="s2">&#39; processing yielded no error and no definition string.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Store the actual field instance in the correct carrier dict</span>
                <span class="k">if</span> <span class="n">field_result</span><span class="o">.</span><span class="n">django_field</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">field_result</span><span class="o">.</span><span class="n">django_field</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">carrier</span><span class="o">.</span><span class="n">relationship_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_result</span><span class="o">.</span><span class="n">django_field</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">carrier</span><span class="o">.</span><span class="n">django_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_result</span><span class="o">.</span><span class="n">django_field</span>
                <span class="k">elif</span> <span class="n">field_result</span><span class="o">.</span><span class="n">context_field</span><span class="p">:</span>
                    <span class="c1"># Handle context fields if needed (currently seems unused based on logs)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span><span class="p">[</span><span class="n">normalized_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_result</span><span class="o">.</span><span class="n">context_field</span>

                <span class="c1"># Merge imports from result into the factory&#39;s import handler</span>
                <span class="k">if</span> <span class="n">field_result</span><span class="o">.</span><span class="n">required_imports</span><span class="p">:</span>
                    <span class="c1"># Use the new add_import method</span>
                    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">field_result</span><span class="o">.</span><span class="n">required_imports</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished processing fields for </span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. Errors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">invalid_fields</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Actual implementation of the abstract method _build_model_context</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_model_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Builds the ModelContext specifically for dataclass source models.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skipping context build: missing source or django model.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Remove generic type hint if ModelContext is not generic or if causing issues</span>
            <span class="c1"># Assuming ModelContext base class handles the source type appropriately</span>
            <span class="n">model_context</span> <span class="o">=</span> <span class="n">ModelContext</span><span class="p">(</span><span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">,</span> <span class="n">source_class</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">carrier</span><span class="o">.</span><span class="n">context_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
                    <span class="c1"># Calculate necessary info for ModelContext.add_field</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                    <span class="n">is_optional</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span>
                    <span class="n">field_type_str</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>  <span class="c1"># Use repr for the type string</span>

                    <span class="c1"># Call add_field with expected signature</span>
                    <span class="n">model_context</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                        <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                        <span class="n">field_type_str</span><span class="o">=</span><span class="n">field_type_str</span><span class="p">,</span>
                        <span class="n">is_optional</span><span class="o">=</span><span class="n">is_optional</span><span class="p">,</span>
                        <span class="c1"># Pass original annotation if ModelContext uses it</span>
                        <span class="n">annotation</span><span class="o">=</span><span class="n">field_info</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Log if context field is not the expected type</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Context field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is not a dataclasses.Field (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">field_info</span><span class="p">)</span><span class="si">}</span><span class="s2">), cannot add to ModelContext.&quot;</span>
                    <span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="n">model_context</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully built ModelContext for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Use method call</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to build ModelContext for </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">model_context</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.factory.DataclassModelFactory.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">,</span> <span class="n">import_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.dataclass.factory.DataclassModelFactory.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initialize with field factory, relationship accessor, and import handler.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">field_factory</span><span class="p">:</span> <span class="n">DataclassFieldFactory</span><span class="p">,</span>
    <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span>  <span class="c1"># Now required</span>
    <span class="n">import_handler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImportHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Accept optionally</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize with field factory, relationship accessor, and import handler.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span> <span class="o">=</span> <span class="n">import_handler</span> <span class="ow">or</span> <span class="n">ImportHandler</span><span class="p">()</span>
    <span class="c1"># Call super init</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.factory.DataclassModelFactory.make_django_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.dataclass.factory.DataclassModelFactory.make_django_model" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Orchestrates the Django model creation process.
Subclasses implement _process_source_fields and _build_model_context.
Handles caching.
Passes import handler down.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">make_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the Django model creation process.</span>
<span class="sd">    Subclasses implement _process_source_fields and _build_model_context.</span>
<span class="sd">    Handles caching.</span>
<span class="sd">    Passes import handler down.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- Pass import handler via carrier --- (or could add to factory state)</span>
    <span class="c1"># Need to set import handler on carrier if passed during init</span>
    <span class="c1"># NOTE: BaseModelFactory.make_django_model does this now.</span>
    <span class="c1"># carrier.import_handler = self.import_handler</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_django_model</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
    <span class="c1"># Register relationship after successful model creation (moved from original)</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span> <span class="ow">and</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Mapping relationship in accessor: </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">map_relationship</span><span class="p">(</span>
            <span class="n">source_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">,</span> <span class="n">django_model</span><span class="o">=</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span>
        <span class="p">)</span>
    <span class="c1"># Cache result (moved from original)</span>
    <span class="n">model_key</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">model_key</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">carrier</span><span class="o">.</span><span class="n">existing_model</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_converted_models</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">carrier</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.dataclass.factory.DataclassFieldFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseFieldFactory (pydantic2django.core.factories.BaseFieldFactory)" href="#pydantic2django.core.factories.BaseFieldFactory">BaseFieldFactory</a>[<span title="dataclasses.Field">Field</span>]</code></p>


        <p>Creates Django model fields from dataclass fields.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataclassFieldFactory</span><span class="p">(</span><span class="n">BaseFieldFactory</span><span class="p">[</span><span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates Django model fields from dataclass fields.&quot;&quot;&quot;</span>

    <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span>  <span class="c1"># Changed Optional to required</span>
    <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>  <span class="c1"># Added mapper</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes with dependencies.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">bidirectional_mapper</span>
        <span class="c1"># No super().__init__() needed if BaseFieldFactory.__init__ is empty or handles this</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a dataclasses.Field to a Django field instance.</span>
<span class="sd">        Uses BidirectionalTypeMapper and local instantiation.</span>
<span class="sd">        Relies on field_info.metadata[&#39;django&#39;] for specific overrides.</span>
<span class="sd">        Adds required imports to the result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">name</span>
        <span class="n">original_field_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">type</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># Ensure metadata is a dict</span>
        <span class="n">django_meta_options</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># --- Resolve Forward Reference String if necessary --- #</span>
        <span class="n">type_to_map</span> <span class="o">=</span> <span class="n">original_field_type</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">FieldConversionResult</span><span class="p">(</span><span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; has string type &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39;. Attempting resolution via RelationshipAccessor.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Assume string type is a model name known to the accessor</span>
            <span class="c1"># Use the newly added method:</span>
            <span class="n">resolved_source_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_source_model_by_name</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resolved_source_model</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved string &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39; to type </span><span class="si">{</span><span class="n">resolved_source_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">type_to_map</span> <span class="o">=</span> <span class="n">resolved_source_model</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Critical Error: If it&#39;s a string but not in accessor, mapping will fail.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; type is string &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39; but was not found in RelationshipAccessor. Cannot map.&quot;</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unresolved forward reference or unknown model name: </span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="c1"># --- End Forward Reference Resolution ---</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Processing dataclass field </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: Type=</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">, Metadata=</span><span class="si">{</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># --- Use BidirectionalTypeMapper --- #</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Pass field_info.type, but no Pydantic FieldInfo equivalent for metadata</span>
                <span class="c1"># The mapper primarily relies on the type itself.</span>
                <span class="n">django_field_class</span><span class="p">,</span> <span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="o">.</span><span class="n">get_django_mapping</span><span class="p">(</span>
                    <span class="n">python_type</span><span class="o">=</span><span class="n">type_to_map</span><span class="p">,</span>
                    <span class="n">field_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Pass None for field_info</span>
                <span class="p">)</span>
                <span class="c1"># Add import for the Django field class itself using the result&#39;s helper</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_import_for_obj</span><span class="p">(</span><span class="n">django_field_class</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">MappingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping error for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">type_to_map</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error getting Django mapping for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected mapping error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># --- Handle GFK signal from mapper (List[Union[...]] of models) --- #</span>
            <span class="n">gfk_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gfk_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gfk_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[GFK] (dataclass) Mapper signaled GFK for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;. Recording as pending GFK child.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;gfk_details&quot;</span><span class="p">:</span> <span class="n">gfk_details</span><span class="p">,</span> <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="c1"># Do not generate a concrete field</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Received _gfk_details for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; but enable_gfk is False. Falling back to JSON field.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># --- Merge Dataclass Metadata Overrides --- #</span>
            <span class="c1"># Apply explicit options from metadata *after* getting defaults from mapper</span>
            <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">django_meta_options</span><span class="p">)</span>

            <span class="c1"># --- Apply Dataclass Defaults --- #</span>
            <span class="c1"># This logic now handles both `default` and `default_factory`.</span>
            <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span>
                <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span> <span class="ow">and</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
                    <span class="n">default_value</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span>

                <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">default_value</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Handle regular importable functions</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;&lt;lambda&gt;&quot;</span>
                            <span class="p">):</span>
                                <span class="n">module_name</span> <span class="o">=</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__module__</span>
                                <span class="n">func_name</span> <span class="o">=</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__name__</span>
                                <span class="c1"># Avoid importing builtins</span>
                                <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_name</span>
                            <span class="c1"># Handle lambdas</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">default_value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="c1"># Remove comma if it&#39;s trailing in a lambda definition in a list/dict</span>
                                <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                                    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawCode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Could not introspect callable default for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                                <span class="s2">&quot;Falling back to `None`.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                        <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> has mutable default </span><span class="si">{</span><span class="n">default_value</span><span class="si">}</span><span class="s2">. Skipping Django default.&quot;</span>
                        <span class="p">)</span>

            <span class="c1"># --- Handle Relationships Specifically (Adjust Kwargs) --- #</span>
            <span class="n">is_relationship</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span>
                <span class="n">django_field_class</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">is_relationship</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;to&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapper failed to determine &#39;to&#39; for relationship field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                    <span class="k">return</span> <span class="n">result</span>

                <span class="c1"># Sanitize and ensure unique related_name</span>
                <span class="n">user_related_name</span> <span class="o">=</span> <span class="n">django_meta_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_name&quot;</span><span class="p">)</span>  <span class="c1"># Check override from metadata</span>
                <span class="n">target_django_model_str</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>

                <span class="n">target_model_cls</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">target_model_cls</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span><span class="p">)</span>
                    <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">model_cls_name</span>
                    <span class="c1"># Add import for the target model using result helper</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add_import_for_obj</span><span class="p">(</span><span class="n">target_model_cls</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not get target model class for &#39;</span><span class="si">{</span><span class="n">target_django_model_str</span><span class="si">}</span><span class="s2">&#39; when generating related_name for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Using model name string.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">related_name_base</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">user_related_name</span>
                    <span class="k">if</span> <span class="n">user_related_name</span>
                    <span class="c1"># Use carrier.source_model.__name__ for default related name base</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_set&quot;</span>
                <span class="p">)</span>
                <span class="n">final_related_name_base</span> <span class="o">=</span> <span class="n">sanitize_related_name</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">related_name_base</span><span class="p">),</span>
                    <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_model_cls_name_only</span><span class="p">,</span>
                    <span class="n">field_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Ensure uniqueness using carrier&#39;s tracker</span>
                <span class="n">target_model_key_for_tracker</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_django_model_str</span>
                <span class="p">)</span>
                <span class="n">target_related_names</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="n">target_model_key_for_tracker</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">unique_related_name</span> <span class="o">=</span> <span class="n">final_related_name_base</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">unique_related_name</span> <span class="ow">in</span> <span class="n">target_related_names</span><span class="p">:</span>
                    <span class="n">unique_related_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_related_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">target_related_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique_related_name</span><span class="p">)</span>
                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;related_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_related_name</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[REL] Dataclass Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Assigning related_name=&#39;</span><span class="si">{</span><span class="n">unique_related_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="c1"># Re-confirm on_delete (mapper sets default based on Optional, but metadata might override)</span>
                <span class="c1"># Need to check optionality of the original type here</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
                <span class="n">is_optional</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">django_field_class</span> <span class="ow">in</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="s2">&quot;on_delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Only set if not specified in metadata</span>
                <span class="p">):</span>
                    <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
                    <span class="c1"># Add import using result helper</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.db.models&quot;</span><span class="p">,</span> <span class="s2">&quot;SET_NULL&quot;</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="s2">&quot;CASCADE&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">django_field_class</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">:</span>
                    <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;on_delete&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># M2M cannot be null</span>
                    <span class="k">if</span> <span class="s2">&quot;blank&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>  <span class="c1"># Default M2M to blank=True if not set</span>
                        <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># --- Perform Instantiation Locally --- #</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Instantiating </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for dataclass field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; with kwargs: </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">django_field_class</span><span class="p">(</span><span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Store final kwargs</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to instantiate Django field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) with kwargs </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># --- Generate Field Definition String --- #</span>
            <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Success</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch-all for unexpected errors during conversion</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error converting dataclass field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_field_def_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">FieldConversionResult</span><span class="p">,</span> <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the field definition string safely.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;# Field generation failed&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Use stored final kwargs if available</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">:</span>
                <span class="c1"># Pass the result&#39;s required_imports to the serialization function</span>
                <span class="k">return</span> <span class="n">generate_field_definition_string</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">),</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span><span class="p">,</span>
                    <span class="n">app_label</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback: Basic serialization if final kwargs weren&#39;t stored for some reason</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not generate definition string for &#39;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: final kwargs not found in result. Using basic serialization.&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">FieldSerializer</span><span class="o">.</span><span class="n">serialize_field</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">django_field</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to generate field definition string for &#39;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;# Error generating definition: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.factory.DataclassFieldFactory.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">relationship_accessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">)</span></code>

<a href="#pydantic2django.dataclass.factory.DataclassFieldFactory.__init__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Initializes with dependencies.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span> <span class="n">bidirectional_mapper</span><span class="p">:</span> <span class="n">BidirectionalTypeMapper</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes with dependencies.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">bidirectional_mapper</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.factory.DataclassFieldFactory.create_field" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_field</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span></code>

<a href="#pydantic2django.dataclass.factory.DataclassFieldFactory.create_field" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a dataclasses.Field to a Django field instance.
Uses BidirectionalTypeMapper and local instantiation.
Relies on field_info.metadata['django'] for specific overrides.
Adds required imports to the result.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_field</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">field_info</span><span class="p">:</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FieldConversionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a dataclasses.Field to a Django field instance.</span>
<span class="sd">    Uses BidirectionalTypeMapper and local instantiation.</span>
<span class="sd">    Relies on field_info.metadata[&#39;django&#39;] for specific overrides.</span>
<span class="sd">    Adds required imports to the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">name</span>
    <span class="n">original_field_type</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">type</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># Ensure metadata is a dict</span>
    <span class="n">django_meta_options</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;django&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># --- Resolve Forward Reference String if necessary --- #</span>
    <span class="n">type_to_map</span> <span class="o">=</span> <span class="n">original_field_type</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">FieldConversionResult</span><span class="p">(</span><span class="n">field_info</span><span class="o">=</span><span class="n">field_info</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; has string type &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39;. Attempting resolution via RelationshipAccessor.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Assume string type is a model name known to the accessor</span>
        <span class="c1"># Use the newly added method:</span>
        <span class="n">resolved_source_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="o">.</span><span class="n">get_source_model_by_name</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resolved_source_model</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved string &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39; to type </span><span class="si">{</span><span class="n">resolved_source_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">type_to_map</span> <span class="o">=</span> <span class="n">resolved_source_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Critical Error: If it&#39;s a string but not in accessor, mapping will fail.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; type is string &#39;</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&#39; but was not found in RelationshipAccessor. Cannot map.&quot;</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unresolved forward reference or unknown model name: </span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="c1"># --- End Forward Reference Resolution ---</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Processing dataclass field </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: Type=</span><span class="si">{</span><span class="n">original_field_type</span><span class="si">}</span><span class="s2">, Metadata=</span><span class="si">{</span><span class="n">metadata</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># --- Use BidirectionalTypeMapper --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Pass field_info.type, but no Pydantic FieldInfo equivalent for metadata</span>
            <span class="c1"># The mapper primarily relies on the type itself.</span>
            <span class="n">django_field_class</span><span class="p">,</span> <span class="n">constructor_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="o">.</span><span class="n">get_django_mapping</span><span class="p">(</span>
                <span class="n">python_type</span><span class="o">=</span><span class="n">type_to_map</span><span class="p">,</span>
                <span class="n">field_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Pass None for field_info</span>
            <span class="p">)</span>
            <span class="c1"># Add import for the Django field class itself using the result&#39;s helper</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_import_for_obj</span><span class="p">(</span><span class="n">django_field_class</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">MappingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapping error for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">type_to_map</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error getting Django mapping for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected mapping error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># --- Handle GFK signal from mapper (List[Union[...]] of models) --- #</span>
        <span class="n">gfk_details</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_gfk_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gfk_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gfk_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[GFK] (dataclass) Mapper signaled GFK for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39;. Recording as pending GFK child.&quot;</span>
                <span class="p">)</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">pending_gfk_children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;field_name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;gfk_details&quot;</span><span class="p">:</span> <span class="n">gfk_details</span><span class="p">,</span> <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="c1"># Do not generate a concrete field</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Received _gfk_details for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; but enable_gfk is False. Falling back to JSON field.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># --- Merge Dataclass Metadata Overrides --- #</span>
        <span class="c1"># Apply explicit options from metadata *after* getting defaults from mapper</span>
        <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">django_meta_options</span><span class="p">)</span>

        <span class="c1"># --- Apply Dataclass Defaults --- #</span>
        <span class="c1"># This logic now handles both `default` and `default_factory`.</span>
        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span> <span class="ow">and</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">field_info</span><span class="o">.</span><span class="n">default_factory</span>

            <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">MISSING</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">default_value</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Handle regular importable functions</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;&lt;lambda&gt;&quot;</span>
                        <span class="p">):</span>
                            <span class="n">module_name</span> <span class="o">=</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__module__</span>
                            <span class="n">func_name</span> <span class="o">=</span> <span class="n">default_value</span><span class="o">.</span><span class="vm">__name__</span>
                            <span class="c1"># Avoid importing builtins</span>
                            <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_name</span>
                        <span class="c1"># Handle lambdas</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">source</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">default_value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="c1"># Remove comma if it&#39;s trailing in a lambda definition in a list/dict</span>
                            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                                <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawCode</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not introspect callable default for &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
                            <span class="s2">&quot;Falling back to `None`.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;null&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                    <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> has mutable default </span><span class="si">{</span><span class="n">default_value</span><span class="si">}</span><span class="s2">. Skipping Django default.&quot;</span>
                    <span class="p">)</span>

        <span class="c1"># --- Handle Relationships Specifically (Adjust Kwargs) --- #</span>
        <span class="n">is_relationship</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span>
            <span class="n">django_field_class</span><span class="p">,</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_relationship</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;to&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mapper failed to determine &#39;to&#39; for relationship field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">error_str</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># Sanitize and ensure unique related_name</span>
            <span class="n">user_related_name</span> <span class="o">=</span> <span class="n">django_meta_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_name&quot;</span><span class="p">)</span>  <span class="c1"># Check override from metadata</span>
            <span class="n">target_django_model_str</span> <span class="o">=</span> <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span>

            <span class="n">target_model_cls</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">target_model_cls</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_cls_name</span><span class="p">)</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">model_cls_name</span>
                <span class="c1"># Add import for the target model using result helper</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_import_for_obj</span><span class="p">(</span><span class="n">target_model_cls</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not get target model class for &#39;</span><span class="si">{</span><span class="n">target_django_model_str</span><span class="si">}</span><span class="s2">&#39; when generating related_name for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Using model name string.&quot;</span>
                <span class="p">)</span>
                <span class="n">target_model_cls_name_only</span> <span class="o">=</span> <span class="n">target_django_model_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">related_name_base</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">user_related_name</span>
                <span class="k">if</span> <span class="n">user_related_name</span>
                <span class="c1"># Use carrier.source_model.__name__ for default related name base</span>
                <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_set&quot;</span>
            <span class="p">)</span>
            <span class="n">final_related_name_base</span> <span class="o">=</span> <span class="n">sanitize_related_name</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">related_name_base</span><span class="p">),</span>
                <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_model_cls_name_only</span><span class="p">,</span>
                <span class="n">field_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Ensure uniqueness using carrier&#39;s tracker</span>
            <span class="n">target_model_key_for_tracker</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">target_model_cls</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="n">target_model_cls</span> <span class="k">else</span> <span class="n">target_django_model_str</span>
            <span class="p">)</span>
            <span class="n">target_related_names</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">used_related_names_per_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                <span class="n">target_model_key_for_tracker</span><span class="p">,</span> <span class="nb">set</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">unique_related_name</span> <span class="o">=</span> <span class="n">final_related_name_base</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">unique_related_name</span> <span class="ow">in</span> <span class="n">target_related_names</span><span class="p">:</span>
                <span class="n">unique_related_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_related_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">target_related_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique_related_name</span><span class="p">)</span>
            <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;related_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_related_name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[REL] Dataclass Field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: Assigning related_name=&#39;</span><span class="si">{</span><span class="n">unique_related_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

            <span class="c1"># Re-confirm on_delete (mapper sets default based on Optional, but metadata might override)</span>
            <span class="c1"># Need to check optionality of the original type here</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">original_field_type</span><span class="p">)</span>
            <span class="n">is_optional</span> <span class="o">=</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">django_field_class</span> <span class="ow">in</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">&quot;on_delete&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Only set if not specified in metadata</span>
            <span class="p">):</span>
                <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
                <span class="c1"># Add import using result helper</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.db.models&quot;</span><span class="p">,</span> <span class="s2">&quot;SET_NULL&quot;</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="s2">&quot;CASCADE&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">django_field_class</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">:</span>
                <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;on_delete&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">constructor_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># M2M cannot be null</span>
                <span class="k">if</span> <span class="s2">&quot;blank&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constructor_kwargs</span><span class="p">:</span>  <span class="c1"># Default M2M to blank=True if not set</span>
                    <span class="n">constructor_kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># --- Perform Instantiation Locally --- #</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Instantiating </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> for dataclass field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; with kwargs: </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">django_field</span> <span class="o">=</span> <span class="n">django_field_class</span><span class="p">(</span><span class="o">**</span><span class="n">constructor_kwargs</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">field_kwargs</span> <span class="o">=</span> <span class="n">constructor_kwargs</span>  <span class="c1"># Store final kwargs</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to instantiate Django field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (type: </span><span class="si">{</span><span class="n">django_field_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">) with kwargs </span><span class="si">{</span><span class="n">constructor_kwargs</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># --- Generate Field Definition String --- #</span>
        <span class="n">result</span><span class="o">.</span><span class="n">field_definition_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_field_def_string</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carrier</span><span class="o">.</span><span class="n">meta_app_label</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>  <span class="c1"># Success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch-all for unexpected errors during conversion</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error converting dataclass field &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">error_str</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="n">result</span><span class="o">.</span><span class="n">context_field</span> <span class="o">=</span> <span class="n">field_info</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.dataclass.generator.DataclassDjangoModelGenerator"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseStaticGenerator (pydantic2django.core.base_generator.BaseStaticGenerator)" href="#pydantic2django.core.base_generator.BaseStaticGenerator">BaseStaticGenerator</a>[<span title="pydantic2django.dataclass.discovery.DataclassType">DataclassType</span>, <span title="pydantic2django.dataclass.generator.DataclassFieldInfo">DataclassFieldInfo</span>]</code></p>


        <p>Generates Django models.py file content from Python dataclasses.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/dataclass/generator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DataclassDjangoModelGenerator</span><span class="p">(</span>
    <span class="n">BaseStaticGenerator</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">,</span> <span class="n">DataclassFieldInfo</span><span class="p">]</span>  <span class="c1"># Inherit from BaseStaticGenerator</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates Django models.py file content from Python dataclasses.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filter_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">DataclassType</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]],</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="c1"># Accept specific discovery and factories, or create defaults</span>
        <span class="n">packages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">discovery_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataclassDiscovery</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_factory_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataclassModelFactory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">field_factory_instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataclassFieldFactory</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Add field factory param</span>
        <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RelationshipConversionAccessor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Accept accessor</span>
        <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enable_timescale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># --- GFK flags ---</span>
        <span class="n">enable_gfk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">gfk_policy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;threshold_by_children&quot;</span><span class="p">,</span>
        <span class="n">gfk_threshold_children</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">gfk_value_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">,</span>
        <span class="n">gfk_normalize_common_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># 1. Initialize Dataclass-specific discovery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_discovery_instance</span> <span class="o">=</span> <span class="n">discovery_instance</span> <span class="ow">or</span> <span class="n">DataclassDiscovery</span><span class="p">()</span>

        <span class="c1"># 2. Initialize Dataclass-specific factories</span>
        <span class="c1"># Dataclass factories might not need RelationshipAccessor, check their definitions</span>
        <span class="c1"># Assuming they don&#39;t for now.</span>
        <span class="c1"># --- Correction: They DO need them now ---</span>
        <span class="c1"># Use provided accessor or create a new one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span> <span class="o">=</span> <span class="n">relationship_accessor</span> <span class="ow">or</span> <span class="n">RelationshipConversionAccessor</span><span class="p">()</span>
        <span class="c1"># Create mapper using the (potentially provided) accessor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span> <span class="o">=</span> <span class="n">BidirectionalTypeMapper</span><span class="p">(</span><span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_field_factory</span> <span class="o">=</span> <span class="n">field_factory_instance</span> <span class="ow">or</span> <span class="n">DataclassFieldFactory</span><span class="p">(</span>
            <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">,</span>
            <span class="n">bidirectional_mapper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bidirectional_mapper</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_model_factory</span> <span class="o">=</span> <span class="n">model_factory_instance</span> <span class="ow">or</span> <span class="n">DataclassModelFactory</span><span class="p">(</span>
            <span class="n">field_factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_field_factory</span><span class="p">,</span>
            <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">,</span>  <span class="c1"># Pass only accessor</span>
        <span class="p">)</span>

        <span class="c1"># 3. Call the base class __init__</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">,</span>
            <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">filter_function</span><span class="o">=</span><span class="n">filter_function</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">discovery_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_discovery_instance</span><span class="p">,</span>
            <span class="n">model_factory_instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_model_factory</span><span class="p">,</span>
            <span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span><span class="p">,</span>
            <span class="n">base_model_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_default_base_model_class</span><span class="p">(),</span>
            <span class="n">enable_timescale</span><span class="o">=</span><span class="n">enable_timescale</span><span class="p">,</span>
            <span class="n">enable_gfk</span><span class="o">=</span><span class="n">enable_gfk</span><span class="p">,</span>
            <span class="n">gfk_policy</span><span class="o">=</span><span class="n">gfk_policy</span><span class="p">,</span>
            <span class="n">gfk_threshold_children</span><span class="o">=</span><span class="n">gfk_threshold_children</span><span class="p">,</span>
            <span class="n">gfk_value_mode</span><span class="o">=</span><span class="n">gfk_value_mode</span><span class="p">,</span>
            <span class="n">gfk_normalize_common_attrs</span><span class="o">=</span><span class="n">gfk_normalize_common_attrs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataclassDjangoModelGenerator initialized using BaseStaticGenerator.&quot;</span><span class="p">)</span>
        <span class="c1"># Timescale classification results cached per run (name -&gt; role)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TimescaleRole</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># --- Implement abstract methods from BaseStaticGenerator ---</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_source_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the name of the original dataclass from the carrier.&quot;&quot;&quot;</span>
        <span class="c1"># Use carrier.source_model (consistent with Base class)</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="c1"># Fallback if source model somehow missing</span>
        <span class="c1"># Check if carrier has pydantic_model attribute as a legacy fallback?</span>
        <span class="n">legacy_model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pydantic_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Safely check old attribute</span>
        <span class="k">if</span> <span class="n">legacy_model</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">legacy_model</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="s2">&quot;UnknownDataclass&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_source_model_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the necessary import for the original dataclass.&quot;&quot;&quot;</span>
        <span class="c1"># Use carrier.source_model</span>
        <span class="n">model_to_import</span> <span class="o">=</span> <span class="n">carrier</span><span class="o">.</span><span class="n">source_model</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_to_import</span><span class="p">:</span>
            <span class="c1"># Legacy fallback check</span>
            <span class="n">model_to_import</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pydantic_model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_to_import</span><span class="p">:</span>
            <span class="c1"># Use add_pydantic_model_import for consistency? Or add_context_field_type_import?</span>
            <span class="c1"># Let&#39;s assume add_context_field_type_import handles dataclasses too.</span>
            <span class="c1"># A dedicated add_dataclass_import or add_general_import would be clearer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_context_field_type_import</span><span class="p">(</span><span class="n">model_to_import</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot add source model import: source model missing in carrier.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_template_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the context specific to dataclasses for the main models_file.py.j2 template.&quot;&quot;&quot;</span>
        <span class="c1"># Base context items are passed in.</span>
        <span class="c1"># Add Dataclass-specific items.</span>
        <span class="n">base_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_definitions&quot;</span><span class="p">:</span> <span class="n">unique_model_definitions</span><span class="p">,</span>  <span class="c1"># Already joined by base class</span>
            <span class="s2">&quot;django_model_names&quot;</span><span class="p">:</span> <span class="n">django_model_names</span><span class="p">,</span>  <span class="c1"># Already list of quoted names</span>
            <span class="c1"># Pass the structured imports dict</span>
            <span class="s2">&quot;imports&quot;</span><span class="p">:</span> <span class="n">imports</span><span class="p">,</span>
            <span class="c1"># --- Dataclass Specific ---</span>
            <span class="s2">&quot;generation_source_type&quot;</span><span class="p">:</span> <span class="s2">&quot;dataclass&quot;</span><span class="p">,</span>  <span class="c1"># Flag for template logic</span>
            <span class="c1"># --- Keep compatibility if templates expect these --- (review templates later)</span>
            <span class="c1"># &quot;django_imports&quot;: sorted(imports.get(&quot;django&quot;, [])), # Provided by imports dict</span>
            <span class="c1"># &quot;pydantic_imports&quot;: sorted(imports.get(&quot;pydantic&quot;, [])), # Likely empty for dataclass</span>
            <span class="c1"># &quot;general_imports&quot;: sorted(imports.get(&quot;general&quot;, [])),</span>
            <span class="c1"># &quot;context_imports&quot;: sorted(imports.get(&quot;context&quot;, [])),</span>
            <span class="c1"># Add other dataclass specific flags/lists if needed by the template</span>
            <span class="s2">&quot;context_definitions&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># Dataclasses don&#39;t have separate context classes? Assume empty.</span>
            <span class="s2">&quot;context_class_names&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;model_has_context&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Assume no context model mapping needed</span>
        <span class="p">}</span>
        <span class="c1"># Common items added by base class generate_models_file after this call.</span>
        <span class="k">return</span> <span class="n">base_context</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_models_in_processing_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return dataclasses in dependency order using the discovery instance.&quot;&quot;&quot;</span>
        <span class="c1"># Add assertion for type checker clarity</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="p">,</span> <span class="n">DataclassDiscovery</span>
        <span class="p">),</span> <span class="s2">&quot;Discovery instance must be DataclassDiscovery for this generator&quot;</span>
        <span class="c1"># Dependencies analyzed by base class discover_models call</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">discovery_instance</span><span class="o">.</span><span class="n">get_models_in_registration_order</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_model_definition_extra_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">DataclassType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provide extra context specific to dataclasses for model_definition.py.j2.&quot;&quot;&quot;</span>
        <span class="c1"># Removed problematic metadata access from original</span>
        <span class="c1"># Add flags for template conditional logic</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;is_dataclass_source&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;is_pydantic_source&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;has_context&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Dataclasses likely don&#39;t generate separate context fields/classes</span>
            <span class="c1"># Pass the field definitions dictionary from the carrier</span>
            <span class="s2">&quot;field_definitions&quot;</span><span class="p">:</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">,</span>
            <span class="c1"># Add other specific details if needed, ensuring they access carrier correctly</span>
            <span class="c1"># Example: &quot;source_model_module&quot;: carrier.source_model.__module__ if carrier.source_model else &quot;&quot;</span>
        <span class="p">}</span>

    <span class="c1"># Choose Timescale base per model (lazy roles computation)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_django_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_model</span><span class="p">:</span> <span class="n">DataclassType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># type: ignore[override]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic2django.django.timescale.bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataclassTimescaleBase</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic2django.django.timescale.heuristics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">classify_dataclass_types</span><span class="p">,</span>
                <span class="n">should_use_timescale_base</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">classify_dataclass_types</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="n">should_use_timescale_base</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
            <span class="n">DataclassTimescaleBase</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Compute roles lazily if not present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_timescale_roles&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">roles</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TimescaleRole</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">models_to_score</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">models_to_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">models_to_score</span><span class="p">:</span>
                    <span class="n">models_to_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">source_model</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">classify_dataclass_types</span><span class="p">:</span>
                    <span class="n">roles</span> <span class="o">=</span> <span class="n">classify_dataclass_types</span><span class="p">(</span><span class="n">models_to_score</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">roles</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span> <span class="o">=</span> <span class="n">roles</span>

        <span class="c1"># Select base class</span>
        <span class="n">base_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_timescale</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="k">if</span> <span class="n">should_use_timescale_base</span> <span class="ow">and</span> <span class="n">DataclassTimescaleBase</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">should_use_timescale_base</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timescale_roles</span><span class="p">):</span>  <span class="c1"># type: ignore[arg-type]</span>
                        <span class="n">base_cls</span> <span class="o">=</span> <span class="n">DataclassTimescaleBase</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">prev_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">base_cls</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">carrier</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span> <span class="o">=</span> <span class="n">prev_base</span>

        <span class="k">if</span> <span class="n">carrier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">carrier</span><span class="o">.</span><span class="n">context_data</span><span class="p">[</span><span class="s2">&quot;_timescale_roles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_timescale_roles&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">carrier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_default_base_model_class</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the default Django base model for Dataclass conversion.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">django_apps</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AppRegistryNotReady</span><span class="p">(</span>
                <span class="s2">&quot;Django apps are not loaded. Call django.setup() or run within a configured Django context before &quot;</span>
                <span class="s2">&quot;instantiating DataclassDjangoModelGenerator.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">typed2django.django.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataclass2DjangoBaseClass</span> <span class="k">as</span> <span class="n">_Base</span>

            <span class="k">return</span> <span class="n">_Base</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover - defensive</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;typed2django.django.models.Dataclass2DjangoBaseClass is required for Dataclass generation.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate models for dataclasses with GFK finalize hook.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>
        <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>

        <span class="c1"># Reset imports and state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>

        <span class="c1"># Setup carriers</span>
        <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>

        <span class="c1"># GFK finalize: inject GenericRelation on parents</span>
        <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pending_gfk_children&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>
                    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span>
                        <span class="s2">&quot;entries&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GenericRelation(&#39;GenericEntry&#39;, related_query_name=&#39;entries&#39;)&quot;</span>
                    <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Render model definitions</span>
        <span class="n">model_definitions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">django_model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model_def</span><span class="p">:</span>
                        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
                        <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">gfk_used</span><span class="p">:</span>
            <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_generic_entry_model_definition</span><span class="p">())</span>
            <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;GenericEntry&#39;&quot;</span><span class="p">)</span>

        <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>
        <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>
        <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>
        <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
                <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_generic_entry_model_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build the GenericEntry model definition for dataclass generation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>

        <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;content_type = models.ForeignKey(&#39;contenttypes.ContentType&#39;, on_delete=models.CASCADE)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;object_id = models.PositiveIntegerField()&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;content_object = GenericForeignKey(&#39;content_type&#39;, &#39;object_id&#39;)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;element_qname = models.CharField(max_length=255)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;type_qname = models.CharField(max_length=255, null=True, blank=True)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;attrs_json = models.JSONField(default=dict, blank=True)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gfk_value_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;text_value = models.TextField(null=True, blank=True)&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;num_value = models.DecimalField(max_digits=20, decimal_places=6, null=True, blank=True)&quot;</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;time_value = models.DateTimeField(null=True, blank=True)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;order_index = models.IntegerField(default=0)&quot;</span><span class="p">)</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path_hint = models.CharField(max_length=255, null=True, blank=True)&quot;</span><span class="p">)</span>

        <span class="n">indexes_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;models.Index(fields=[&#39;content_type&#39;, &#39;object_id&#39;])&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;gfk_value_mode&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;typed_columns&quot;</span><span class="p">:</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;element_qname&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;type_qname&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;time_value&#39;])&quot;</span><span class="p">)</span>
            <span class="n">indexes_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;models.Index(fields=[&#39;content_type&#39;, &#39;object_id&#39;, &#39;-time_value&#39;])&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class GenericEntry(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    class Meta:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        app_label = &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        abstract = False&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        indexes = [&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indexes_lines</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;        ]&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.dataclass.generator.DataclassDjangoModelGenerator.generate_models_file" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_models_file</span><span class="p">()</span></code>

<a href="#pydantic2django.dataclass.generator.DataclassDjangoModelGenerator.generate_models_file" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate models for dataclasses with GFK finalize hook.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/dataclass/generator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">generate_models_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate models for dataclasses with GFK finalize hook.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">discover_models</span><span class="p">()</span>
    <span class="n">models_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_in_processing_order</span><span class="p">()</span>

    <span class="c1"># Reset imports and state</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">pydantic_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">context_class_imports</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">imported_names</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">processed_field_types</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">_add_type_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="p">)</span>

    <span class="c1"># Setup carriers</span>
    <span class="k">for</span> <span class="n">source_model</span> <span class="ow">in</span> <span class="n">models_to_process</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_django_model</span><span class="p">(</span><span class="n">source_model</span><span class="p">)</span>

    <span class="c1"># GFK finalize: inject GenericRelation on parents</span>
    <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;enable_gfk&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span> <span class="s2">&quot;pending_gfk_children&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericRelation&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.fields&quot;</span><span class="p">,</span> <span class="s2">&quot;GenericForeignKey&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">&quot;django.contrib.contenttypes.models&quot;</span><span class="p">,</span> <span class="s2">&quot;ContentType&quot;</span><span class="p">)</span>
                <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span><span class="p">[</span>
                    <span class="s2">&quot;entries&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GenericRelation(&#39;GenericEntry&#39;, related_query_name=&#39;entries&#39;)&quot;</span>
                <span class="n">gfk_used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Render model definitions</span>
    <span class="n">model_definitions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">django_model_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">carrier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">carriers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model_definition</span><span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model_def</span><span class="p">:</span>
                    <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_def</span><span class="p">)</span>
                    <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_clean_generic_type</span><span class="p">(</span><span class="n">carrier</span><span class="o">.</span><span class="n">django_model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">if</span> <span class="n">gfk_used</span><span class="p">:</span>
        <span class="n">model_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_generic_entry_model_definition</span><span class="p">())</span>
        <span class="n">django_model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;GenericEntry&#39;&quot;</span><span class="p">)</span>

    <span class="n">unique_model_definitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate_definitions</span><span class="p">(</span><span class="n">model_definitions</span><span class="p">)</span>
    <span class="n">imports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">deduplicate_imports</span><span class="p">()</span>
    <span class="n">template_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_template_context</span><span class="p">(</span><span class="n">unique_model_definitions</span><span class="p">,</span> <span class="n">django_model_names</span><span class="p">,</span> <span class="n">imports</span><span class="p">)</span>
    <span class="n">template_context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;generation_timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
            <span class="s2">&quot;base_model_module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s2">&quot;base_model_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;extra_type_imports&quot;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_handler</span><span class="o">.</span><span class="n">extra_type_imports</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s2">&quot;models_file.py.j2&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p>Notes:</p>
</li>
<li>Reads field metadata and optional per-field <code>django</code> overrides from <code>dataclasses.Field.metadata</code>.</li>
<li>Uses <code>typing.get_type_hints</code> to resolve forward references.</li>
</ul>
<h4 id="typedclass-experimental">TypedClass (experimental)<a class="headerlink" href="#typedclass-experimental" title="Permanent link">&para;</a></h4>
<ul>
<li>Discovery and factory (subject to change as APIs stabilize):</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.typedclass.discovery.TypedClassDiscovery"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseDiscovery (pydantic2django.core.discovery.BaseDiscovery)" href="#pydantic2django.core.discovery.BaseDiscovery">BaseDiscovery</a>[<span title="pydantic2django.typedclass.discovery.TypedClassType">TypedClassType</span>]</code></p>


        <p>Discovers generic Python classes within specified packages.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/typedclass/discovery.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TypedClassDiscovery</span><span class="p">(</span><span class="n">BaseDiscovery</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovers generic Python classes within specified packages.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># TypedClass specific attributes, if any, can be initialized here.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_pydantic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if an object is a Pydantic model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_target_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if an object is a generic class suitable for conversion.</span>
<span class="sd">        It must be a class, not an ABC, not a Pydantic model, and not a dataclass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping abstract class </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s a Pydantic model</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping Pydantic model </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping dataclass </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Further checks can be added here, e.g., must be in a specific list</span>
        <span class="c1"># or have certain characteristics. For now, this is a basic filter.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Identified potential target typed class: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_default_eligibility_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check default eligibility for generic classes.</span>
<span class="sd">        For example, we might want to ensure it&#39;s not an ABC, though</span>
<span class="sd">        _is_target_model should already catch this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Redundant check if _is_target_model is comprehensive, but good for safety.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isabstract</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering out typed class </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (is abstract)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Add other default checks if needed.</span>
        <span class="c1"># For instance, are there specific base classes (not ABCs) we want to exclude/include?</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the dependency graph for the filtered generic classes.</span>
<span class="sd">        Dependencies are determined by type hints in __init__ arguments</span>
<span class="sd">        and class-level attribute annotations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered typed classes...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Ensure all filtered models are keys in the dependencies dict</span>
        <span class="k">for</span> <span class="n">model_qualname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span>
            <span class="n">model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_obj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">source_model</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">,</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper to check if a potential dependency type is a target model</span>
<span class="sd">            and add it to the graph.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Check if potential_dep_type itself is a class and one of our targets</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
                <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">source_model</span><span class="p">:</span>
                    <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">source_model</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for typed class &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not as object in filtered set.&quot;</span>
                        <span class="p">)</span>
            <span class="c1"># TODO: Handle generics like list[TargetType], dict[str, TargetType], Union[TargetType, None]</span>
            <span class="c1"># This would involve using get_origin and get_args from typing.</span>

        <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="c1"># 1. Analyze __init__ parameters</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">init_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">init_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span> <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Some built-ins or exotic classes might not have inspectable __init__</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not inspect __init__ for </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 2. Analyze class-level annotations</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">eval_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr_type</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get annotations for </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Typed class dependency analysis complete.&quot;</span><span class="p">)</span>
        <span class="c1"># Debug logging of dependencies will be handled by BaseDiscovery.log_dependencies</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return generic classes sorted topologically based on dependencies.</span>
<span class="sd">        This method can often be inherited from BaseDiscovery if the dependency</span>
<span class="sd">        graph is built correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For now, assume BaseDiscovery&#39;s implementation is sufficient.</span>
        <span class="c1"># If specific logic for typed classes is needed, override here.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_models_in_registration_order</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.typedclass.discovery.TypedClassDiscovery.analyze_dependencies" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_dependencies</span><span class="p">()</span></code>

<a href="#pydantic2django.typedclass.discovery.TypedClassDiscovery.analyze_dependencies" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Build the dependency graph for the filtered generic classes.
Dependencies are determined by type hints in <strong>init</strong> arguments
and class-level attribute annotations.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/typedclass/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build the dependency graph for the filtered generic classes.</span>
<span class="sd">    Dependencies are determined by type hints in __init__ arguments</span>
<span class="sd">    and class-level attribute annotations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Analyzing dependencies between filtered typed classes...&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Ensure all filtered models are keys in the dependencies dict</span>
    <span class="k">for</span> <span class="n">model_qualname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">:</span>
        <span class="n">model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="p">[</span><span class="n">model_qualname</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">model_obj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">filtered_model_qualnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_and_add_dependency</span><span class="p">(</span><span class="n">source_model</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">,</span> <span class="n">potential_dep_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to check if a potential dependency type is a target model</span>
<span class="sd">        and add it to the graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if potential_dep_type itself is a class and one of our targets</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_target_model</span><span class="p">(</span><span class="n">potential_dep_type</span><span class="p">):</span>
            <span class="n">dep_qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">potential_dep_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">dep_qualname</span> <span class="ow">in</span> <span class="n">filtered_model_qualnames</span> <span class="ow">and</span> <span class="n">potential_dep_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">source_model</span><span class="p">:</span>
                <span class="n">dep_model_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep_qualname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dep_model_obj</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">source_model</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_model_obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Inconsistency: Dependency &#39;</span><span class="si">{</span><span class="n">dep_qualname</span><span class="si">}</span><span class="s2">&#39; for typed class &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">source_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; found by name but not as object in filtered set.&quot;</span>
                    <span class="p">)</span>
        <span class="c1"># TODO: Handle generics like list[TargetType], dict[str, TargetType], Union[TargetType, None]</span>
        <span class="c1"># This would involve using get_origin and get_args from typing.</span>

    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_models</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># 1. Analyze __init__ parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">init_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">init_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span> <span class="ow">or</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Some built-ins or exotic classes might not have inspectable __init__</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not inspect __init__ for </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Analyze class-level annotations</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">eval_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">attr_type</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_find_and_add_dependency</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">attr_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get annotations for </span><span class="si">{</span><span class="n">model_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Typed class dependency analysis complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.typedclass.discovery.TypedClassDiscovery.get_models_in_registration_order" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_models_in_registration_order</span><span class="p">()</span></code>

<a href="#pydantic2django.typedclass.discovery.TypedClassDiscovery.get_models_in_registration_order" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Return generic classes sorted topologically based on dependencies.
This method can often be inherited from BaseDiscovery if the dependency
graph is built correctly.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/typedclass/discovery.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_models_in_registration_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return generic classes sorted topologically based on dependencies.</span>
<span class="sd">    This method can often be inherited from BaseDiscovery if the dependency</span>
<span class="sd">    graph is built correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For now, assume BaseDiscovery&#39;s implementation is sufficient.</span>
    <span class="c1"># If specific logic for typed classes is needed, override here.</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_models_in_registration_order</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.typedclass.factory.TypedClassModelFactory"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="BaseModelFactory (pydantic2django.core.factories.BaseModelFactory)" href="#pydantic2django.core.factories.BaseModelFactory">BaseModelFactory</a>[<span title="pydantic2django.typedclass.discovery.TypedClassType">TypedClassType</span>, <a class="autorefs autorefs-internal" title="TypedClassFieldInfo


  
      dataclass
   (pydantic2django.typedclass.factory.TypedClassFieldInfo)" href="../../reference/pydantic2django/typedclass/factory/#pydantic2django.typedclass.factory.TypedClassFieldInfo">TypedClassFieldInfo</a>]</code></p>


        <p>Creates Django model definitions from generic Python classes.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/typedclass/factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TypedClassModelFactory</span><span class="p">(</span><span class="n">BaseModelFactory</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">,</span> <span class="n">TypedClassFieldInfo</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates Django model definitions from generic Python classes.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_factory</span><span class="p">:</span> <span class="n">TypedClassFieldFactory</span><span class="p">,</span>
        <span class="n">relationship_accessor</span><span class="p">:</span> <span class="n">RelationshipConversionAccessor</span><span class="p">,</span>
        <span class="c1"># Add &#39;reckless_mode: bool = False&#39; if implementing that flag</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">field_factory</span><span class="p">,</span> <span class="n">relationship_accessor</span><span class="p">)</span>
        <span class="c1"># self.reckless_mode = reckless_mode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_model_fields_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">,</span> <span class="n">carrier</span><span class="p">:</span> <span class="n">ConversionCarrier</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">TypedClassFieldInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts attribute information from a generic class.</span>
<span class="sd">        Prioritizes __init__ signature, then class-level annotations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_infos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">processed_params</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># 1. Inspect __init__ method</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">init_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">init_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">type_hint</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">Any</span>
                <span class="n">default_val</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>

                <span class="n">field_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TypedClassFieldInfo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">type_hint</span><span class="o">=</span><span class="n">type_hint</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_val</span><span class="p">,</span> <span class="n">is_from_init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">processed_params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not inspect __init__ for </span><span class="si">{</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding with class annotations.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># 2. Inspect class-level annotations (for attributes not in __init__)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">eval_str</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">type_hint</span> <span class="ow">in</span> <span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_params</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>  <span class="c1"># Avoid private/protected by convention</span>
                    <span class="n">default_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
                    <span class="n">field_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TypedClassFieldInfo</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">type_hint</span><span class="o">=</span><span class="n">type_hint</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="n">default_val</span><span class="p">,</span> <span class="n">is_from_init</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Broad exception as get_annotations can fail in various ways</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get class annotations for </span><span class="si">{</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered field infos for </span><span class="si">{</span><span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">field_infos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_infos</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_model_definition</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_class</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">,</span>
        <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">base_model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">],</span>
        <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a ConversionCarrier containing the Django model string and related info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">django_model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">DjangoModel&quot;</span>  <span class="c1"># Or some other naming convention</span>

        <span class="n">carrier</span> <span class="o">=</span> <span class="n">ConversionCarrier</span><span class="p">(</span>
            <span class="n">source_model</span><span class="o">=</span><span class="n">model_class</span><span class="p">,</span>
            <span class="n">source_model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">django_model_name</span><span class="o">=</span><span class="n">django_model_name</span><span class="p">,</span>
            <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span> <span class="ow">or</span> <span class="p">{},</span>
            <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add import for the base model class</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">add_django_model_import</span><span class="p">(</span><span class="n">base_model_class</span><span class="p">)</span>

        <span class="n">field_definitions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model_fields_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_fields_info</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_fields_info</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fields discovered for class </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Generating an empty Django model.&quot;</span><span class="p">)</span>
            <span class="c1"># Optionally, add a default placeholder field if empty models are problematic</span>
            <span class="c1"># field_definitions.append(&quot;    # No convertible fields found&quot;)</span>

        <span class="k">for</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">model_fields_info</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_def_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span><span class="o">.</span><span class="n">create_field_definition</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span>
                <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">field_def_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error creating field definition for </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="c1"># Optionally, add a placeholder or skip this field</span>
                <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    # Error processing field: </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span> <span class="o">=</span> <span class="n">field_definitions</span>

        <span class="c1"># Meta class</span>
        <span class="n">carrier</span><span class="o">.</span><span class="n">meta_class_string</span> <span class="o">=</span> <span class="n">generate_meta_class_string</span><span class="p">(</span>
            <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
            <span class="n">django_model_name</span><span class="o">=</span><span class="n">django_model_name</span><span class="p">,</span>  <span class="c1"># Use the generated Django model name</span>
            <span class="n">verbose_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># __str__ method</span>
        <span class="c1"># Heuristic: use &#39;name&#39; or &#39;id&#39; attribute if present in field_infos, else default</span>
        <span class="n">str_field</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>  <span class="c1"># Django models get &#39;id&#39; by default from models.Model</span>
        <span class="k">for</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">model_fields_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">finfo</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">]:</span>  <span class="c1"># common __str__ candidates</span>
                <span class="n">str_field</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">name</span>
                <span class="k">break</span>

        <span class="n">carrier</span><span class="o">.</span><span class="n">str_method_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    def __str__(self):</span><span class="se">\n</span><span class="s2">        return str(self.</span><span class="si">{</span><span class="n">str_field</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prepared ConversionCarrier for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">carrier</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.typedclass.factory.TypedClassModelFactory.create_model_definition" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_model_definition</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">base_model_class</span><span class="p">,</span> <span class="n">module_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.typedclass.factory.TypedClassModelFactory.create_model_definition" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generates a ConversionCarrier containing the Django model string and related info.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/typedclass/factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_model_definition</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_class</span><span class="p">:</span> <span class="n">TypedClassType</span><span class="p">,</span>
    <span class="n">app_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">base_model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">],</span>
    <span class="n">module_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversionCarrier</span><span class="p">[</span><span class="n">TypedClassType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a ConversionCarrier containing the Django model string and related info.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">django_model_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">DjangoModel&quot;</span>  <span class="c1"># Or some other naming convention</span>

    <span class="n">carrier</span> <span class="o">=</span> <span class="n">ConversionCarrier</span><span class="p">(</span>
        <span class="n">source_model</span><span class="o">=</span><span class="n">model_class</span><span class="p">,</span>
        <span class="n">source_model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">django_model_name</span><span class="o">=</span><span class="n">django_model_name</span><span class="p">,</span>
        <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
        <span class="n">module_mappings</span><span class="o">=</span><span class="n">module_mappings</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="n">relationship_accessor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">relationship_accessor</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Add import for the base model class</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">add_django_model_import</span><span class="p">(</span><span class="n">base_model_class</span><span class="p">)</span>

    <span class="n">field_definitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_fields_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_fields_info</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">model_fields_info</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No fields discovered for class </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Generating an empty Django model.&quot;</span><span class="p">)</span>
        <span class="c1"># Optionally, add a default placeholder field if empty models are problematic</span>
        <span class="c1"># field_definitions.append(&quot;    # No convertible fields found&quot;)</span>

    <span class="k">for</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">model_fields_info</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_def_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_factory</span><span class="o">.</span><span class="n">create_field_definition</span><span class="p">(</span><span class="n">field_info</span><span class="p">,</span> <span class="n">carrier</span><span class="p">)</span>
            <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">field_def_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error creating field definition for </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="c1"># Optionally, add a placeholder or skip this field</span>
            <span class="n">field_definitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    # Error processing field: </span><span class="si">{</span><span class="n">field_info</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">carrier</span><span class="o">.</span><span class="n">django_field_definitions</span> <span class="o">=</span> <span class="n">field_definitions</span>

    <span class="c1"># Meta class</span>
    <span class="n">carrier</span><span class="o">.</span><span class="n">meta_class_string</span> <span class="o">=</span> <span class="n">generate_meta_class_string</span><span class="p">(</span>
        <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">,</span>
        <span class="n">django_model_name</span><span class="o">=</span><span class="n">django_model_name</span><span class="p">,</span>  <span class="c1"># Use the generated Django model name</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># __str__ method</span>
    <span class="c1"># Heuristic: use &#39;name&#39; or &#39;id&#39; attribute if present in field_infos, else default</span>
    <span class="n">str_field</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>  <span class="c1"># Django models get &#39;id&#39; by default from models.Model</span>
    <span class="k">for</span> <span class="n">finfo</span> <span class="ow">in</span> <span class="n">model_fields_info</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">finfo</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">]:</span>  <span class="c1"># common __str__ candidates</span>
            <span class="n">str_field</span> <span class="o">=</span> <span class="n">finfo</span><span class="o">.</span><span class="n">name</span>
            <span class="k">break</span>

    <span class="n">carrier</span><span class="o">.</span><span class="n">str_method_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;    def __str__(self):</span><span class="se">\n</span><span class="s2">        return str(self.</span><span class="si">{</span><span class="n">str_field</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prepared ConversionCarrier for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">django_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">carrier</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>
<p>Notes:</p>
</li>
<li>Targets arbitrary typed Python classes (non-Pydantic, non-dataclass). APIs are evolving.</li>
</ul>
<h3 id="django-base-models-runtime-mapping-and-storage">Django base models (runtime mapping and storage)<a class="headerlink" href="#django-base-models-runtime-mapping-and-storage" title="Permanent link">&para;</a></h3>
<p>These abstract models provide runtime persistence patterns for typed objects.</p>
<ul>
<li>Store entire objects as JSON or map their fields to columns. See:</li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.django.models.Pydantic2DjangoBaseClass"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Pydantic2DjangoBase (pydantic2django.django.models.Pydantic2DjangoBase)" href="../../reference/pydantic2django/django/models/#pydantic2django.django.models.Pydantic2DjangoBase">Pydantic2DjangoBase</a></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.django.models.PydanticT">PydanticT</span>]</code></p>


        <p>Base class for mapping Pydantic model fields to Django model fields.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Pydantic2DjangoBaseClass</span><span class="p">(</span><span class="n">Pydantic2DjangoBase</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">PydanticT</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for mapping Pydantic model fields to Django model fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">Pydantic2DjangoBase</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">&quot;Mapped Pydantic Object&quot;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Mapped Pydantic Objects&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override __new__ to ensure proper type checking.</span>
<span class="sd">        Needed because Django&#39;s model metaclass doesn&#39;t preserve Generic type parameters well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The check itself might be complex. This placeholder ensures __new__ is considered.</span>
        <span class="c1"># Proper generic handling might require metaclass adjustments beyond this scope.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward method calls to the Pydantic model implementation.</span>
<span class="sd">        Enables type checking and execution of methods defined on the Pydantic model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the Pydantic model class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pydantic_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>  <span class="c1"># Use common method</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                <span class="c1"># This path shouldn&#39;t be hit if used correctly, but safeguard</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; is not a Pydantic BaseModel.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot forward attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Check if the attribute exists in the Pydantic model</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="c1"># If it&#39;s a callable method (and not the type itself), wrap it</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">wrapped_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="c1"># Convert self (Django model) to Pydantic instance first</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pydantic_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pydantic</span><span class="p">()</span>  <span class="c1"># Assuming no context needed here</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Handle potential errors during conversion (e.g., context missing)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Failed to convert Django model to Pydantic before calling &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                    <span class="c1"># Call the method on the Pydantic instance</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_instance</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="c1"># TODO: Handle potential need to update self from result? Unlikely for most methods.</span>
                    <span class="k">return</span> <span class="n">result</span>

                <span class="k">return</span> <span class="n">wrapped_method</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For non-method attributes (like class vars), return directly</span>
                <span class="c1"># This might need refinement depending on desired behavior for class vs instance attrs</span>
                <span class="k">return</span> <span class="n">attr</span>

        <span class="c1"># If attribute doesn&#39;t exist on Pydantic model, raise standard AttributeError</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and Pydantic model &#39;</span><span class="si">{</span><span class="n">pydantic_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_pydantic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Pydantic2DjangoBaseClass[PydanticT]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Django model instance from a Pydantic object, mapping fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            pydantic_obj: The Pydantic object to convert.</span>
<span class="sd">            name: Optional name for the Django model instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new instance of this Django model subclass.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the object is not a Pydantic model or not of the expected type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get class info and check type</span>
        <span class="p">(</span>
            <span class="n">pydantic_class</span><span class="p">,</span>
            <span class="n">class_name</span><span class="p">,</span>
            <span class="n">module_name</span><span class="p">,</span>
            <span class="n">fully_qualified_name</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>  <span class="c1"># Verifies it&#39;s a Pydantic model</span>

        <span class="c1"># Derive name</span>
        <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="c1"># Create instance with basic fields</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
            <span class="n">class_path</span><span class="o">=</span><span class="n">fully_qualified_name</span><span class="p">,</span>  <span class="c1"># Use renamed field</span>
        <span class="p">)</span>

        <span class="c1"># Update mapped fields</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model&#39;s fields from a Pydantic object&#39;s fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            pydantic_obj: The Pydantic object containing source values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="ow">or</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">):</span>
            <span class="c1"># Check type consistency before proceeding</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get data from the Pydantic object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pydantic_data</span> <span class="o">=</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Failed to dump Pydantic model for update. Ensure you are using Pydantic v2+ with model_dump().&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># Get Django model fields excluding common/meta ones</span>
        <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Update each Django field if it matches a field in the Pydantic data</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">pydantic_data</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pydantic_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="c1"># Apply serialization (important for complex types)</span>
                <span class="n">serialized_value</span> <span class="o">=</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialized_value</span><span class="p">)</span>
            <span class="c1"># Else: Field exists on Django model but not on Pydantic model, leave it unchanged.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ModelContext</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PydanticT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this Django model instance back to a Pydantic object.</span>

<span class="sd">        Args:</span>
<span class="sd">            context: Optional ModelContext instance containing values for non-serializable fields.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The corresponding Pydantic object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If context is required but not provided, or if class load/instantiation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pydantic_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>  <span class="c1"># Use common method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pydantic_class</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class path &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; does not point to a Pydantic BaseModel.&quot;</span><span class="p">)</span>

        <span class="c1"># Get data from Django fields corresponding to Pydantic fields</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_pydantic</span><span class="p">(</span><span class="n">pydantic_class</span><span class="p">)</span>

        <span class="c1"># Handle context if required and provided</span>
        <span class="n">required_context_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_context_fields</span><span class="p">()</span>  <span class="c1"># Check if context is needed</span>
        <span class="k">if</span> <span class="n">required_context_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Conversion to Pydantic model &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; requires context &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;for fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_context_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please provide a ModelContext instance.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Validate and merge context data</span>
            <span class="n">context_dict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_conversion_dict</span><span class="p">()</span>
            <span class="n">context</span><span class="o">.</span><span class="n">validate_context</span><span class="p">(</span><span class="n">context_dict</span><span class="p">)</span>  <span class="c1"># Validate required keys are present</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context_dict</span><span class="p">)</span>  <span class="c1"># Merge context, potentially overwriting DB values if keys overlap</span>

        <span class="c1"># Reconstruct the Pydantic object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Add potential deserialization logic here if needed before validation</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">pydantic_class</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Cast to the generic type variable</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise TypeError as it&#39;s a specific, meaningful exception here</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Catch any other unexpected error during Pydantic object creation</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred creating Pydantic model for &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error creating Pydantic model for &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_data_for_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data from Django fields that correspond to the target Pydantic model fields.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pydantic_field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pydantic_class</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># Should not happen if issubclass(BaseModel) check passed</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get fields for non-Pydantic type &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># Add DB fields that are part of the Pydantic model</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">pydantic_field_names</span><span class="p">:</span>
                <span class="c1"># TODO: Add potential deserialization based on target Pydantic field type?</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Context values are merged in the calling `to_pydantic` method</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_required_context_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the set of field names that require context when converting to Pydantic.</span>
<span class="sd">        (Placeholder implementation - needs refinement based on how context is defined).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This requires a mechanism to identify which Django fields represent</span>
        <span class="c1"># non-serializable data that must come from context.</span>
        <span class="c1"># For now, assume no context is required by default for the base class.</span>
        <span class="c1"># Subclasses might override this or a more sophisticated mechanism could be added.</span>
        <span class="c1"># Example: Check for a custom field attribute like `is_context_field=True`</span>
        <span class="n">required_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># pydantic_class = self._get_class()</span>
        <span class="c1"># pydantic_field_names = set(pydantic_class.model_fields.keys())</span>
        <span class="c1"># for field in self._meta.fields:</span>
        <span class="c1">#     if field.name in pydantic_field_names and getattr(field, &#39;is_context_field&#39;, False):</span>
        <span class="c1">#         required_fields.add(field.name)</span>
        <span class="k">return</span> <span class="n">required_fields</span>  <span class="c1"># Return empty set for now</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model with new data from a Pydantic object and save.</span>

<span class="sd">        Args:</span>
<span class="sd">            pydantic_obj: The Pydantic object with updated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verify the object type matches first (includes check if it&#39;s a BaseModel)</span>
        <span class="n">fully_qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>

        <span class="c1"># Update the class_path if somehow inconsistent</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fully_qualified_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fully_qualified_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PydanticT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Django model and return the corresponding Pydantic object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The corresponding Pydantic object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pydantic</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.__getattr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.__getattr__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Forward method calls to the Pydantic model implementation.
Enables type checking and execution of methods defined on the Pydantic model.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward method calls to the Pydantic model implementation.</span>
<span class="sd">    Enables type checking and execution of methods defined on the Pydantic model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the Pydantic model class</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pydantic_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>  <span class="c1"># Use common method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="c1"># This path shouldn&#39;t be hit if used correctly, but safeguard</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; is not a Pydantic BaseModel.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot forward attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Check if the attribute exists in the Pydantic model</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># If it&#39;s a callable method (and not the type itself), wrap it</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">wrapped_method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="c1"># Convert self (Django model) to Pydantic instance first</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pydantic_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pydantic</span><span class="p">()</span>  <span class="c1"># Assuming no context needed here</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Handle potential errors during conversion (e.g., context missing)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to convert Django model to Pydantic before calling &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

                <span class="c1"># Call the method on the Pydantic instance</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pydantic_instance</span><span class="p">,</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># TODO: Handle potential need to update self from result? Unlikely for most methods.</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="k">return</span> <span class="n">wrapped_method</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For non-method attributes (like class vars), return directly</span>
            <span class="c1"># This might need refinement depending on desired behavior for class vs instance attrs</span>
            <span class="k">return</span> <span class="n">attr</span>

    <span class="c1"># If attribute doesn&#39;t exist on Pydantic model, raise standard AttributeError</span>
    <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;and Pydantic model &#39;</span><span class="si">{</span><span class="n">pydantic_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.__new__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__new__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.__new__" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Override <strong>new</strong> to ensure proper type checking.
Needed because Django's model metaclass doesn't preserve Generic type parameters well.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Override __new__ to ensure proper type checking.</span>
<span class="sd">    Needed because Django&#39;s model metaclass doesn&#39;t preserve Generic type parameters well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The check itself might be complex. This placeholder ensures __new__ is considered.</span>
    <span class="c1"># Proper generic handling might require metaclass adjustments beyond this scope.</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.from_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.from_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a Django model instance from a Pydantic object, mapping fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pydantic_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.PydanticT">PydanticT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Pydantic object to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the Django model instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Pydantic2DjangoBaseClass (pydantic2django.django.models.Pydantic2DjangoBaseClass)" href="#pydantic2django.django.models.Pydantic2DjangoBaseClass">Pydantic2DjangoBaseClass</a>[<span title="pydantic2django.django.models.PydanticT">PydanticT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new instance of this Django model subclass.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the object is not a Pydantic model or not of the expected type.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_pydantic</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Pydantic2DjangoBaseClass[PydanticT]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Django model instance from a Pydantic object, mapping fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        pydantic_obj: The Pydantic object to convert.</span>
<span class="sd">        name: Optional name for the Django model instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new instance of this Django model subclass.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the object is not a Pydantic model or not of the expected type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get class info and check type</span>
    <span class="p">(</span>
        <span class="n">pydantic_class</span><span class="p">,</span>
        <span class="n">class_name</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">,</span>
        <span class="n">fully_qualified_name</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>  <span class="c1"># Verifies it&#39;s a Pydantic model</span>

    <span class="c1"># Derive name</span>
    <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

    <span class="c1"># Create instance with basic fields</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
        <span class="n">class_path</span><span class="o">=</span><span class="n">fully_qualified_name</span><span class="p">,</span>  <span class="c1"># Use renamed field</span>
    <span class="p">)</span>

    <span class="c1"># Update mapped fields</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.save_as_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_as_pydantic</span><span class="p">()</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.save_as_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Save the Django model and return the corresponding Pydantic object.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pydantic2django.django.models.PydanticT">PydanticT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The corresponding Pydantic object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_as_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PydanticT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the Django model and return the corresponding Pydantic object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The corresponding Pydantic object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pydantic</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.to_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_pydantic</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.to_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert this Django model instance back to a Pydantic object.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelContext (pydantic2django.core.context.ModelContext)" href="#pydantic2django.core.context.ModelContext">ModelContext</a> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional ModelContext instance containing values for non-serializable fields.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pydantic2django.django.models.PydanticT">PydanticT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The corresponding Pydantic object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If context is required but not provided, or if class load/instantiation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">ModelContext</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PydanticT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert this Django model instance back to a Pydantic object.</span>

<span class="sd">    Args:</span>
<span class="sd">        context: Optional ModelContext instance containing values for non-serializable fields.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The corresponding Pydantic object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If context is required but not provided, or if class load/instantiation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pydantic_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>  <span class="c1"># Use common method</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">pydantic_class</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class path &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; does not point to a Pydantic BaseModel.&quot;</span><span class="p">)</span>

    <span class="c1"># Get data from Django fields corresponding to Pydantic fields</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_pydantic</span><span class="p">(</span><span class="n">pydantic_class</span><span class="p">)</span>

    <span class="c1"># Handle context if required and provided</span>
    <span class="n">required_context_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_required_context_fields</span><span class="p">()</span>  <span class="c1"># Check if context is needed</span>
    <span class="k">if</span> <span class="n">required_context_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conversion to Pydantic model &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; requires context &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;for fields: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">required_context_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">. Please provide a ModelContext instance.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Validate and merge context data</span>
        <span class="n">context_dict</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">to_conversion_dict</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">validate_context</span><span class="p">(</span><span class="n">context_dict</span><span class="p">)</span>  <span class="c1"># Validate required keys are present</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">context_dict</span><span class="p">)</span>  <span class="c1"># Merge context, potentially overwriting DB values if keys overlap</span>

    <span class="c1"># Reconstruct the Pydantic object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO: Add potential deserialization logic here if needed before validation</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">pydantic_class</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Cast to the generic type variable</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">PydanticT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span>  <span class="c1"># Re-raise TypeError as it&#39;s a specific, meaningful exception here</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Catch any other unexpected error during Pydantic object creation</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred creating Pydantic model for &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error creating Pydantic model for &#39;</span><span class="si">{</span><span class="n">pydantic_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.update_fields_from_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_fields_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.update_fields_from_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model's fields from a Pydantic object's fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pydantic_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.PydanticT">PydanticT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Pydantic object containing source values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model&#39;s fields from a Pydantic object&#39;s fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        pydantic_obj: The Pydantic object containing source values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="ow">or</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="p">):</span>
        <span class="c1"># Check type consistency before proceeding</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get data from the Pydantic object</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pydantic_data</span> <span class="o">=</span> <span class="n">pydantic_obj</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Failed to dump Pydantic model for update. Ensure you are using Pydantic v2+ with model_dump().&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="c1"># Get Django model fields excluding common/meta ones</span>
    <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># Update each Django field if it matches a field in the Pydantic data</span>
    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">pydantic_data</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">pydantic_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="c1"># Apply serialization (important for complex types)</span>
            <span class="n">serialized_value</span> <span class="o">=</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialized_value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Pydantic2DjangoBaseClass.update_from_pydantic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Pydantic2DjangoBaseClass.update_from_pydantic" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model with new data from a Pydantic object and save.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>pydantic_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.PydanticT">PydanticT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Pydantic object with updated data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_from_pydantic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pydantic_obj</span><span class="p">:</span> <span class="n">PydanticT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model with new data from a Pydantic object and save.</span>

<span class="sd">    Args:</span>
<span class="sd">        pydantic_obj: The Pydantic object with updated data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify the object type matches first (includes check if it&#39;s a BaseModel)</span>
    <span class="n">fully_qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>

    <span class="c1"># Update the class_path if somehow inconsistent</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fully_qualified_name</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fully_qualified_name</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_pydantic</span><span class="p">(</span><span class="n">pydantic_obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.django.models.Dataclass2DjangoBaseClass"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="Dataclass2DjangoBase (pydantic2django.django.models.Dataclass2DjangoBase)" href="../../reference/pydantic2django/django/models/#pydantic2django.django.models.Dataclass2DjangoBase">Dataclass2DjangoBase</a></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.django.models.DataclassT">DataclassT</span>]</code></p>


        <p>Base class for mapping Python Dataclass fields to Django model fields.</p>
<p>Inherits from Dataclass2DjangoBase and provides methods to convert
between the Dataclass instance and the Django model instance by matching field names.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Dataclass2DjangoBaseClass</span><span class="p">(</span><span class="n">Dataclass2DjangoBase</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">DataclassT</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for mapping Python Dataclass fields to Django model fields.</span>

<span class="sd">    Inherits from Dataclass2DjangoBase and provides methods to convert</span>
<span class="sd">    between the Dataclass instance and the Django model instance by matching field names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">Dataclass2DjangoBase</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">&quot;Mapped Dataclass&quot;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Mapped Dataclasses&quot;</span>

    <span class="c1"># __getattr__ is less likely needed/useful for standard dataclasses compared to Pydantic models</span>
    <span class="c1"># which might have complex methods. Skip for now.</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataclass2DjangoBaseClass[DataclassT]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Django model instance from a Dataclass object, mapping fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            dc_obj: The Dataclass object to convert.</span>
<span class="sd">            name: Optional name for the Django model instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new instance of this Django model subclass.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If the object is not a dataclass or not of the expected type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get class info and check type</span>
        <span class="p">(</span>
            <span class="n">dc_class</span><span class="p">,</span>
            <span class="n">class_name</span><span class="p">,</span>
            <span class="n">module_name</span><span class="p">,</span>
            <span class="n">fully_qualified_name</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>  <span class="c1"># Verifies it&#39;s a dataclass</span>

        <span class="c1"># Derive name</span>
        <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="c1"># Create instance with basic fields</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
            <span class="n">class_path</span><span class="o">=</span><span class="n">fully_qualified_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update mapped fields</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model&#39;s fields from a Dataclass object&#39;s fields.</span>

<span class="sd">        Args:</span>
<span class="sd">            dc_obj: The Dataclass object containing source values.</span>

<span class="sd">        Raises:</span>
<span class="sd">            TypeError: If conversion to dict fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="ow">or</span> <span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">):</span>
            <span class="c1"># Check type consistency before proceeding</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dc_data</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert dataclass &#39;</span><span class="si">{</span><span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; to dict for update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="c1"># Get Django model fields excluding common/meta ones</span>
        <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">dc_data</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">dc_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="c1"># Apply serialization (important for complex types like datetime, UUID, etc.)</span>
                <span class="n">serialized_value</span> <span class="o">=</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialized_value</span><span class="p">)</span>
            <span class="c1"># Else: Field exists on Django model but not on dataclass, leave it unchanged.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataclassT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this Django model instance back to a Dataclass object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The reconstructed Dataclass object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the class cannot be loaded or instantiation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataclass_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">dataclass_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class path &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; does not point to a dataclass.&quot;</span><span class="p">)</span>

        <span class="c1"># Get data from Django fields corresponding to dataclass fields</span>
        <span class="n">data_for_dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_dataclass</span><span class="p">(</span><span class="n">dataclass_type</span><span class="p">)</span>

        <span class="c1"># Instantiate the dataclass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Add deserialization logic if needed</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">dataclass_type</span><span class="p">(</span><span class="o">**</span><span class="n">data_for_dc</span><span class="p">)</span>
            <span class="c1"># Cast to the generic type variable for type hinting</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">DataclassT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to instantiate dataclass &#39;</span><span class="si">{</span><span class="n">dataclass_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; from Django model fields. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Ensure required fields exist and types are compatible. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during dataclass reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during dataclass reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_data_for_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataclass_type</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data from Django fields that correspond to the target dataclass fields.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dc_field_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">dataclass_type</span><span class="p">)}</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># Should not happen if is_dataclass check passed, but handle defensively</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get fields for non-dataclass type &#39;</span><span class="si">{</span><span class="n">dataclass_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># Add DB fields that are part of the dataclass</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dc_field_names</span><span class="p">:</span>
                <span class="c1"># TODO: Add potential deserialization based on target dataclass field type?</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Context handling is usually Pydantic-specific, skip for dataclasses unless needed</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model with new data from a Dataclass object and save.</span>

<span class="sd">        Args:</span>
<span class="sd">            dc_obj: The Dataclass object with updated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verify the object type matches first (includes check if it&#39;s a dataclass)</span>
        <span class="n">fully_qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>

        <span class="c1"># Update the class_path if somehow inconsistent</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fully_qualified_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fully_qualified_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataclassT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Django model and return the corresponding Dataclass object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The corresponding Dataclass object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataclass</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Dataclass2DjangoBaseClass.from_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.from_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a Django model instance from a Dataclass object, mapping fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dc_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.DataclassT">DataclassT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Dataclass object to convert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional name for the Django model instance.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="Dataclass2DjangoBaseClass (pydantic2django.django.models.Dataclass2DjangoBaseClass)" href="#pydantic2django.django.models.Dataclass2DjangoBaseClass">Dataclass2DjangoBaseClass</a>[<span title="pydantic2django.django.models.DataclassT">DataclassT</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new instance of this Django model subclass.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the object is not a dataclass or not of the expected type.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_dataclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Dataclass2DjangoBaseClass[DataclassT]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Django model instance from a Dataclass object, mapping fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        dc_obj: The Dataclass object to convert.</span>
<span class="sd">        name: Optional name for the Django model instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new instance of this Django model subclass.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the object is not a dataclass or not of the expected type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get class info and check type</span>
    <span class="p">(</span>
        <span class="n">dc_class</span><span class="p">,</span>
        <span class="n">class_name</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">,</span>
        <span class="n">fully_qualified_name</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>  <span class="c1"># Verifies it&#39;s a dataclass</span>

    <span class="c1"># Derive name</span>
    <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

    <span class="c1"># Create instance with basic fields</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
        <span class="n">class_path</span><span class="o">=</span><span class="n">fully_qualified_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Update mapped fields</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Dataclass2DjangoBaseClass.save_as_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_as_dataclass</span><span class="p">()</span></code>

<a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.save_as_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Save the Django model and return the corresponding Dataclass object.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pydantic2django.django.models.DataclassT">DataclassT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The corresponding Dataclass object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_as_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataclassT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the Django model and return the corresponding Dataclass object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The corresponding Dataclass object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dataclass</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Dataclass2DjangoBaseClass.to_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_dataclass</span><span class="p">()</span></code>

<a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.to_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert this Django model instance back to a Dataclass object.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pydantic2django.django.models.DataclassT">DataclassT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The reconstructed Dataclass object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the class cannot be loaded or instantiation fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataclassT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert this Django model instance back to a Dataclass object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The reconstructed Dataclass object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the class cannot be loaded or instantiation fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataclass_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">dataclass_type</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored class path &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2">&#39; does not point to a dataclass.&quot;</span><span class="p">)</span>

    <span class="c1"># Get data from Django fields corresponding to dataclass fields</span>
    <span class="n">data_for_dc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_dataclass</span><span class="p">(</span><span class="n">dataclass_type</span><span class="p">)</span>

    <span class="c1"># Instantiate the dataclass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># TODO: Add deserialization logic if needed</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">dataclass_type</span><span class="p">(</span><span class="o">**</span><span class="n">data_for_dc</span><span class="p">)</span>
        <span class="c1"># Cast to the generic type variable for type hinting</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">DataclassT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to instantiate dataclass &#39;</span><span class="si">{</span><span class="n">dataclass_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; from Django model fields. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Ensure required fields exist and types are compatible. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during dataclass reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during dataclass reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Dataclass2DjangoBaseClass.update_fields_from_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_fields_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.update_fields_from_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model's fields from a Dataclass object's fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dc_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.DataclassT">DataclassT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Dataclass object containing source values.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If conversion to dict fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model&#39;s fields from a Dataclass object&#39;s fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        dc_obj: The Dataclass object containing source values.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If conversion to dict fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="ow">or</span> <span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="p">):</span>
        <span class="c1"># Check type consistency before proceeding</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dc_data</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert dataclass &#39;</span><span class="si">{</span><span class="n">dc_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; to dict for update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Get Django model fields excluding common/meta ones</span>
    <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">dc_data</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dc_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="c1"># Apply serialization (important for complex types like datetime, UUID, etc.)</span>
            <span class="n">serialized_value</span> <span class="o">=</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialized_value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.Dataclass2DjangoBaseClass.update_from_dataclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.Dataclass2DjangoBaseClass.update_from_dataclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model with new data from a Dataclass object and save.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dc_obj</code>
            </td>
            <td>
                  <code><span title="pydantic2django.django.models.DataclassT">DataclassT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Dataclass object with updated data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_from_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dc_obj</span><span class="p">:</span> <span class="n">DataclassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model with new data from a Dataclass object and save.</span>

<span class="sd">    Args:</span>
<span class="sd">        dc_obj: The Dataclass object with updated data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verify the object type matches first (includes check if it&#39;s a dataclass)</span>
    <span class="n">fully_qualified_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>

    <span class="c1"># Update the class_path if somehow inconsistent</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fully_qualified_name</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fully_qualified_name</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_dataclass</span><span class="p">(</span><span class="n">dc_obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
<li>


<div class="doc doc-object doc-class">



<a id="pydantic2django.django.models.TypedClass2DjangoBaseClass"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="TypedClass2DjangoBase (pydantic2django.django.models.TypedClass2DjangoBase)" href="../../reference/pydantic2django/django/models/#pydantic2django.django.models.TypedClass2DjangoBase">TypedClass2DjangoBase</a></code>, <code><span title="typing.Generic">Generic</span>[<span title="pydantic2django.django.models.TypedClassT">TypedClassT</span>]</code></p>


        <p>Base class for mapping generic Python class fields to Django model fields.</p>







              <details class="quote">
                <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TypedClass2DjangoBaseClass</span><span class="p">(</span><span class="n">TypedClass2DjangoBase</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">TypedClassT</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for mapping generic Python class fields to Django model fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">TypedClass2DjangoBase</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="s2">&quot;Mapped Typed Class&quot;</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;Mapped Typed Classes&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_typedclass</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TypedClass2DjangoBaseClass[TypedClassT]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Django model instance from a generic class object, mapping fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj_class</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">fqn</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
            <span class="n">class_path</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model&#39;s fields from a generic class object&#39;s fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">typed_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="ow">or</span> <span class="n">typed_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract data. For mapped fields, we prefer __init__ params or direct attrs.</span>
        <span class="c1"># Using __dict__ might be too broad here if not all dict items are mapped fields.</span>
        <span class="c1"># Let&#39;s assume attributes corresponding to Django fields are directly accessible.</span>

        <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="c1"># Else: Field on Django model, not on typed_obj. Leave as is or handle.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypedClassT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this Django model instance back to a generic class object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>
        <span class="n">data_for_typedclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_typedclass</span><span class="p">(</span><span class="n">target_class</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This assumes target_class can be instantiated with these parameters.</span>
            <span class="c1"># Deserialization from serialize_value needs to be considered for complex types.</span>
            <span class="c1"># TODO: Implement robust deserialization</span>
            <span class="n">deserialized_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_for_typedclass</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>  <span class="c1"># Placeholder</span>

            <span class="n">init_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">target_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="n">valid_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deserialized_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">init_sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>

            <span class="n">instance</span> <span class="o">=</span> <span class="n">target_class</span><span class="p">(</span><span class="o">**</span><span class="n">valid_params</span><span class="p">)</span>

            <span class="c1"># For attributes not in __init__ but set on Django model, try to setattr</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">deserialized_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_params</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># value is already deserialized_data[key]</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Could not setattr </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> during to_typedclass reconstruction.&quot;</span>
                        <span class="p">)</span>

            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TypedClassT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to instantiate typed class &#39;</span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; from Django fields. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during typed class reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during typed class reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_data_for_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data from Django fields that correspond to the target class&#39;s likely attributes.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Heuristic: get attributes from __init__ signature and class annotations</span>
        <span class="c1"># This is a simplified version. A robust solution might need to align with TypedClassFieldFactory&#39;s discovery.</span>

        <span class="c1"># Potential attributes: from __init__</span>
        <span class="n">potential_attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">init_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">target_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
            <span class="n">potential_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">init_sig</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c1"># Potential attributes: from class annotations (less reliable for instance data if not in __init__)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     annotations = inspect.get_annotations(target_class)</span>
        <span class="c1">#     potential_attrs.update(annotations.keys())</span>
        <span class="c1"># except Exception:</span>
        <span class="c1">#     pass</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">potential_attrs</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">target_class</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>  <span class="c1"># Check if it&#39;s a likely attribute</span>
                <span class="c1"># TODO: Add deserialization logic based on target_class&#39;s type hint for field.name</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update this Django model with new data from a generic class object and save.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fqn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fqn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypedClassT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Django model and return the corresponding generic class object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_typedclass</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.TypedClass2DjangoBaseClass.from_typedclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.from_typedclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create a Django model instance from a generic class object, mapping fields.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_typedclass</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TypedClass2DjangoBaseClass[TypedClassT]&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a Django model instance from a generic class object, mapping fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obj_class</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">fqn</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_class_info</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="n">_check_expected_type</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
    <span class="n">derived_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_derive_name</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">derived_name</span><span class="p">,</span>
        <span class="n">class_path</span><span class="o">=</span><span class="n">fqn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">update_fields_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.TypedClass2DjangoBaseClass.save_as_typedclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_as_typedclass</span><span class="p">()</span></code>

<a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.save_as_typedclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Save the Django model and return the corresponding generic class object.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">save_as_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypedClassT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the Django model and return the corresponding generic class object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_typedclass</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.TypedClass2DjangoBaseClass.to_typedclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_typedclass</span><span class="p">()</span></code>

<a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.to_typedclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert this Django model instance back to a generic class object.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">to_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypedClassT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert this Django model instance back to a generic class object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span>
    <span class="n">data_for_typedclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_for_typedclass</span><span class="p">(</span><span class="n">target_class</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># This assumes target_class can be instantiated with these parameters.</span>
        <span class="c1"># Deserialization from serialize_value needs to be considered for complex types.</span>
        <span class="c1"># TODO: Implement robust deserialization</span>
        <span class="n">deserialized_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_for_typedclass</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>  <span class="c1"># Placeholder</span>

        <span class="n">init_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">target_class</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="n">valid_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deserialized_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">init_sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="n">target_class</span><span class="p">(</span><span class="o">**</span><span class="n">valid_params</span><span class="p">)</span>

        <span class="c1"># For attributes not in __init__ but set on Django model, try to setattr</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">deserialized_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_params</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># value is already deserialized_data[key]</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not setattr </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> during to_typedclass reconstruction.&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">TypedClassT</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to instantiate typed class &#39;</span><span class="si">{</span><span class="n">target_class</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; from Django fields. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during typed class reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during typed class reconstruction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.TypedClass2DjangoBaseClass.update_fields_from_typedclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_fields_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.update_fields_from_typedclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model's fields from a generic class object's fields.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_fields_from_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model&#39;s fields from a generic class object&#39;s fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">typed_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__module__</span>
        <span class="ow">or</span> <span class="n">typed_obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Provided object type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not match expected type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_path</span><span class="si">}</span><span class="s2"> for update.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Extract data. For mapped fields, we prefer __init__ params or direct attrs.</span>
    <span class="c1"># Using __dict__ might be too broad here if not all dict items are mapped fields.</span>
    <span class="c1"># Let&#39;s assume attributes corresponding to Django fields are directly accessible.</span>

    <span class="n">model_field_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">field</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;class_path&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_field_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="pydantic2django.django.models.TypedClass2DjangoBaseClass.update_from_typedclass" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span></code>

<a href="#pydantic2django.django.models.TypedClass2DjangoBaseClass.update_from_typedclass" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Update this Django model with new data from a generic class object and save.</p>


            <details class="quote">
              <summary>Source code in <code>src/pydantic2django/django/models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_from_typedclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typed_obj</span><span class="p">:</span> <span class="n">TypedClassT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update this Django model with new data from a generic class object and save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fqn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_object_type_match</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">!=</span> <span class="n">fqn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_path</span> <span class="o">=</span> <span class="n">fqn</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">update_fields_from_typedclass</span><span class="p">(</span><span class="n">typed_obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></li>
</ul>
<p>Additional docs:</p>
<ul>
<li>Context handling: <code>docs/Architecture/CONTEXT_HANDLING.md</code></li>
<li>Pydantic ↔ Django methods: <code>docs/Architecture/README_PYDANTIC_DJANGO_METHODS.md</code></li>
<li>Django storage options: <code>docs/Architecture/README_DJANGO_STORAGE_OPTIONS.md</code></li>
</ul>
<h3 id="extending-the-system">Extending the system<a class="headerlink" href="#extending-the-system" title="Permanent link">&para;</a></h3>
<ul>
<li>To support a new source type, implement:</li>
<li>A <code>Discovery</code> subclass of <code>BaseDiscovery</code>.</li>
<li>A <code>FieldFactory</code> and <code>ModelFactory</code> pair using <code>BidirectionalTypeMapper</code>.</li>
<li>A <code>Generator</code> subclass of <code>BaseStaticGenerator</code> that wires everything together and prepares template context.</li>
<li>To add or refine type mappings, provide new <code>TypeMappingUnit</code> subclasses and ensure <code>BidirectionalTypeMapper</code> registry order or match scores select them appropriately.</li>
</ul>
<h3 id="mkdocstrings-usage">mkdocstrings usage<a class="headerlink" href="#mkdocstrings-usage" title="Permanent link">&para;</a></h3>
<p>Each <code>:::</code> block above renders live API documentation using mkdocstrings with the Python handler, configured in <code>mkdocs.yml</code> with <code>handlers.python.paths: [src]</code>. See the official guide: <a href="https://mkdocstrings.github.io/python/usage/">mkdocstrings usage</a>.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.sections", "navigation.instant", "navigation.tracking", "navigation.expand", "navigation.path", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tabs.link", "toc.integrate", "toc.follow", "search.share"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>